<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>绘本世界 - 创作与阅读平台</title>
    <meta name="version" content="v1.2.0">
    <meta name="release-date" content="2025-10-27">
    <meta name="description" content="功能强大的Web绘本生成和阅读平台，支持在线生成交互式绘本和预置绘本阅读">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- JSZip for ZIP file creation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        /* 引入本地字体 */
        @font-face {
            font-family: 'AaErZhiYuan';
            src: url('./AaErZhiYuan-2.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        /* 全局样式重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        /* =============== 主应用布局 =============== */
        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            color: white;
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: rgba(255,255,255,0.9);
            color: #667eea;
        }

        .main {
            flex: 1;
            position: relative;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* =============== 绘本库样式 =============== */
        .library-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .library-header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .library-header h2 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .search-box {
            max-width: 400px;
            margin: 20px auto;
            position: relative;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px;
            border: none;
            border-radius: 25px;
            background: rgba(255,255,255,0.9);
            font-size: 16px;
            outline: none;
        }

        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .book-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .book-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .book-cover {
            position: relative;
            height: 200px;
            background: linear-gradient(45deg, #f0f2f5, #e1e8ed);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .book-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* 图片渲染优化 */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            image-rendering: high-quality;
            image-rendering: auto;
            /* 抗锯齿优化 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* 确保图片不被压缩 */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            /* 强制硬件加速 */
            will-change: transform;
        }

        .book-cover .placeholder {
            color: #999;
            font-size: 48px;
        }

        .book-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .book-card:hover .book-overlay {
            opacity: 1;
        }

        .overlay-btn {
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            color: #333;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .overlay-btn:hover {
            background: white;
            transform: scale(1.05);
        }

        .book-info {
            padding: 20px;
        }

        .book-info h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #333;
        }

        .book-meta {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .book-tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .tag {
            background: #e1e8ed;
            color: #667eea;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: rgba(255,255,255,0.8);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 16px;
            margin-bottom: 30px;
        }

        .create-first-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .create-first-btn:hover {
            transform: translateY(-2px);
        }

        /* =============== 绘本创建器样式 =============== */
        .creator-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .creator-header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .creator-header h2 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .creation-method-selector {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }

        .method-btn {
            padding: 12px 24px;
            border: 2px solid #4A90E2;
            background: transparent;
            color: #4A90E2;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .method-btn:hover {
            background: #4A90E2;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
        }

        .method-btn.active {
            background: #4A90E2;
            color: white;
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
        }

        .import-section {
            display: none;
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .import-section.active {
            display: block;
        }

        .file-drop-zone {
            border: 3px dashed #4A90E2;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-drop-zone:hover {
            border-color: #357ABD;
            background: #f0f4ff;
        }

        .file-drop-zone.dragover {
            border-color: #357ABD;
            background: #e8f2ff;
            transform: scale(1.02);
        }

        .upload-section {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .upload-box {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            background: #f9f9f9;
            position: relative;
        }

        .upload-box:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .upload-box.active {
            border-color: #667eea;
            background: #e8f2ff;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: transform 0.2s ease;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
        }

        .page-setup {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .input-group input, .input-group textarea, .input-group select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .page-list {
            margin-top: 20px;
        }

        .page-item {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-info {
            flex: 1;
        }

        .page-actions button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .generate-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: transform 0.2s ease;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
        }

        .generate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .file-list {
            margin-top: 10px;
            font-size: 14px;
        }

        .file-item {
            background: #e9ecef;
            padding: 5px 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .remove-file {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 12px;
        }

        /* =============== 角色音频配置样式 =============== */
        .character-audio-section {
            margin: 20px 0;
        }

        .character-config-list {
            margin-bottom: 15px;
        }

        .character-config-item {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .character-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .character-config-title {
            font-weight: bold;
            color: #495057;
        }

        .character-config-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .character-name-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            min-width: 120px;
        }

        .character-audio-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            min-width: 150px;
        }

        .remove-character-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-character-btn:hover {
            background: #c82333;
        }

        .drag-handle {
            cursor: move;
            color: #6c757d;
            font-size: 16px;
            user-select: none;
        }

        /* =============== 自动匹配样式 =============== */
        .auto-match-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            border: 2px dashed #28a745;
        }

        .auto-match-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .auto-match-info {
            font-size: 14px;
            line-height: 1.5;
        }

        .match-preview {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .match-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .match-item.incomplete {
            border-left-color: #ffc107;
        }

        .match-item.missing {
            border-left-color: #dc3545;
        }

        .match-number {
            font-weight: bold;
            min-width: 60px;
            color: #495057;
        }

        .match-files {
            flex: 1;
            display: flex;
            gap: 20px;
        }

        .match-file {
            flex: 1;
            padding: 8px;
            background: white;
            border-radius: 5px;
            font-size: 13px;
        }

        .match-file.empty {
            background: #e9ecef;
            color: #6c757d;
            font-style: italic;
        }

        .preview-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .preview-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-confirm {
            background: #28a745;
            color: white;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        /* =============== 预置绘本样式 =============== */




        .book-description {
            font-size: 14px;
            color: #666;
            margin: 8px 0;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* =============== 3D翻页阅读器样式 =============== */
        .book-reader {
            display: none;
            background: linear-gradient(135deg, #8b4513, #a0522d);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            padding: 20px;
        }

        .reader-container {
            max-width: 1400px;
            width: 100%;
            position: relative;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* 3D翻页系统样式 */
        .controls {
            background: rgba(139, 69, 19, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .control-group label {
            font-size: 14px;
            font-weight: 500;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* 绘本标题样式 */
        .book-title {
            font-family: 'AaErZhiYuan', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            letter-spacing: 0.5px;
        }

        .slider {
            width: 120px;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .book-container {
            height: 600px;
            position: relative;
            perspective: 2000px;
            background: var(--bg-color, #faf7f0);
            border-radius: 0 0 15px 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            aspect-ratio: 2.33 / 1;
        }

        .book {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            display: flex;
        }

        .book-spread {
            width: 100%;
            height: 100%;
            display: flex;
            position: absolute;
        }

        .book-container.has-spread-image .book-spread {
            gap: 0;
            transform: translateZ(0);
            backface-visibility: hidden;
            will-change: auto;
        }

        .page-left,
        .page-right {
            width: calc(50% - 20px);
            height: 100%;
            background: var(--bg-color, #faf7f0);
            padding: 50px 40px 80px 40px;
            position: relative;
            box-shadow: inset 0 0 20px rgba(139, 69, 19, 0.1);
        }

        .page-left.spread-page,
        .page-right.spread-page {
            padding: 0;
            width: 50%;
            transform: translateZ(0);
            border-radius: 0;
            box-shadow: none;
            background: transparent;
            backface-visibility: hidden;
            will-change: auto;
            position: relative;
        }

        .page-left.spread-page {
            margin-right: 0;
            margin-left: 0;
        }

        .page-right.spread-page {
            margin-left: 0;
            margin-right: 0;
        }

        .page-left {
            margin-right: 20px;
            border-radius: 15px 0 0 15px;
            background: linear-gradient(
                45deg,
                rgba(139, 69, 19, 0.02) 0%,
                rgba(139, 69, 19, 0.01) 100%
            ),
            linear-gradient(
                to right,
                var(--bg-color, #faf7f0) 0%,
                rgba(139, 69, 19, 0.01) 95%,
                rgba(139, 69, 19, 0.05) 100%
            ),
            var(--bg-color, #faf7f0);
            box-shadow: inset -8px 0 20px -10px rgba(139, 69, 19, 0.1),
                inset -2px 0 5px -2px rgba(139, 69, 19, 0.05);
            transform-origin: right center;
        }

        .page-right {
            margin-left: 20px;
            border-radius: 0 15px 15px 0;
            background: linear-gradient(
                45deg,
                rgba(139, 69, 19, 0.02) 0%,
                rgba(139, 69, 19, 0.01) 100%
            ),
            linear-gradient(
                to left,
                var(--bg-color, #faf7f0) 0%,
                rgba(139, 69, 19, 0.01) 95%,
                rgba(139, 69, 19, 0.05) 100%
            ),
            var(--bg-color, #faf7f0);
            box-shadow: inset 8px 0 20px -10px rgba(139, 69, 19, 0.1),
                inset 2px 0 5px -2px rgba(139, 69, 19, 0.05);
            transform-origin: left center;
        }

        .page-content {
            width: 100%;
            height: 100%;
            line-height: 1.7;
            color: var(--text-color, #2c2c2c);
            font-size: var(--font-size, 16px);
            text-align: justify;
            text-justify: inter-word;
            word-wrap: break-word;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .page-content.spread-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 0;
            margin: 0;
        }

        /* 绘本图片样式 */
        .page-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            filter: brightness(var(--image-brightness, 1));
            transition: filter 0.3s ease;
            /* 图片渲染优化 - 针对低分辨率图片优化 */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            image-rendering: high-quality;
            image-rendering: auto;
            /* 针对低分辨率图片的额外优化 */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            /* 尝试改善低分辨率图片显示 */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            /* 抗锯齿优化 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* 确保图片不被压缩 */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            /* 强制硬件加速 */
            will-change: transform;
        }

        /* 跨页图片样式 */
        .spread-image-left {
            position: absolute;
            width: 200%;
            height: 100%;
            object-fit: cover;
            object-position: center center;
            left: 0;
            top: 0;
            border-radius: 0;
            z-index: 1;
            clip-path: inset(0 50% 0 0);
            transform: translateZ(0);
            filter: brightness(var(--image-brightness, 1));
            transition: filter 0.3s ease;
            backface-visibility: hidden;
            will-change: transform;
            /* 图片渲染优化 */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            image-rendering: high-quality;
            image-rendering: auto;
            /* 抗锯齿优化 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .spread-image-right {
            position: absolute;
            width: 200%;
            height: 100%;
            object-fit: cover;
            object-position: center center;
            left: -100%;
            top: 0;
            border-radius: 0;
            z-index: 1;
            clip-path: inset(0 0 0 50%);
            transform: translateZ(0);
            filter: brightness(var(--image-brightness, 1));
            transition: filter 0.3s ease;
            backface-visibility: hidden;
            will-change: transform;
            /* 图片渲染优化 */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            image-rendering: high-quality;
            image-rendering: auto;
            /* 抗锯齿优化 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* 页面文字显示 - 已移除字幕功能 */

        .binding-gutter {
            position: absolute;
            left: 50%;
            top: 0;
            width: 40px;
            height: 100%;
            transform: translateX(-50%);
            z-index: 20;
            background: linear-gradient(
                to right,
                rgba(139, 69, 19, 0.1) 0%,
                rgba(139, 69, 19, 0.3) 50%,
                rgba(139, 69, 19, 0.1) 100%
            );
        }

        .book-container.has-spread-image .binding-gutter {
            display: none;
        }

        .flipping-page {
            position: absolute;
            top: 0;
            width: calc(50% - 20px);
            height: 100%;
            background: var(--bg-color, #faf7f0);
            transform-style: preserve-3d;
            transition: transform 1.0s ease-in-out;
            z-index: 10;
            transform: rotateY(0deg);
        }

        .flipping-page.next-flip {
            right: 20px;
            transform-origin: left center;
            margin-left: 10px;
        }

        .flipping-page.prev-flip {
            left: 0;
            transform-origin: right center;
            margin-right: 10px;
        }

        /* 跨页图片翻页元素尺寸和位置 */
        .flipping-page.has-spread-image {
            width: 50%;
            margin: 0;
        }

        .flipping-page.has-spread-image.next-flip {
            right: 0;
            margin-left: 0;
        }

        .flipping-page.has-spread-image.prev-flip {
            left: 0;
            margin-right: 0;
        }

        .flipping-page.flipping.next-flip {
            transform: rotateY(-180deg);
        }

        .flipping-page.flipping.prev-flip {
            transform: rotateY(180deg);
        }

        .flipping-page .page-front,
        .flipping-page .page-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            padding: 50px 40px 80px 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .flipping-page .page-front.spread-content,
        .flipping-page .page-back.spread-content {
            padding: 0;
        }

        .flipping-page .page-front {
            z-index: 2;
            background: linear-gradient(
                45deg,
                rgba(139, 69, 19, 0.02) 0%,
                rgba(139, 69, 19, 0.01) 100%
            ),
            linear-gradient(
                to left,
                var(--bg-color, #faf7f0) 0%,
                rgba(139, 69, 19, 0.01) 95%,
                rgba(139, 69, 19, 0.05) 100%
            ),
            var(--bg-color, #faf7f0);
        }

        .flipping-page .page-back {
            transform: rotateY(180deg);
            background: linear-gradient(
                45deg,
                rgba(139, 69, 19, 0.02) 0%,
                rgba(139, 69, 19, 0.01) 100%
            ),
            linear-gradient(
                to right,
                var(--bg-color, #faf7f0) 0%,
                rgba(139, 69, 19, 0.01) 95%,
                rgba(139, 69, 19, 0.05) 100%
            ),
            var(--bg-color, #faf7f0);
        }

        .click-areas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 15;
            display: flex;
        }

        .click-area {
            height: 100%;
            width: 50%;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .click-area:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        /* 外部页码指示器样式 */
        .external-page-indicator {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            padding: 0 20px;
        }

        .page-numbers {
            background: rgba(139, 69, 19, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .reader-controls {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .control-btn {
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: white;
            transform: scale(1.1);
        }

        /* 底部控制区域的导航按钮 */
        .reader-nav-btn {
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reader-nav-btn:hover {
            background: rgba(255,255,255,1);
            transform: scale(1.1);
        }

        /* 右上角按钮容器 */
        .top-right-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
            z-index: 1100;
        }

        .close-btn {
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .close-btn:hover {
            background: rgba(255,255,255,1);
            transform: scale(1.1);
        }

        .fullscreen-btn {
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .fullscreen-btn:hover {
            background: rgba(255,255,255,1);
            transform: scale(1.1);
        }

        .auto-play-toggle {
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .auto-play-toggle.active {
            background: #28a745;
            color: white;
        }

        /* =============== 响应式设计 =============== */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .nav {
                flex-wrap: wrap;
                justify-content: center;
            }

            .books-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 20px;
            }

            .book-container {
                height: 450px;
            }

            .controls {
                flex-direction: column;
                gap: 10px;
            }

            .book-title {
                font-size: 16px;
            }

            .reader-nav-btn {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }

            .top-right-controls {
                top: 10px;
                right: 10px;
                gap: 8px;
            }

            .close-btn, .fullscreen-btn {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }
        }

        /* =============== 加载和反馈样式 =============== */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 9999;
        }

        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 9999;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 9999;
            animation: slideInRight 0.3s ease;
        }

        /* 页面选项容器样式 */
        .page-options-container {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 20px;
            color: #333;
    z-index: 9999;
            min-width: 400px;
            max-width: 90%;
            max-height: 80vh;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: fadeIn 0.3s ease;
            text-align: center;
            overflow-y: auto;
}

.options-title {
    font-size: 24px;
    margin-bottom: 20px;
    text-align: center;
    font-weight: bold;
}

.options-buttons {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.option-button {
    padding: 15px 20px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 18px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.option-button:hover {
    background: #218838;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
}

        .options-title {
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }

        .options-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option-button {
            padding: 10px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .option-button:hover {
            background: #218838;
        }

        /* 编辑选项弹窗样式 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }

        .modal-header h3 {
            margin: 0;
        }

        .modal-header button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 15px;
        }

        .modal-footer {
            padding: 15px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .option-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .option-content {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .optionText {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .targetPage {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .delete-option-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        /* =============== LORA标注工具样式 =============== */
        .lora-tool-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .lora-tool-section h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .lora-input-group {
            margin-bottom: 15px;
        }

        .lora-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        .lora-input-group input[type="text"],
        .lora-input-group input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .lora-input-group input:focus {
            outline: none;
            border-color: #f5576c;
        }

        .lora-radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .lora-radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .lora-radio-option:hover {
            border-color: #f5576c;
            background: #fff5f7;
        }

        .lora-radio-option input[type="radio"] {
            margin: 0;
            cursor: pointer;
        }

        .lora-checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
        }

        .lora-checkbox-group input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }

        .lora-preview-box {
            max-height: 400px;
            overflow-y: auto;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            scroll-behavior: smooth;
        }

        .lora-preview-box::-webkit-scrollbar {
            width: 8px;
        }

        .lora-preview-box::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .lora-preview-box::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .lora-preview-box::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .lora-preview-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 14px;
            color: #333;
        }

        .lora-preview-item i {
            color: #28a745;
        }

        .lora-file-upload {
            display: block;
            width: 100%;
            padding: 15px;
            background: white;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .lora-file-upload:hover {
            border-color: #f5576c;
            background: #fff5f7;
        }

        .lora-file-upload input[type="file"] {
            display: none;
        }

        .lora-file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #e7f5e9;
            border: 1px solid #28a745;
            border-radius: 6px;
            margin-top: 10px;
        }

        .lora-file-info i {
            color: #28a745;
            font-size: 20px;
        }

        .lora-stats {
            display: flex;
            gap: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            color: white;
            margin-bottom: 15px;
        }

        .lora-stat-item {
            flex: 1;
            text-align: center;
        }

        .lora-stat-number {
            font-size: 32px;
            font-weight: bold;
            display: block;
        }

        .lora-stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .lora-btn-primary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: transform 0.3s;
        }

        .lora-btn-primary:hover {
            transform: translateY(-2px);
        }

        .lora-btn-secondary {
            background: #6c757d;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: transform 0.3s;
        }

        .lora-btn-secondary:hover {
            transform: translateY(-2px);
            background: #5a6268;
        }

        #addOptionBtn {
            width: 100%;
            padding: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        #addOptionBtn:hover {
            background: #0056b3;
        }

        .page-actions {
            display: flex;
            gap: 10px;
        }

        .page-actions button {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .page-actions button:first-child {
            background: #007bff;
            color: white;
        }

        .page-actions button:first-child:hover {
            background: #0056b3;
        }

        .page-actions button:last-child {
            background: #dc3545;
            color: white;
        }

        .page-actions button:last-child:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="header-content">
                <h1 class="logo">
                    <i class="fas fa-book-open"></i>
                    绘本世界
                </h1>
                <nav class="nav">
                    <button class="nav-btn active" data-tab="library">
                        <i class="fas fa-home"></i>
                        绘本库
                    </button>
                    <button class="nav-btn" data-tab="create">
                        <i class="fas fa-plus"></i>
                        创建绘本
                    </button>
                    <button class="nav-btn" data-tab="import">
                        <i class="fas fa-file-import"></i>
                        导入绘本
                    </button>
                    <button class="nav-btn" onclick="openLoraAnnotationTool()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="fas fa-tags"></i>
                        LORA标注工具
                    </button>
                </nav>
            </div>
        </header>

        <main class="main">
            <!-- 绘本库页面 -->
            <div class="tab-content active" id="library">
                <div class="library-container">
                <div class="library-header">
                    <h2>我的绘本收藏</h2>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="搜索绘本..." id="searchInput">
                    </div>
                    <div class="storage-info" id="storageInfo" style="margin-top: 10px; font-size: 14px; color: rgba(255,255,255,0.8);"></div>
                </div>
                <div class="books-grid" id="booksGrid">
                    <!-- 绘本卡片将动态插入这里 -->
                        <div class="empty-state" id="emptyState">
                            <i class="fas fa-book-open"></i>
                            <h3>当前会话中还没有绘本</h3>
                            <p>创建您的第一本绘本吧！<br><small>注意：刷新页面后绘本将消失</small></p>
                            <button class="create-first-btn" onclick="switchToCreateTab()">
                                <i class="fas fa-plus"></i>
                                创建绘本
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 创建绘本页面 -->
            <div class="tab-content" id="create">
                <div class="creator-container">
                    <div class="creator-header">
                        <h2>📚 创建新绘本</h2>
                        <p>上传图片和音频，创造属于您的互动绘本故事</p>
                        
                        </div>
                        
                    <div class="upload-section">
                        <h3>📁 文件上传</h3>
                        
                        <div class="upload-grid">
                            <div class="upload-box" id="narratorUpload">
                                <h4>📢 旁白音频</h4>
                                <p>上传故事旁白音频文件（MP3, WAV等）</p>
                                <p><small>支持一次选择多个文件</small></p>
                                <input type="file" class="file-input" id="narratorFiles" multiple accept="audio/*">
                                <button class="upload-btn" onclick="document.getElementById('narratorFiles').click()">选择旁白音频</button>
                                <div class="file-list" id="narratorList"></div>
                            </div>
                            
                            <div class="upload-box" id="characterUpload">
                                <h4>🎭 角色音频</h4>
                                <p>上传角色对话音频文件（可选）</p>
                                <p><small>支持一次选择多个文件</small></p>
                                <input type="file" class="file-input" id="characterFiles" multiple accept="audio/*">
                                <button class="upload-btn" onclick="document.getElementById('characterFiles').click()">选择角色音频</button>
                                <div class="file-list" id="characterList"></div>
                        </div>

                            <div class="upload-box" id="imageUpload">
                                <h4>🖼️ 背景图片</h4>
                                <p>上传绘本背景图片（JPG, PNG等）</p>
                                <p><small>支持一次选择多个文件</small></p>
                                <input type="file" class="file-input" id="imageFiles" multiple accept="image/*">
                                <button class="upload-btn" onclick="document.getElementById('imageFiles').click()">选择多个图片文件</button>
                                <div class="file-list" id="imageList"></div>
                                </div>
                        </div>

                        <h3>⚙️ 图片优化设置</h3>
                        <div class="page-setup">
                            <div class="input-group">
                                <label for="imageQuality">图片质量 (0.1-1.0):</label>
                                <input type="range" id="imageQuality" min="0.1" max="1.0" step="0.1" value="1.0">
                                <span id="qualityDisplay">1.0</span>
                                <small>较低质量可提升加载性能</small>
                            </div>
                            <div class="input-group">
                                <label for="maxImageWidth">图片最大宽度:</label>
                                <select id="maxImageWidth">
                                    <option value="600">600px (极小，最省空间)</option>
                                    <option value="800">800px (较小，节省空间)</option>
                                    <option value="1200">1200px (推荐)</option>
                                    <option value="1600">1600px (高质量)</option>
                                    <option value="2000" selected>2000px (原画质)</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>
                                    <input type="checkbox" id="lowStorageMode"> 
                                    性能优化模式 (自动使用最小设置)
                                </label>
                                <small>开启后将使用 600px + 0.6 质量进行优化</small>
                            </div>
                        </div>

                        <h3>📖 页面设置</h3>
                        <div class="page-setup">
                            <div class="input-group">
                                <label for="pageImage">选择背景图片:</label>
                                <select id="pageImage">
                                    <option value="">请先上传图片</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="pageNarrator">选择旁白音频:</label>
                                <select id="pageNarrator">
                                    <option value="">请先上传旁白音频</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="pageText">页面文字（可选）:</label>
                                <textarea id="pageText" rows="3" placeholder="输入这一页要显示的文字（可留空）"></textarea>
                            </div>
                            <div class="input-group">
                                <label for="pageType">页面类型:</label>
                                <select id="pageType" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                    <option value="public">公共页 - 按顺序播放</option>
                                    <option value="interactive">互动选项页 - 基于选项播放</option>
                                </select>
                                <small style="display: block; margin-top: 5px; color: #666;">
                                    公共页：按页面顺序自动播放 | 互动选项页：需要用户选择选项后跳转播放
                                </small>
                            </div>
                        </div>

                        <h3>🎭 角色音频配置</h3>
                        <div class="character-audio-section">
                            <div class="character-config-list" id="characterConfigList">
                                <!-- 角色配置项将动态插入这里 -->
                            </div>
                            <button class="upload-btn" onclick="addCharacterConfig()" style="background: #17a2b8;">
                                <i class="fas fa-plus"></i> 添加角色对话
                            </button>
                        </div>

                        <h3>🤖 智能匹配</h3>
                        <div class="auto-match-section">
                            <div class="auto-match-info" id="autoMatchInfo" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;">
                                <!-- 匹配信息将显示在这里 -->
                            </div>
                            <div class="auto-match-controls">
                                <button class="upload-btn" onclick="showAutoMatchPreview()" style="background: #28a745;">
                                    <i class="fas fa-magic"></i> 分析文件匹配
                                </button>
                            </div>
                        </div>

                        <h3>📖 手动添加页面</h3>
                        <div class="page-setup">
                            <div class="input-group">
                                <button class="upload-btn" onclick="addPage()">添加单个页面</button>
                            </div>
                        </div>

                        <div class="page-list" id="pageList">
                            <h3>📋 页面列表</h3>
                            <p id="emptyMessage">还没有添加任何页面</p>
                            <div id="batchActions" style="display: none; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <h4>🔧 批量操作</h4>
                                <button class="upload-btn" onclick="optimizeAllPages()" style="background: #17a2b8;">
                                    <i class="fas fa-compress"></i> 重新压缩所有页面
                                </button>
                                <small style="display: block; margin-top: 5px; color: #666;">
                                    使用当前压缩设置重新压缩所有页面，可能会节省存储空间
                                </small>
                            </div>
                        </div>


                        <!-- 绘本基本信息输入 -->
                        <div class="book-info-input" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;">
                            <label for="bookTitle" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                                📖 绘本名称
                            </label>
                            <input 
                                type="text" 
                                id="bookTitle" 
                                placeholder="请输入绘本名称（默认：绘本作品）" 
                                value="绘本作品"
                                style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; transition: border-color 0.3s ease; margin-bottom: 15px;"
                                maxlength="50"
                                onfocus="this.style.borderColor='#4A90E2'; this.style.boxShadow='0 0 5px rgba(74, 144, 226, 0.3)';"
                                onblur="this.style.borderColor='#ccc'; this.style.boxShadow='none';"
                                oninput="validateBookTitle()"
                            />
                            <small style="display: block; margin-bottom: 15px; color: #666;">
                                为你的绘本起一个好听的名字吧！<span id="charCount" style="float: right; color: #999;">0/50</span>
                            </small>
                            
                            <label for="bookAuthor" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                                ✍️ 作者
                            </label>
                            <input 
                                type="text" 
                                id="bookAuthor" 
                                placeholder="请输入作者名称（默认：绘本智能体）" 
                                value="绘本智能体"
                                style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; transition: border-color 0.3s ease; margin-bottom: 15px;"
                                maxlength="30"
                                onfocus="this.style.borderColor='#4A90E2'; this.style.boxShadow='0 0 5px rgba(74, 144, 226, 0.3)';"
                                onblur="this.style.borderColor='#ccc'; this.style.boxShadow='none';"
                            />
                            <small style="display: block; margin-bottom: 15px; color: #666;">
                                绘本的创作者名称
                            </small>
                            
                            <label for="bookDescription" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                                📝 绘本简介
                            </label>
                            <textarea 
                                id="bookDescription" 
                                placeholder="请输入绘本简介（默认：包含 X 页的精美绘本）" 
                                style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; transition: border-color 0.3s ease; resize: vertical; min-height: 80px;"
                                maxlength="200"
                                onfocus="this.style.borderColor='#4A90E2'; this.style.boxShadow='0 0 5px rgba(74, 144, 226, 0.3)';"
                                onblur="this.style.borderColor='#ccc'; this.style.boxShadow='none';"
                                oninput="updateDescriptionPlaceholder()"
                            ></textarea>
                            <small style="display: block; margin-top: 5px; color: #666;">
                                简单描述一下你的绘本内容吧！<span id="descCharCount" style="float: right; color: #999;">0/200</span>
                            </small>
                        </div>

                        <button class="generate-btn" onclick="generateBook()" id="generateBtn" disabled>🚀 生成绘本</button>
                    </div>
                </div>
            </div>

            <!-- 导入绘本页面 -->
            <div class="tab-content" id="import">
                <div class="creator-container">
                    <div class="creator-header">
                        <h2>📁 导入绘本</h2>
                        <p>从本地文件导入绘本数据，快速创建您的互动绘本</p>
                    </div>
                    
                    <div class="import-section active">
                        <h3>📁 导入本地文件</h3>
                        <p style="color: #666; margin-bottom: 20px;">
                            选择包含绘本数据的JSON文件，或拖拽文件到下方区域
                        </p>
                        
                        <div class="file-drop-zone" id="fileDropZone" onclick="document.getElementById('fileInput').click()">
                            <div style="font-size: 48px; color: #4A90E2; margin-bottom: 15px;">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <h4 style="margin: 10px 0; color: #333;">拖拽文件到这里或点击选择</h4>
                            <p style="color: #666; margin: 5px 0;">支持 .json 格式的绘本数据文件</p>
                            <small style="color: #999;">例如：book-data.json</small>
                        </div>
                        
                        <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileImport(event)">
                        
                        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
                            <h4 style="margin: 0 0 10px 0; color: #856404;">⚠️ 重要提示</h4>
                            <p style="margin: 0; color: #856404; font-size: 14px;">
                                由于浏览器安全限制，直接导入包含文件路径的JSON可能无法正常加载图片和音频。<br>
                                建议使用"创建绘本"功能手动上传图片和音频文件，或确保JSON文件中的图片和音频数据是base64格式。
                            </p>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border: 1px solid #4caf50; border-radius: 8px;">
                            <h4 style="margin: 0 0 10px 0; color: #2e7d32;">📚 转换已创建的绘本</h4>
                            <p style="margin: 0 0 15px 0; color: #2e7d32; font-size: 14px;">
                                如果您已经创建了绘本，可以将其转换为预制绘本，方便重复使用。
                            </p>
                            <button onclick="showCreatedBooksList()" style="background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                                <i class="fas fa-list"></i> 查看已创建的绘本
                            </button>
                            <small style="color: #2e7d32; display: block; margin-top: 10px;">
                                在绘本库中，每本已创建的绘本都有"转为预制"按钮，点击即可转换。
                            </small>
                        </div>
                        
                        <div id="importPreview" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;">
                            <h4 style="margin: 0 0 10px 0; color: #333;">📋 导入预览</h4>
                            <div id="importInfo"></div>
                            <button id="confirmImportBtn" class="btn btn-primary" style="margin-top: 15px;" onclick="confirmImport()">
                                <i class="fas fa-check"></i> 确认导入
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 3D翻页阅读器 -->
        <div class="book-reader" id="bookReader">
            <!-- 右上角控制按钮 -->
            <div class="top-right-controls">
                <button class="fullscreen-btn" onclick="toggleFullscreen()">⛶</button>
                <button class="close-btn" onclick="closeBook()">×</button>
            </div>
            
                <div class="reader-container">
                <!-- 绘本阅读器控制器 -->
                <div class="controls">
                    <div class="control-group">
                        <span class="book-title" id="currentBookTitle">绘本标题</span>
                    </div>
                    <div class="control-group">
                        <label for="brightness">画面亮度</label>
                        <input type="range" id="brightness" class="slider" min="0.4" max="1" step="0.1" value="1">
                    </div>
                    </div>
                    
                <!-- 3D翻页书籍容器 -->
                <div class="book-container" id="bookContainer">
                    <div class="binding-gutter"></div>

                    <div class="book" id="book">
                        <div class="book-spread" id="currentSpread">
                            <div class="page-left">
                                <div class="page-content" id="leftPageContent"></div>
                            </div>
                        <div class="page-right">
                                <div class="page-content" id="rightPageContent"></div>
                            </div>
                        </div>
                    </div>

                    <div class="click-areas">
                        <div class="click-area" id="prevArea"></div>
                        <div class="click-area" id="nextArea"></div>
                    </div>
                </div>

                <!-- 页码指示器 -->
                <div class="external-page-indicator">
                    <div class="page-numbers" id="pageIndicator">Page 1</div>
                </div>

                <!-- 音频控制器 -->
                    <div class="reader-controls">
                    <button class="reader-nav-btn" onclick="prevPage()">‹</button>
                    <button class="control-btn" onclick="togglePlay()" id="playBtn">▶️</button>
                    <button class="auto-play-toggle" onclick="toggleAutoPlay()" id="autoPlayBtn">自动播放</button>
                    <button class="reader-nav-btn" onclick="nextPage()">›</button>
                        </div>
                    </div>

            <audio id="audioPlayer" preload="auto"></audio>
                        </div>
                    </div>

    <script>
        // =============== 全局变量和状态管理 ===============
        let narratorFiles = [];     // 旁白音频文件
        let characterFiles = [];    // 角色音频文件
        let imageFiles = [];
        let pages = [];
        let currentPage = 0;
        let isPlaying = false;
        let autoPlay = true;
        let bookReader = null; // 3D翻页阅读器实例
        let savedBooks = []; // 保存的绘本列表
        let characterConfigs = []; // 角色配置列表
        let currentAudioSequence = null; // 当前播放的音频序列
        let autoMatcher = null; // 自动匹配器实例
        let currentEditingBookId = null; // 当前编辑的绘本ID


        // 预置绘本数据
        const PresetBooks = [
            {
                id: '奇奇的蔬菜王国',
                title: '奇奇的蔬菜王国',
                description: '一个关于小朋友吃饭的绘本故事。',
                author: '绘本智能体',
                coverImage: './books/奇奇的蔬菜王国/images/cover.jpg',
                dataUrl: './books/奇奇的蔬菜王国/book-data.json',
                source: 'preset'
            }
        ];

        // 显示已创建的绘本列表
        function showCreatedBooksList() {
            if (savedBooks.length === 0) {
                showErrorMessage('当前没有已创建的绘本！请先创建一本绘本。');
                return;
            }

            let message = '已创建的绘本列表：\n\n';
            savedBooks.forEach((book, index) => {
                message += `${index + 1}. 《${book.title}》\n`;
                message += `   作者：${book.author || '未知'}\n`;
                message += `   页数：${book.pages ? book.pages.length : 0} 页\n`;
                message += `   创建时间：${book.createdAt ? new Date(book.createdAt).toLocaleString() : '未知'}\n\n`;
            });

            alert(message);
        }

        // 将生成的绘本转换为预制绘本
        function convertGeneratedBookToPreset(bookId) {
            const book = BookStorage.getById(bookId);
            if (!book) {
                showErrorMessage('绘本不存在！');
                return;
            }

            console.log('开始转换绘本:', book.title);
            console.log('绘本数据:', book);

            // 创建新的预制绘本数据
            const presetBook = {
                id: book.id,
                title: book.title,
                description: book.description,
                author: book.author,
                coverImage: `./books/${book.id}/images/cover.jpg`,
                dataUrl: `./books/${book.id}/book-data.json`,
                source: 'preset'
            };

            // 创建页面数据
            const pagesData = book.pages.map((page, index) => ({
                id: index + 1,
                image: `./images/page${index + 1}.jpg`,
                narrator: `./audio/p${index + 1}.mp3`,
                characters: page.characters || [],
                text: page.text,
                pageType: page.pageType || 'public',
                options: page.options || []
            }));

            // 创建完整的绘本数据
            const bookData = {
                id: book.id,
                title: book.title,
                description: book.description,
                author: book.author,
                createdAt: new Date().toISOString(),
                pages: pagesData
            };

            // 生成JSON文件内容
            const jsonContent = JSON.stringify(bookData, null, 2);
            
            // 创建下载链接
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'book-data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showSuccessMessage('绘本数据已导出为JSON文件！请将文件保存到 books/您的绘本名称/ 文件夹中。');
            
            // 询问是否要更新预制绘本列表
            if (confirm('是否要将此绘本添加到预制绘本列表中？')) {
                // 更新预制绘本列表
                const existingIndex = PresetBooks.findIndex(pb => pb.id === bookId);
                if (existingIndex >= 0) {
                    PresetBooks[existingIndex] = presetBook;
                    console.log('更新了现有预制绘本:', presetBook.title);
                } else {
                    PresetBooks.push(presetBook);
                    console.log('添加了新预制绘本:', presetBook.title);
                }
                
                // 刷新绘本库显示
                AppState.renderBooksGrid();
                
                showSuccessMessage(`绘本《${book.title}》已成功转换为预制绘本！`);
            }
            
            return { presetBook, bookData, pagesData };
        }

        // 应用状态管理
        const AppState = {
            currentTab: 'library',
            currentBook: null,
            isReading: false,

            switchTab(tabName) {
                // 隐藏所有tab内容
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // 显示目标tab
                document.getElementById(tabName).classList.add('active');
                
                // 更新导航按钮状态
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                
                this.currentTab = tabName;
                
                // 如果切换到绘本库，刷新列表
                if (tabName === 'library') {
                    this.refreshLibrary();
                }
            },

            refreshLibrary() {
                this.loadBooks();
                this.renderBooksGrid();
            }
        };

        // 简化的绘本管理（无本地存储）
        class BookStorage {
            static save(book) {
                // 简单添加ID和创建时间，但不保存到localStorage
                book.id = this.generateId();
                book.createdDate = new Date().toISOString();
                console.log('绘本创建成功（仅在当前会话有效）');
                return book;
            }
            
            static getAll() {
                // 返回当前会话中创建的绘本
                return savedBooks || [];
            }
            
            static getById(bookId) {
                return savedBooks.find(book => book.id === bookId);
            }
            
            static delete(bookId) {
                const index = savedBooks.findIndex(book => book.id === bookId);
                if (index > -1) {
                    savedBooks.splice(index, 1);
                }
            }
            
            static generateId() {
                return 'book_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            // 将文件转换为Base64
            static async fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            // 压缩图片并转换为Base64
            static async compressImageAndConvert(file, maxWidth = 1200, quality = 0.8) {
                return new Promise((resolve, reject) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = () => {
                        // 计算压缩后的尺寸
                        let { width, height } = img;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        // 设置canvas尺寸
                        canvas.width = width;
                        canvas.height = height;
                        
                        // 绘制并压缩图片
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        try {
                            // 输出为压缩后的base64
                            const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                            console.log(`图片压缩: ${file.name} 原尺寸 ${img.width}x${img.height} -> 新尺寸 ${width}x${height}`);
                            resolve(compressedBase64);
                        } catch (error) {
                            console.error('图片压缩失败:', error);
                            // 如果压缩失败，回退到原文件
                            this.fileToBase64(file).then(resolve).catch(reject);
                        }
                    };
                    
                    img.onerror = () => {
                        console.error('图片加载失败，使用原文件');
                        // 如果图片加载失败，回退到原文件
                        this.fileToBase64(file).then(resolve).catch(reject);
                    };
                    
                    img.src = URL.createObjectURL(file);
                });
            }

            // 音频压缩（简化版本 - 主要是格式转换）
            static async compressAudioAndConvert(file) {
                // 对于音频，我们暂时不做复杂的压缩处理
                // 如果文件过大，可以在这里添加音频压缩逻辑
                if (file.size > 5 * 1024 * 1024) { // 5MB以上的音频给出警告
                    console.warn(`音频文件较大: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)，建议使用音频编辑软件预先压缩`);
                }
                return this.fileToBase64(file);
            }

            // 将Base64转换为Blob URL
            static base64ToUrl(base64Data) {
                if (!base64Data || !base64Data.startsWith('data:')) {
                    return null;
                }
                try {
                    // 从Base64创建Blob
                    const byteCharacters = atob(base64Data.split(',')[1]);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const mimeType = base64Data.split(',')[0].split(':')[1].split(';')[0];
                    const blob = new Blob([byteArray], { type: mimeType });
                    return URL.createObjectURL(blob);
                } catch (error) {
                    console.error('Base64转换失败:', error);
                    return null;
                }
            }
            
            // 将Base64转换为Blob（用于导出）
            static base64ToBlob(base64Data) {
                if (!base64Data || !base64Data.startsWith('data:')) {
                    return null;
                }
                try {
                    const byteCharacters = atob(base64Data.split(',')[1]);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const mimeType = base64Data.split(',')[0].split(':')[1].split(';')[0];
                    return new Blob([byteArray], { type: mimeType });
                } catch (error) {
                    console.error('Base64转Blob失败:', error);
                    return null;
                }
            }

            // 获取当前会话信息（无存储限制）
            static getStorageInfo() {
                return {
                    totalBooks: savedBooks ? savedBooks.length : 0,
                    totalSizeMB: '无限制',
                    remainingSpaceMB: '无限制'
                };
            }

            // 检查文件大小并给出建议
            static checkFileSize(file, type = 'file') {
                const maxImageSize = 2 * 1024 * 1024; // 2MB建议大小
                const maxAudioSize = 3 * 1024 * 1024; // 3MB建议大小
                
                if (type === 'image' && file.size > maxImageSize) {
                    console.warn(`图片文件 ${file.name || '未知'} 较大 (${(file.size/1024/1024).toFixed(2)}MB)，建议通过Figma等工具压缩后上传`);
                } else if (type === 'audio' && file.size > maxAudioSize) {
                    console.warn(`音频文件 ${file.name || '未知'} 较大 (${(file.size/1024/1024).toFixed(2)}MB)，建议压缩后上传`);
                }
                
                return file; // 直接返回原文件，不进行压缩
            }
        }

        // =============== 文件名解析器类 ===============
        class FileNameParser {
            // 提取文件名中的数字序号
            extractNumber(filename) {
                // 去掉文件扩展名
                const nameWithoutExt = filename.replace(/\.[^/.]+$/, "");
                // 查找数字模式
                const matches = nameWithoutExt.match(/(\d+)/g);
                if (matches && matches.length > 0) {
                    // 取最后一个数字作为序号（通常是最相关的）
                    return parseInt(matches[matches.length - 1]);
                }
                return null;
            }
            
            // 提取文件名前缀（数字前的部分）
            extractPrefix(filename) {
                const nameWithoutExt = filename.replace(/\.[^/.]+$/, "");
                return nameWithoutExt.replace(/\d+.*$/, '').trim();
            }
            
            // 解析角色音频文件名 (格式: 页面号-角色号.mp3)
            parseCharacterAudio(filename) {
                const nameWithoutExt = filename.replace(/\.[^/.]+$/, "");
                const match = nameWithoutExt.match(/^(\d+)-(\d+)$/);
                if (match) {
                    return {
                        pageNumber: parseInt(match[1]),
                        characterNumber: parseInt(match[2])
                    };
                }
                return null;
            }
            
            // 解析旁白音频文件名 (格式: p页面号.mp3)
            parseNarratorAudio(filename) {
                const nameWithoutExt = filename.replace(/\.[^/.]+$/, "");
                const match = nameWithoutExt.match(/^p(\d+)$/i);
                if (match) {
                    return {
                        pageNumber: parseInt(match[1])
                    };
                }
                return null;
            }
            
            // 按序号排序文件
            sortByNumber(files) {
                return [...files].sort((a, b) => {
                    const numA = this.extractNumber(a.name) || 999999;
                    const numB = this.extractNumber(b.name) || 999999;
                    return numA - numB;
                });
            }
            
            // 按页面号分组角色音频
            groupCharacterAudiosByPage(characterFiles) {
                const grouped = {};
                characterFiles.forEach(file => {
                    const parsed = this.parseCharacterAudio(file.name);
                    if (parsed) {
                        const pageNum = parsed.pageNumber;
                        if (!grouped[pageNum]) {
                            grouped[pageNum] = [];
                        }
                        grouped[pageNum].push({
                            file: file,
                            characterNumber: parsed.characterNumber
                        });
                    }
                });
                
                // 对每个页面的角色音频按角色编号排序
                Object.keys(grouped).forEach(pageNum => {
                    grouped[pageNum].sort((a, b) => a.characterNumber - b.characterNumber);
                });
                
                return grouped;
            }
            
            // 获取文件排序信息（用于调试）
            getFileInfo(file) {
                const characterInfo = this.parseCharacterAudio(file.name);
                const narratorInfo = this.parseNarratorAudio(file.name);
                
                return {
                    name: file.name,
                    number: this.extractNumber(file.name),
                    prefix: this.extractPrefix(file.name),
                    characterInfo: characterInfo,
                    narratorInfo: narratorInfo
                };
            }
        }

        // =============== 自动匹配器类 ===============
        class AutoMatcher {
            constructor() {
                this.parser = new FileNameParser();
            }
            
            // 自动匹配图片、旁白音频和角色音频
            autoMatch(imageFiles, narratorFiles, characterFiles = []) {
                console.log('开始自动匹配...');
                console.log('图片文件:', imageFiles.map(f => this.parser.getFileInfo(f)));
                console.log('旁白文件:', narratorFiles.map(f => this.parser.getFileInfo(f)));
                console.log('角色文件:', characterFiles.map(f => this.parser.getFileInfo(f)));
                
                // 按序号排序图片
                const sortedImages = this.parser.sortByNumber(imageFiles);
                
                // 解析旁白音频，按页面号分组
                const narratorByPage = {};
                narratorFiles.forEach(file => {
                    const parsed = this.parser.parseNarratorAudio(file.name);
                    if (parsed) {
                        narratorByPage[parsed.pageNumber] = file;
                    }
                });
                
                // 解析角色音频，按页面号分组
                const characterByPage = this.parser.groupCharacterAudiosByPage(characterFiles);
                
                // 获取所有页面号
                const allPageNumbers = new Set();
                sortedImages.forEach(img => {
                    const num = this.parser.extractNumber(img.name);
                    if (num) allPageNumbers.add(num);
                });
                Object.keys(narratorByPage).forEach(num => allPageNumbers.add(parseInt(num)));
                Object.keys(characterByPage).forEach(num => allPageNumbers.add(parseInt(num)));
                
                const sortedPageNumbers = Array.from(allPageNumbers).sort((a, b) => a - b);
                
                // 生成匹配结果
                const matches = [];
                sortedPageNumbers.forEach(pageNumber => {
                    // 找到对应的图片
                    const image = sortedImages.find(img => 
                        this.parser.extractNumber(img.name) === pageNumber
                    ) || null;
                    
                    // 找到对应的旁白
                    const narrator = narratorByPage[pageNumber] || null;
                    
                    // 找到对应的角色音频
                    const characters = characterByPage[pageNumber] || [];
                    
                    matches.push({
                        pageNumber: pageNumber,
                        image: image,
                        narrator: narrator,
                        characters: characters,
                        imageIndex: image ? imageFiles.indexOf(image) : -1,
                        narratorIndex: narrator ? narratorFiles.indexOf(narrator) : -1,
                        characterIndices: characters.map(c => characterFiles.indexOf(c.file))
                    });
                });
                
                console.log('匹配结果:', matches);
                return matches;
            }
            
            // 获取匹配统计信息
            getMatchStats(matches) {
                const totalMatches = matches.length;
                const perfectMatches = matches.filter(m => m.image && m.narrator).length;
                const imageOnly = matches.filter(m => m.image && !m.narrator).length;
                const narratorOnly = matches.filter(m => !m.image && m.narrator).length;
                const characterCount = matches.reduce((sum, m) => sum + m.characters.length, 0);
                
                return {
                    total: totalMatches,
                    perfect: perfectMatches,
                    imageOnly: imageOnly,
                    narratorOnly: narratorOnly,
                    characterCount: characterCount
                };
            }
        }

        // =============== 音频序列播放器类 ===============
        class AudioSequencePlayer {
            constructor(pageData) {
                this.pageData = pageData;
                this.audioQueue = this.buildAudioQueue(pageData);
                this.currentIndex = 0;
                this.isPlaying = false;
                this.currentAudio = null;
                this.onComplete = null;
            }

            buildAudioQueue(pageData) {
                const queue = [];
                console.log('构建音频队列，页面数据:', pageData);
                
                // 添加旁白音频
                if (pageData.narratorUrl) {
                    console.log('添加旁白音频:', pageData.narratorUrl);
                    queue.push({
                        type: 'narrator',
                        audioUrl: pageData.narratorUrl,
                        name: '旁白'
                    });
                }
                
                // 添加0.5秒间隔
                if (pageData.narratorUrl && pageData.characters && pageData.characters.length > 0) {
                    queue.push({
                        type: 'silence',
                        duration: 0.5,
                        name: '间隔'
                    });
                }
                
                // 添加角色音频（按order排序）
                if (pageData.characters) {
                    const sortedCharacters = pageData.characters
                        .filter(char => char.audioUrl) // 只添加有音频的角色
                        .sort((a, b) => a.order - b.order);
                    
                    sortedCharacters.forEach(character => {
                        queue.push({
                            type: 'character',
                            characterId: character.id,
                            characterName: character.name,
                            audioUrl: character.audioUrl,
                            name: character.name
                        });
                    });
                }
                
                return queue;
            }

            play() {
                console.log('AudioSequencePlayer.play() 被调用');
                console.log('音频队列:', this.audioQueue);
                
                if (this.audioQueue.length === 0) {
                    console.log('没有音频可播放');
                    return;
                }
                
                this.isPlaying = true;
                this.currentIndex = 0;
                this.playNext();
            }

            playNext() {
                if (this.currentIndex >= this.audioQueue.length) {
                    this.complete();
                    return;
                }

                const currentItem = this.audioQueue[this.currentIndex];
                console.log(`播放: ${currentItem.name} (${currentItem.type})`);

                if (currentItem.type === 'silence') {
                    // 处理静音间隔
                    setTimeout(() => {
                        this.currentIndex++;
                        this.playNext();
                    }, currentItem.duration * 1000);
                } else {
                    // 播放音频
                    this.currentAudio = new Audio(currentItem.audioUrl);
                    this.currentAudio.addEventListener('ended', () => {
                        this.currentIndex++;
                        this.playNext();
                    });
                    this.currentAudio.addEventListener('error', (e) => {
                        console.error('音频播放错误:', e);
                        this.currentIndex++;
                        this.playNext();
                    });
                    this.currentAudio.play();
                }
            }

            pause() {
                this.isPlaying = false;
                if (this.currentAudio) {
                    this.currentAudio.pause();
                }
            }

            resume() {
                this.isPlaying = true;
                if (this.currentAudio) {
                    this.currentAudio.play();
                }
            }

            stop() {
                this.isPlaying = false;
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio = null;
                }
                this.currentIndex = 0;
            }

            complete() {
                this.isPlaying = false;
                this.currentAudio = null;
                this.currentIndex = 0;
                if (this.onComplete) {
                    this.onComplete();
                }
            }

            getCurrentStatus() {
                if (this.currentIndex < this.audioQueue.length) {
                    return this.audioQueue[this.currentIndex];
                }
                return null;
            }
        }

        // =============== 3D翻页阅读器类 ===============
        class DigitalBookReader {
            constructor(pagesData, bookTitle = "绘本") {
                console.log('DigitalBookReader 构造函数被调用');
                console.log('pagesData:', pagesData);
                console.log('bookTitle:', bookTitle);
                
                this.currentSpread = 0;
                this.totalPages = 0;
                this.pages = [];
                this.isAnimating = false;
                this.pagesData = pagesData; // 从外部传入的页面数据
                this.bookTitle = bookTitle;

                this.book = document.getElementById("book");
                this.currentSpreadEl = document.getElementById("currentSpread");
                this.leftPageContent = document.getElementById("leftPageContent");
                this.rightPageContent = document.getElementById("rightPageContent");
                this.pageIndicator = document.getElementById("pageIndicator");
                this.brightnessSlider = document.getElementById("brightness");
                this.bookContainer = document.getElementById("bookContainer");
                this.prevArea = document.getElementById("prevArea");
                this.nextArea = document.getElementById("nextArea");

                // 设置书籍标题
                document.getElementById('currentBookTitle').textContent = this.bookTitle;

                this.initializeFromData();
                this.initializeEventListeners();

                setTimeout(() => {
                    this.repaginateContent();
                    this.adjustBrightness(this.brightnessSlider.value);
                }, 100);
            }

            initializeFromData() {
                // 将上传的页面数据转换为翻页系统格式 - 跨页图片效果
                this.bookElements = this.pagesData.map(page => ({
                    type: "spread-image",
                    src: page.imageUrl,
                    alt: `绘本第${this.pagesData.indexOf(page) + 1}页`,
                    text: page.text,
                    audioUrl: page.audioUrl
                }));
            }

            repaginateContent() {
                this.pages = [];
                
                this.bookElements.forEach(element => {
                    if (element.type === "spread-image") {
                        // 每个跨页图片生成左右两页
                        this.pages.push([
                            { ...element, position: "left" },
                            { ...element, position: "right" }
                        ]);
                    } else {
                        this.pages.push([element]);
                    }
                });
                
                this.totalPages = this.pages.length;

                if (this.currentSpread * 2 >= this.totalPages) {
                    this.currentSpread = Math.max(0, Math.floor((this.totalPages - 1) / 2));
                }

                this.updateCurrentSpread();
                this.updateUI();
            }

            renderSpreadPart(element) {
                if (!element) return "";
                
                if (element.type === "spread-image") {
                    const cssClass = element.position === "left" ? "spread-image-left" : "spread-image-right";
                    return `<img src="${element.src}" alt="${element.alt}" class="${cssClass}">`;
                }
                return "";
            }

            updateCurrentSpread() {
                // 对于跨页图片，一个spread对应一个pages元素，包含[left_part, right_part]
                const spreadIndex = this.currentSpread;
                const spreadData = this.pages[spreadIndex];
                
                const leftPage = spreadData ? [spreadData[0]] : null;
                const rightPage = spreadData ? [spreadData[1]] : null;
                
                this.leftPageContent.classList.remove('spread-content');
                this.rightPageContent.classList.remove('spread-content');
                this.leftPageContent.parentElement.classList.remove('spread-page');
                this.rightPageContent.parentElement.classList.remove('spread-page');
                this.bookContainer.classList.remove('has-spread-image');
                
                const hasSpreadImage = (leftPage && leftPage[0] && leftPage[0].type === 'spread-image') ||
                                      (rightPage && rightPage[0] && rightPage[0].type === 'spread-image');
                
                if (hasSpreadImage) {
                    this.leftPageContent.style.opacity = '0';
                    this.rightPageContent.style.opacity = '0';
                    
                    requestAnimationFrame(() => {
                        // 直接渲染左右部分
                        this.leftPageContent.innerHTML = this.renderSpreadPart(spreadData[0]);
                        this.rightPageContent.innerHTML = this.renderSpreadPart(spreadData[1]);
                        
                        this.bookContainer.classList.add('has-spread-image');
                        
                        if (leftPage && leftPage[0] && leftPage[0].type === 'spread-image') {
                            this.leftPageContent.classList.add('spread-content');
                            this.leftPageContent.parentElement.classList.add('spread-page');
                        }
                        if (rightPage && rightPage[0] && rightPage[0].type === 'spread-image') {
                            this.rightPageContent.classList.add('spread-content');
                            this.rightPageContent.parentElement.classList.add('spread-page');
                        }
                        
                        this.leftPageContent.style.opacity = '1';
                        this.rightPageContent.style.opacity = '1';
                        
                        this.applyBrightnessToNewImages();
                    });
                } else {
                    // 对于非跨页图片，保持原有逻辑
                    this.leftPageContent.innerHTML = leftPage ? this.renderSpreadPart(spreadData[0]) : '';
                    this.rightPageContent.innerHTML = '';
                    
                    this.applyBrightnessToNewImages();
                }
            }

            nextSpread() {
                if (this.isAnimating || this.currentSpread >= this.totalPages - 1)
                    return;

                this.isAnimating = true;
                this.createFlippingPage("next");
            }

            prevSpread() {
                if (this.isAnimating || this.currentSpread <= 0) return;

                this.isAnimating = true;
                this.createFlippingPage("prev");
            }

            createFlippingPage(direction) {
                const flippingPage = document.createElement("div");
                flippingPage.className = `flipping-page ${direction}-flip`;

                const pageFront = document.createElement("div");
                pageFront.className = "page-front";

                const pageBack = document.createElement("div");
                pageBack.className = "page-back";

                let hasSpreadImage = false;

                // 预先检查是否为跨页图片以避免位移
                const currentSpreadIndex = this.currentSpread;
                const targetSpreadIndex = direction === "next" ? this.currentSpread + 1 : this.currentSpread - 1;
                const currentSpreadData = this.pages[currentSpreadIndex];
                const targetSpreadData = this.pages[targetSpreadIndex];
                
                // 如果当前或目标页面是跨页图片，立即应用类避免位移
                if ((currentSpreadData && currentSpreadData[0] && currentSpreadData[0].type === 'spread-image') ||
                    (targetSpreadData && targetSpreadData[0] && targetSpreadData[0].type === 'spread-image')) {
                    flippingPage.classList.add('has-spread-image');
                    hasSpreadImage = true;
                }

                if (direction === "next") {
                    const currentSpread = this.pages[currentSpreadIndex];
                    const nextSpread = this.pages[targetSpreadIndex];
                    
                    const currentRightPage = currentSpread ? [currentSpread[1]] : null; // 当前跨页的右侧部分
                    const nextLeftPage = nextSpread ? [nextSpread[0]] : null; // 下一跨页的左侧部分
                    
                    const frontPageContent = `<div class="page-content${currentRightPage && currentRightPage[0] && currentRightPage[0].type === 'spread-image' ? ' spread-content' : ''}">${currentSpread ? this.renderSpreadPart(currentSpread[1]) : ''}</div>`;
                    const backPageContent = `<div class="page-content${nextLeftPage && nextLeftPage[0] && nextLeftPage[0].type === 'spread-image' ? ' spread-content' : ''}">${nextSpread ? this.renderSpreadPart(nextSpread[0]) : ''}</div>`;

                    pageFront.innerHTML = frontPageContent;
                    pageBack.innerHTML = backPageContent;
                            
                    if (currentRightPage && currentRightPage[0] && currentRightPage[0].type === 'spread-image') {
                        pageFront.classList.add('spread-content');
                    }
                    if (nextLeftPage && nextLeftPage[0] && nextLeftPage[0].type === 'spread-image') {
                        pageBack.classList.add('spread-content');
                    }
                } else {
                    const currentSpread = this.pages[currentSpreadIndex];
                    const prevSpread = this.pages[targetSpreadIndex];
                    
                    const currentLeftPage = currentSpread ? [currentSpread[0]] : null; // 当前跨页的左侧部分
                    const prevLeftPage = prevSpread ? [prevSpread[0]] : null; // 上一跨页的左侧部分
                    
                    const frontPageContent = `<div class="page-content${currentLeftPage && currentLeftPage[0] && currentLeftPage[0].type === 'spread-image' ? ' spread-content' : ''}">${currentSpread ? this.renderSpreadPart(currentSpread[0]) : ''}</div>`;
                    const backPageContent = `<div class="page-content${prevLeftPage && prevLeftPage[0] && prevLeftPage[0].type === 'spread-image' ? ' spread-content' : ''}">${prevSpread ? this.renderSpreadPart(prevSpread[0]) : ''}</div>`;

                    pageFront.innerHTML = frontPageContent;
                    pageBack.innerHTML = backPageContent;
                            
                    if (currentLeftPage && currentLeftPage[0] && currentLeftPage[0].type === 'spread-image') {
                        pageFront.classList.add('spread-content');
                    }
                    if (prevLeftPage && prevLeftPage[0] && prevLeftPage[0].type === 'spread-image') {
                        pageBack.classList.add('spread-content');
                    }
                }

                flippingPage.appendChild(pageFront);
                flippingPage.appendChild(pageBack);
                this.book.appendChild(flippingPage);

                requestAnimationFrame(() => {
                    flippingPage.classList.add("flipping");
                });

                setTimeout(() => {
                    if (direction === "next") {
                        this.currentSpread++;
                    } else {
                        this.currentSpread--;
                    }
                    this.updateCurrentSpread();
                    this.updateUI();
                    
                    // 触发音频播放
                    this.triggerAudioForCurrentSpread();
                }, 500);

                setTimeout(() => {
                    this.book.removeChild(flippingPage);
                    this.isAnimating = false;
                }, 1250);
            }

            updateUI() {
                // 对于跨页图片，每个spread代表一个完整的页面
                const currentPageNum = this.currentSpread + 1;
                const totalPageNum = this.totalPages;
                this.pageIndicator.textContent = `Page ${currentPageNum} of ${totalPageNum}`;
            }

            adjustBrightness(value) {
                const brightness = parseFloat(value);
                
                this.bookContainer.style.setProperty("--image-brightness", brightness);
                this.applyBrightnessToNewImages();
            }
            
            applyBrightnessToNewImages() {
                const brightness = this.brightnessSlider.value;
                const images = this.bookContainer.querySelectorAll('img');
                images.forEach(img => {
                    img.style.filter = `brightness(${brightness})`;
                });
            }

            initializeEventListeners() {
                this.prevArea.addEventListener("click", () => this.prevSpread());
                this.nextArea.addEventListener("click", () => this.nextSpread());

                this.brightnessSlider.addEventListener("input", (e) =>
                    this.adjustBrightness(e.target.value)
                );

                document.addEventListener("keydown", (e) => {
                    if (document.getElementById('bookReader').style.display === 'block') {
                        switch(e.key) {
                            case 'ArrowLeft':
                                this.prevSpread();
                                break;
                            case 'ArrowRight':
                                this.nextSpread();
                                break;
                        }
                    }
                });
            }

            goToPage(pageIndex) {
                // 确保页面索引在有效范围内
                if (pageIndex < 0 || pageIndex >= this.totalPages) {
                    console.error('页面索引超出范围:', pageIndex);
                    return;
                }
                
                // 更新当前跨页索引
                this.currentSpread = pageIndex;
                
                // 更新页面显示
                this.updateUI();
                
                // 更新当前页面内容
                const currentSpread = this.pages[this.currentSpread];
                if (currentSpread) {
                    this.leftPageContent.innerHTML = `<div class="page-content${currentSpread[0] && currentSpread[0].type === 'spread-image' ? ' spread-content' : ''}">${this.renderSpreadPart(currentSpread[0])}</div>`;
                    this.rightPageContent.innerHTML = `<div class="page-content${currentSpread[1] && currentSpread[1].type === 'spread-image' ? ' spread-content' : ''}">${this.renderSpreadPart(currentSpread[1])}</div>`;
                }
                
                // 触发音频播放
                this.triggerAudioForCurrentSpread();
            }

            triggerAudioForCurrentSpread() {
                // 获取当前跨页对应的原始页面数据
                const originalPageIndex = this.currentSpread;
                console.log('triggerAudioForCurrentSpread 被调用，页面索引:', originalPageIndex);
                
                if (originalPageIndex < this.pagesData.length) {
                    const pageData = this.pagesData[originalPageIndex];
                    // 检查是否有旁白音频或角色音频
                    const hasAudio = (pageData && pageData.narratorUrl) || 
                                   (pageData && pageData.characters && pageData.characters.length > 0);
                    
                    console.log('页面数据:', pageData);
                    console.log('是否有音频:', hasAudio);
                    console.log('自动播放状态:', autoPlay);
                    
                    if (hasAudio) {
                        // 更新全局的当前页面索引
                        currentPage = originalPageIndex;
                        // 播放音频
                        if (autoPlay) {
                            console.log('准备播放页面音频，页面索引:', originalPageIndex);
                            setTimeout(() => playCurrentPage(), 300);
                        }
                    }
                }
            }
        }

        // =============== 导入绘本功能 ===============
        let importedBookData = null;

        // 处理文件导入
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.json')) {
                showErrorMessage('请选择JSON格式的文件！');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    validateAndPreviewImport(data);
                } catch (error) {
                    console.error('JSON解析错误:', error);
                    showErrorMessage('文件格式错误，请确保是有效的JSON文件！');
                }
            };
            reader.readAsText(file);
        }

        // 验证并预览导入数据
        function validateAndPreviewImport(data) {
            // 验证必要字段
            if (!data.title || !data.pages || !Array.isArray(data.pages)) {
                showErrorMessage('绘本数据格式不正确，缺少必要字段！');
                return;
            }

            if (data.pages.length === 0) {
                showErrorMessage('绘本数据中没有页面！');
                return;
            }

            // 验证页面数据
            for (let i = 0; i < data.pages.length; i++) {
                const page = data.pages[i];
                if (!page.image || !page.narrator) {
                    showErrorMessage(`第${i + 1}页缺少图片或音频数据！`);
                    return;
                }
            }

            // 保存导入数据
            importedBookData = data;

            // 显示预览
            showImportPreview(data);
        }

        // 显示导入预览
        function showImportPreview(data) {
            const preview = document.getElementById('importPreview');
            const info = document.getElementById('importInfo');
            
            const pageTypes = data.pages.reduce((acc, page) => {
                const type = page.pageType || 'public';
                acc[type] = (acc[type] || 0) + 1;
                return acc;
            }, {});

            const optionsCount = data.pages.reduce((acc, page) => {
                return acc + (page.options ? page.options.length : 0);
            }, 0);

            info.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <strong>📖 绘本名称:</strong><br>
                        <span style="color: #666;">${data.title}</span>
                    </div>
                    <div>
                        <strong>✍️ 作者:</strong><br>
                        <span style="color: #666;">${data.author || '未知'}</span>
                    </div>
                    <div>
                        <strong>📝 简介:</strong><br>
                        <span style="color: #666;">${data.description || '无'}</span>
                    </div>
                    <div>
                        <strong>📊 页面统计:</strong><br>
                        <span style="color: #666;">共 ${data.pages.length} 页</span>
                    </div>
                </div>
                <div style="background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                    <strong>📋 页面类型分布:</strong><br>
                    <span style="color: #666;">
                        ${pageTypes.public ? `公共页: ${pageTypes.public} 页` : ''}
                        ${pageTypes.interactive ? ` | 互动页: ${pageTypes.interactive} 页` : ''}
                        ${optionsCount > 0 ? ` | 选项总数: ${optionsCount} 个` : ''}
                    </span>
                </div>
                <div style="color: #28a745; font-weight: bold;">
                    ✅ 数据验证通过，可以导入！
                </div>
            `;

            preview.style.display = 'block';
        }

        // 确认导入
        async function confirmImport() {
            if (!importedBookData) {
                showErrorMessage('没有可导入的数据！');
                return;
            }

            try {
                showLoadingMessage('正在导入绘本...');

                // 转换数据格式 - 处理文件路径
                const convertedPages = [];
                
                console.log('开始转换导入数据，共', importedBookData.pages.length, '页');
                
                for (let i = 0; i < importedBookData.pages.length; i++) {
                    const page = importedBookData.pages[i];
                    console.log(`处理第 ${i + 1} 页:`, page);
                    
                    // 处理图片数据
                    let imageBase64 = '';
                    if (page.image) {
                        if (page.image.startsWith('data:')) {
                            // 已经是base64格式
                            console.log(`第 ${i + 1} 页图片已是base64格式`);
                            imageBase64 = page.image;
                        } else {
                            // 是文件路径，需要转换为base64
                            console.log(`第 ${i + 1} 页图片路径: ${page.image}`);
                            try {
                                // 尝试使用相对路径加载图片
                                const imageUrl = page.image.startsWith('./') ? page.image : './' + page.image;
                                console.log(`尝试加载图片: ${imageUrl}`);
                                
                                const imageResponse = await fetch(imageUrl);
                                console.log(`图片响应状态: ${imageResponse.status}`);
                                if (imageResponse.ok) {
                                    const imageBlob = await imageResponse.blob();
                                    console.log(`图片blob大小: ${imageBlob.size} bytes`);
                                    imageBase64 = await convertBlobToBase64(imageBlob);
                                    console.log(`图片转换成功，base64长度: ${imageBase64.length}`);
                                } else {
                                    console.warn(`无法加载图片: ${imageUrl}, 状态: ${imageResponse.status}`);
                                    imageBase64 = createPlaceholderImage(800, 600, `图片 ${i + 1}`);
                                }
                            } catch (error) {
                                console.warn(`图片加载失败: ${page.image}`, error);
                                console.log('CORS错误，创建占位图片');
                                imageBase64 = createPlaceholderImage(800, 600, `图片 ${i + 1}`);
                            }
                        }
                    } else {
                        console.warn(`第 ${i + 1} 页没有图片数据`);
                        imageBase64 = createPlaceholderImage(800, 600, `图片 ${i + 1}`);
                    }

                    // 处理音频数据
                    let audioBase64 = '';
                    if (page.narrator) {
                        if (page.narrator.startsWith('data:')) {
                            // 已经是base64格式
                            console.log(`第 ${i + 1} 页音频已是base64格式`);
                            audioBase64 = page.narrator;
                        } else {
                            // 是文件路径，需要转换为base64
                            console.log(`第 ${i + 1} 页音频路径: ${page.narrator}`);
                            try {
                                // 尝试使用相对路径加载音频
                                const audioUrl = page.narrator.startsWith('./') ? page.narrator : './' + page.narrator;
                                console.log(`尝试加载音频: ${audioUrl}`);
                                
                                const audioResponse = await fetch(audioUrl);
                                console.log(`音频响应状态: ${audioResponse.status}`);
                                if (audioResponse.ok) {
                                    const audioBlob = await audioResponse.blob();
                                    console.log(`音频blob大小: ${audioBlob.size} bytes`);
                                    audioBase64 = await convertBlobToBase64(audioBlob);
                                    console.log(`音频转换成功，base64长度: ${audioBase64.length}`);
                                } else {
                                    console.warn(`无法加载音频: ${audioUrl}, 状态: ${audioResponse.status}`);
                                    // 创建静音音频
                                    audioBase64 = await createSilentAudio(1000); // 1秒静音
                                }
                            } catch (error) {
                                console.warn(`音频加载失败: ${page.narrator}`, error);
                                console.log('CORS错误，创建静音音频');
                                // 创建静音音频
                                audioBase64 = await createSilentAudio(1000); // 1秒静音
                            }
                        }
                    } else {
                        console.warn(`第 ${i + 1} 页没有音频数据`);
                        audioBase64 = await createSilentAudio(1000); // 1秒静音
                    }

                    convertedPages.push({
                        id: page.id || `page_${i}`,
                        imageBase64: imageBase64,
                        audioBase64: audioBase64,
                        text: page.text || '',
                        pageType: page.pageType || 'public',
                        options: page.options || [],
                        characters: page.characters || []
                    });
                }

                // 创建绘本对象
                const bookData = {
                    title: importedBookData.title,
                    author: importedBookData.author || '绘本智能体',
                    description: importedBookData.description || `包含 ${convertedPages.length} 页的精美绘本`,
                    coverImage: convertedPages[0]?.imageBase64,
                    pages: convertedPages.map(page => ({
                        id: page.id,
                        image: page.imageBase64,
                        narrator: page.audioBase64,
                        text: page.text,
                        pageType: page.pageType,
                        options: page.options
                    }))
                };

                // 保存绘本
                const savedBook = BookStorage.save(bookData);
                savedBooks.push(savedBook);

                // 隐藏加载提示
                hideLoadingMessage();

                // 显示成功消息
                showSuccessMessage(`绘本《${bookData.title}》导入成功！已添加到绘本库 (共 ${savedBooks.length} 本绘本)`);

                // 清空导入数据
                importedBookData = null;
                document.getElementById('importPreview').style.display = 'none';
                document.getElementById('fileInput').value = '';

                // 切换到绘本库
                setTimeout(() => {
                    AppState.switchTab('library');
                }, 2000);

            } catch (error) {
                console.error('导入失败:', error);
                hideLoadingMessage();
                showErrorMessage('导入失败: ' + (error.message || '未知错误'));
            }
        }

        // 转换Blob为Base64
        function convertBlobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // 创建占位图片
        function createPlaceholderImage(width, height, text) {
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            
            // 背景色
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, width, height);
            
            // 边框
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 2;
            ctx.strokeRect(0, 0, width, height);
            
            // 文字
            ctx.fillStyle = '#666';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, width / 2, height / 2);
            
            return canvas.toDataURL('image/png');
        }

        // 创建静音音频
        function createSilentAudio(duration) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const sampleRate = audioContext.sampleRate;
            const length = sampleRate * duration / 1000;
            const buffer = audioContext.createBuffer(1, length, sampleRate);
            
            // 创建静音数据
            const channelData = buffer.getChannelData(0);
            for (let i = 0; i < length; i++) {
                channelData[i] = 0;
            }
            
            // 转换为WAV格式的base64
            const wav = encodeWAV(buffer);
            const blob = new Blob([wav], { type: 'audio/wav' });
            
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        }

        // 编码WAV格式
        function encodeWAV(buffer) {
            const length = buffer.length;
            const arrayBuffer = new ArrayBuffer(44 + length * 2);
            const view = new DataView(arrayBuffer);
            
            // WAV文件头
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, buffer.sampleRate, true);
            view.setUint32(28, buffer.sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, length * 2, true);
            
            // 写入音频数据
            const channelData = buffer.getChannelData(0);
            let offset = 44;
            for (let i = 0; i < length; i++) {
                const sample = Math.max(-1, Math.min(1, channelData[i]));
                view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
                offset += 2;
            }
            
            return arrayBuffer;
        }

        // 添加拖拽功能
        function initializeDragAndDrop() {
            const dropZone = document.getElementById('fileDropZone');
            
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.name.toLowerCase().endsWith('.json')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            try {
                                const data = JSON.parse(e.target.result);
                                validateAndPreviewImport(data);
                            } catch (error) {
                                console.error('JSON解析错误:', error);
                                showErrorMessage('文件格式错误，请确保是有效的JSON文件！');
                            }
                        };
                        reader.readAsText(file);
                    } else {
                        showErrorMessage('请选择JSON格式的文件！');
                    }
                }
            });
        }

        // =============== 导航和标签页管理 ===============
        function switchToCreateTab() {
            AppState.switchTab('create');
        }

        function switchToLibraryTab() {
            AppState.switchTab('library');
        }

        // =============== 主初始化函数 ===============
        function initializeApp() {
            console.log('开始初始化应用...');
            
            // 初始化导航事件
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    AppState.switchTab(tabName);
                });
            });
            
            // 加载保存的绘本
            AppState.loadBooks();
            AppState.renderBooksGrid();
            
            // 初始化文件上传事件
            initializeFileUploads();
            
            // 初始化音频播放事件
            initializeAudioEvents();
            
            // 初始化拖拽功能
            initializeDragAndDrop();
            
            // 初始化表单和UI
            updateSelects();
            updatePageList();
            updateGenerateButton();
            initializeCompressionControls();
            
            // 设置自动播放按钮初始状态
            const autoPlayBtn = document.getElementById('autoPlayBtn');
            if (autoPlayBtn) {
                autoPlayBtn.classList.add('active');
            }
            
            // 初始化自动匹配器
            autoMatcher = new AutoMatcher();
            
            console.log('应用初始化完成');
        }
        
        // 文件上传初始化
        function initializeFileUploads() {
            // 旁白音频文件上传
            const narratorFilesInput = document.getElementById('narratorFiles');
            if (narratorFilesInput) {
                narratorFilesInput.addEventListener('change', function(e) {
                    const newFiles = Array.from(e.target.files);
                    if (newFiles.length > 0) {
                        newFiles.forEach(file => {
                            if (!narratorFiles.find(f => f.name === file.name && f.size === file.size)) {
                                narratorFiles.push(file);
                            }
                        });
                        updateNarratorList();
                        updateSelects();
                        
                        // 显示上传成功提示
                        showUploadFeedback('narratorUpload', `成功上传 ${newFiles.length} 个旁白音频！`);
                    }
                    this.value = '';
                });
            }

            // 角色音频文件上传
            const characterFilesInput = document.getElementById('characterFiles');
            if (characterFilesInput) {
                characterFilesInput.addEventListener('change', function(e) {
                    const newFiles = Array.from(e.target.files);
                    if (newFiles.length > 0) {
                        newFiles.forEach(file => {
                            if (!characterFiles.find(f => f.name === file.name && f.size === file.size)) {
                                characterFiles.push(file);
                            }
                        });
                        updateCharacterList();
                        updateCharacterSelects();
                        
                        // 显示上传成功提示
                        showUploadFeedback('characterUpload', `成功上传 ${newFiles.length} 个角色音频！`);
                    }
                    this.value = '';
                });
            }

            // 图片文件上传
            const imageFilesInput = document.getElementById('imageFiles');
            if (imageFilesInput) {
                imageFilesInput.addEventListener('change', function(e) {
                    const newFiles = Array.from(e.target.files);
                    if (newFiles.length > 0) {
                        newFiles.forEach(file => {
                            if (!imageFiles.find(f => f.name === file.name && f.size === file.size)) {
                                imageFiles.push(file);
                            }
                        });
                        updateImageList();
                        updateSelects();
                        
                        // 显示上传成功提示
                        showUploadFeedback('imageUpload', `成功上传 ${newFiles.length} 个图片文件！`);
                    }
                    // 清空输入框，允许重复选择相同文件
                    this.value = '';
                });
            }
        }
        
        // 压缩控制初始化
        function initializeCompressionControls() {
            const qualitySlider = document.getElementById('imageQuality');
            const qualityDisplay = document.getElementById('qualityDisplay');
            
            if (qualitySlider && qualityDisplay) {
                qualitySlider.addEventListener('input', function(e) {
                    qualityDisplay.textContent = e.target.value;
                });
            }
        }
        
        // 音频播放事件初始化
        function initializeAudioEvents() {
            // 移除旧的audioPlayer事件监听器，现在使用AudioSequencePlayer
            console.log('音频事件初始化完成 - 使用AudioSequencePlayer');
        }

        // =============== 绘本库管理 ===============
        AppState.loadBooks = function() {
            // 初始化空的绘本列表（仅当前会话有效）
            if (!savedBooks) {
                savedBooks = [];
            }
        };

        AppState.renderBooksGrid = function() {
            const booksGrid = document.getElementById('booksGrid');
            const emptyState = document.getElementById('emptyState');
            
            // 更新存储信息显示
            this.updateStorageInfo();
            
            // 合并预置绘本和用户绘本
            const allBooks = [...PresetBooks, ...savedBooks];
            
            if (allBooks.length === 0) {
                emptyState.style.display = 'block';
                // 清除其他内容
                const existingCards = booksGrid.querySelectorAll('.book-card');
                existingCards.forEach(card => card.remove());
                return;
            }
            
            emptyState.style.display = 'none';
            
            // 清除现有卡片
            const existingCards = booksGrid.querySelectorAll('.book-card');
            existingCards.forEach(card => card.remove());
            
            // 生成绘本卡片
            allBooks.forEach(book => {
                const bookCard = createBookCard(book);
                booksGrid.appendChild(bookCard);
            });
        };

        AppState.updateStorageInfo = function() {
            const storageInfoEl = document.getElementById('storageInfo');
            if (storageInfoEl) {
                const info = BookStorage.getStorageInfo();
                
                storageInfoEl.innerHTML = `
                    <i class="fas fa-memory"></i> 
                    当前会话：${info.totalBooks} 本绘本（刷新页面后将清空）
                `;
                storageInfoEl.style.color = 'rgba(255,255,255,0.8)';
            }
        };

        function createBookCard(book) {
            const card = document.createElement('div');
            card.className = 'book-card';
            card.setAttribute('data-book-id', book.id);
            
            // 处理封面图片URL
            let coverImageUrl = '';
            if (book.coverImage) {
                if (book.coverImage.startsWith('data:')) {
                    // 用户绘本：Base64数据
                    coverImageUrl = BookStorage.base64ToUrl(book.coverImage);
                } else {
                    // 预置绘本：相对路径
                    coverImageUrl = book.coverImage;
                }
            }
            
            // 处理创建日期
            const createdDate = book.createdDate ? 
                new Date(book.createdDate).toLocaleDateString('zh-CN') : 
                '预置绘本';
            
            // 处理页面数量
            const pageCount = book.pages ? book.pages.length : '未知';
            
            // 生成操作按钮
            const actionButtons = book.source === 'preset' ? 
                `<button class="overlay-btn" onclick="loadPresetBook('${book.id}')">
                    <i class="fas fa-book-open"></i> 阅读
                </button>` :
                `<button class="overlay-btn" onclick="openBookForReading('${book.id}')">
                    <i class="fas fa-book-open"></i> 阅读
                </button>
                <button class="overlay-btn" onclick="editBook('${book.id}')" style="background: #ffc107;">
                    <i class="fas fa-edit"></i> 编辑
                </button>
                <button class="overlay-btn" onclick="convertGeneratedBookToPreset('${book.id}')" style="background: #28a745;">
                    <i class="fas fa-magic"></i> 转为预制
                </button>
                <button class="overlay-btn" onclick="exportAsPresetBook('${book.id}')" style="background: #17a2b8;">
                    <i class="fas fa-download"></i> 导出预置
                </button>
                <button class="overlay-btn" onclick="deleteBook('${book.id}')">
                    <i class="fas fa-trash"></i> 删除
                </button>`;
            
            card.innerHTML = `
                <div class="book-cover">
                    ${coverImageUrl ? 
                        `<img src="${coverImageUrl}" alt="${book.title || '绘本封面'}" onerror="this.parentElement.innerHTML='<div class=&quot;placeholder&quot;><i class=&quot;fas fa-book&quot;></i></div>'">` : 
                        `<div class="placeholder"><i class="fas fa-book"></i></div>`
                    }

                    <div class="book-overlay">
                        ${actionButtons}
                    </div>
                </div>
                <div class="book-info">
                    <h3>${book.title || '未命名绘本'}</h3>
                    <p class="book-description">${book.description || '暂无描述'}</p>
                    <div class="book-meta">
                        <span><i class="fas fa-user"></i> ${book.author || '未知作者'}</span>
                        <span><i class="fas fa-calendar"></i> ${createdDate}</span>
                        <span><i class="fas fa-file-alt"></i> ${pageCount} 页</span>
                    </div>
                    <div class="book-tags">
                        <span class="tag">绘本</span>

                        ${pageCount > 5 ? '<span class="tag">长篇</span>' : '<span class="tag">短篇</span>'}
                    </div>
                </div>
            `;
            
            return card;
        }

        // 加载预置绘本
        // 测试文件访问的函数
        async function testFileAccess(url) {
            try {
                const response = await fetch(url);
                return {
                    success: response.ok,
                    status: response.status,
                    statusText: response.statusText
                };
            } catch (error) {
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        async function loadPresetBook(bookId) {
            const presetBook = PresetBooks.find(book => book.id === bookId);
            if (!presetBook) {
                showErrorMessage('预置绘本不存在！');
                return;
            }
            
            try {
                showLoadingMessage('正在加载绘本...');
                
                let bookData;
                
                // 先测试文件访问
                console.log('测试文件访问...');
                const testResult = await testFileAccess(presetBook.dataUrl);
                console.log('文件访问测试结果:', testResult);
                
                if (!testResult.success) {
                    throw new Error(`无法访问绘本数据文件: ${testResult.error || testResult.statusText}`);
                }
                
                // 从JSON文件加载绘本数据
                console.log('尝试加载绘本数据:', presetBook.dataUrl);
                console.log('当前页面URL:', window.location.href);
                console.log('完整数据URL:', new URL(presetBook.dataUrl, window.location.href).href);
                
                const response = await fetch(presetBook.dataUrl);
                console.log('响应状态:', response.status, response.statusText);
                console.log('响应头:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`无法加载绘本数据: ${response.status} ${response.statusText}`);
                }
                
                const jsonText = await response.text();
                console.log('JSON内容:', jsonText.substring(0, 200) + '...');
                
                try {
                    bookData = JSON.parse(jsonText);
                    console.log('从文件加载的绘本数据:', bookData);
                } catch (parseError) {
                    console.error('JSON解析错误:', parseError);
                    throw new Error('绘本数据格式错误');
                }
                
                // 转换为阅读器需要的格式
                const pages = bookData.pages.map((page, index) => {
                    const imageUrl = presetBook.dataUrl.replace('book-data.json', page.image);
                    const audioUrl = presetBook.dataUrl.replace('book-data.json', page.narrator);
                    
                    console.log(`页面 ${index + 1}:`, {
                        image: page.image,
                        imageUrl: imageUrl,
                        narrator: page.narrator,
                        audioUrl: audioUrl
                    });
                    
                    return {
                        id: page.id || `page_${index}`,
                        imageUrl: imageUrl,
                        narratorUrl: audioUrl,
                        audioUrl: audioUrl,
                    characters: page.characters ? page.characters.map(char => ({
                        name: char.name,
                        audioUrl: presetBook.dataUrl.replace('book-data.json', char.audio)
                    })) : [],
                        text: page.text,
                        pageType: page.pageType || 'public',
                        options: page.options || []
                    };
                });
                
                console.log('转换后的页面数据:', pages);
                console.log('页面类型统计:', pages.map(p => ({ page: p.id, type: p.pageType, options: p.options?.length || 0 })));
                
                // 设置全局pages变量供音频系统使用
                window.pages = pages;
                
                // 重置页面状态
                currentPage = 0;
                
                // 初始化3D阅读器
                bookReader = new DigitalBookReader(pages, bookData.title);
                
                // 显示阅读器
                document.getElementById('bookReader').style.display = 'block';
                document.getElementById('currentBookTitle').textContent = bookData.title;
                
                // 隐藏加载提示
                hideLoadingMessage();
                
                // 设置应用状态
                AppState.isReading = true;
                AppState.currentBook = {
                    id: bookData.id,
                    title: bookData.title,
                    description: bookData.description,
                    author: bookData.author
                };
                
                // 自动播放第一页音频
                if (autoPlay) {
                    setTimeout(() => {
                        playCurrentPage();
                    }, 800);
                }
                
            } catch (error) {
                console.error('加载预置绘本失败:', error);
                hideLoadingMessage();
                showErrorMessage(`加载绘本失败: ${error.message}`);
            }
        }
        
        function openBookForReading(bookId) {
            const book = BookStorage.getById(bookId);
            if (!book) {
                showErrorMessage('绘本不存在！');
                return;
            }
            
            try {
                // 显示加载提示
                showLoadingMessage('正在加载绘本...');
                
                // 从Base64恢复页面数据
                const restoredPages = book.pages.map(page => {
                    const restoredPage = { ...page };
                    
                    // 从Base64创建新的URL
                    if (page.imageBase64) {
                        restoredPage.imageUrl = BookStorage.base64ToUrl(page.imageBase64);
                    }
                    if (page.narratorBase64) {
                        restoredPage.narratorUrl = BookStorage.base64ToUrl(page.narratorBase64);
                    }
                    
                    // 恢复角色音频URL
                    if (page.characters && page.characters.length > 0) {
                        restoredPage.characters = page.characters.map(character => ({
                            ...character,
                            audioUrl: character.audioBase64 ? BookStorage.base64ToUrl(character.audioBase64) : null
                        }));
                    }
                    
                    // 确保选项数据被正确恢复
                    if (page.options) {
                        restoredPage.options = page.options;
                    }
                    
                    return restoredPage;
                });
                
                // 设置当前绘本
                AppState.currentBook = book;
                AppState.isReading = true;
                
                // 重置页面状态
                currentPage = 0;
                pages = restoredPages; // 设置全局pages变量供音频系统使用
                window.pages = restoredPages; // 确保window.pages也包含选项数据
                
                // 初始化3D阅读器
                bookReader = new DigitalBookReader(restoredPages, book.title);
                
                // 显示阅读器
                document.getElementById('bookReader').style.display = 'block';
                
                // 隐藏加载提示
                hideLoadingMessage();
                
                // 自动播放第一页音频
                if (autoPlay) {
                    setTimeout(() => {
                        playCurrentPage();
                    }, 800);
                }
            } catch (error) {
                console.error('打开绘本失败:', error);
                hideLoadingMessage();
                showErrorMessage('绘本加载失败，可能是数据损坏！');
            }
        }

        function deleteBook(bookId) {
            if (confirm('确定要删除这本绘本吗？')) {
                BookStorage.delete(bookId);
                AppState.refreshLibrary();
                showSuccessMessage('绘本已删除！');
            }
        }

        // =============== 文件上传处理 ===============
        // (文件上传事件监听器已移至 initializeFileUploads 函数中)

        function updateNarratorList() {
            const narratorList = document.getElementById('narratorList');
            if (!narratorList) return;
            
            if (narratorFiles.length === 0) {
                narratorList.innerHTML = '';
                return;
            }
            
            narratorList.innerHTML = `
                <div style="margin-bottom: 10px; font-weight: bold; color: #28a745;">
                    已上传 ${narratorFiles.length} 个旁白音频
                </div>
            ` + narratorFiles.map((file, index) => `
                <div class="file-item">
                    <span>📢 ${file?.name || '未知文件'} (${formatFileSize(file?.size || 0)})</span>
                    <button class="remove-file" onclick="removeNarratorFile(${index})">删除</button>
                </div>
            `).join('');
        }

        function updateCharacterList() {
            const characterList = document.getElementById('characterList');
            if (!characterList) return;
            
            if (characterFiles.length === 0) {
                characterList.innerHTML = '';
                return;
            }
            
            characterList.innerHTML = `
                <div style="margin-bottom: 10px; font-weight: bold; color: #28a745;">
                    已上传 ${characterFiles.length} 个角色音频
                </div>
            ` + characterFiles.map((file, index) => `
                <div class="file-item">
                    <span>🎭 ${file?.name || '未知文件'} (${formatFileSize(file?.size || 0)})</span>
                    <button class="remove-file" onclick="removeCharacterFile(${index})">删除</button>
                </div>
            `).join('');
        }

        function updateImageList() {
            const imageList = document.getElementById('imageList');
            if (!imageList) return;
            
            if (imageFiles.length === 0) {
                imageList.innerHTML = '';
                return;
            }
            
            imageList.innerHTML = `
                <div style="margin-bottom: 10px; font-weight: bold; color: #28a745;">
                    已上传 ${imageFiles.length} 个图片文件
                    </div>
            ` + imageFiles.map((file, index) => `
                <div class="file-item">
                    <span>🖼️ ${file?.name || '未知文件'} (${formatFileSize(file?.size || 0)})</span>
                    <button class="remove-file" onclick="removeImageFile(${index})">删除</button>
                </div>
            `).join('');
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // 显示上传反馈
        function showUploadFeedback(uploadBoxId, message) {
            const uploadBox = document.getElementById(uploadBoxId);
            if (!uploadBox) return;
            
            const feedback = document.createElement('div');
            feedback.style.cssText = `
                position: absolute;
                top: 10px;
                right: 10px;
                background: #28a745;
                color: white;
                padding: 8px 12px;
                border-radius: 5px;
                font-size: 12px;
                z-index: 100;
                animation: fadeInOut 3s ease-in-out;
            `;
            feedback.textContent = message;
            
            uploadBox.style.position = 'relative';
            uploadBox.appendChild(feedback);
            
            setTimeout(() => {
                if (feedback.parentNode) {
                    feedback.parentNode.removeChild(feedback);
                }
            }, 3000);
        }

        function removeNarratorFile(index) {
            narratorFiles.splice(index, 1);
            updateNarratorList();
            updateSelects();
        }

        function removeCharacterFile(index) {
            characterFiles.splice(index, 1);
            updateCharacterList();
            updateCharacterSelects();
        }

        function removeImageFile(index) {
            imageFiles.splice(index, 1);
            updateImageList();
            updateSelects();
        }

        function updateSelects() {
            const pageImage = document.getElementById('pageImage');
            const pageNarrator = document.getElementById('pageNarrator');
            
            if (pageImage) {
                pageImage.innerHTML = '<option value="">选择背景图片</option>' + 
                    imageFiles.map((file, index) => `<option value="${index}">${file?.name || '未知图片文件'}</option>`).join('');
            }
            
            if (pageNarrator) {
                pageNarrator.innerHTML = '<option value="">选择旁白音频</option>' + 
                    narratorFiles.map((file, index) => `<option value="${index}">${file?.name || '未知旁白文件'}</option>`).join('');
            }
        }

        function updateCharacterSelects() {
            // 更新所有角色配置中的音频选择器
            const characterSelects = document.querySelectorAll('.character-audio-select');
            characterSelects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">选择角色音频</option>' + 
                    characterFiles.map((file, index) => `<option value="${index}">${file?.name || '未知角色音频'}</option>`).join('');
                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }

        // 添加角色配置
        function addCharacterConfig() {
            const configId = 'char_' + Date.now();
            const order = characterConfigs.length + 1;
            
            const characterConfig = {
                id: configId,
                name: `角色${order}`,
                audioIndex: '',
                order: order
            };
            
            characterConfigs.push(characterConfig);
            renderCharacterConfigs();
        }

        // 渲染角色配置列表
        function renderCharacterConfigs() {
            const configList = document.getElementById('characterConfigList');
            if (!configList) return;
            
            if (characterConfigs.length === 0) {
                configList.innerHTML = '';
                return;
            }
            
            configList.innerHTML = characterConfigs.map((config, index) => `
                <div class="character-config-item" data-config-id="${config.id}">
                    <div class="character-config-header">
                        <span class="character-config-title">角色 ${index + 1}</span>
                        <div class="character-config-controls">
                            <span class="drag-handle">⋮⋮</span>
                            <button class="remove-character-btn" onclick="removeCharacterConfig('${config.id}')">删除</button>
                        </div>
                    </div>
                    <div class="character-config-controls">
                        <input type="text" class="character-name-input" 
                               value="${config.name}" 
                               placeholder="角色名称"
                               onchange="updateCharacterName('${config.id}', this.value)">
                        <select class="character-audio-select" 
                                onchange="updateCharacterAudio('${config.id}', this.value)">
                            <option value="">选择角色音频</option>
                            ${characterFiles.map((file, fileIndex) => 
                                `<option value="${fileIndex}" ${config.audioIndex == fileIndex ? 'selected' : ''}>${file?.name || '未知角色音频'}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
            `).join('');
        }

        // 更新角色名称
        function updateCharacterName(configId, name) {
            const config = characterConfigs.find(c => c.id === configId);
            if (config) {
                config.name = name;
            }
        }

        // 更新角色音频
        function updateCharacterAudio(configId, audioIndex) {
            const config = characterConfigs.find(c => c.id === configId);
            if (config) {
                config.audioIndex = audioIndex;
            }
        }

        // 删除角色配置
        function removeCharacterConfig(configId) {
            const index = characterConfigs.findIndex(c => c.id === configId);
            if (index > -1) {
                characterConfigs.splice(index, 1);
                // 重新排序
                characterConfigs.forEach((config, i) => {
                    config.order = i + 1;
                });
                renderCharacterConfigs();
            }
        }

        // =============== 自动匹配功能 ===============
        
        // 显示自动匹配预览
        function showAutoMatchPreview() {
            if (imageFiles.length === 0 && narratorFiles.length === 0 && characterFiles.length === 0) {
                showErrorMessage('请先上传图片和音频文件！');
                return;
            }
            
            // 执行自动匹配（包含角色音频）
            const matches = autoMatcher.autoMatch(imageFiles, narratorFiles, characterFiles);
            const stats = autoMatcher.getMatchStats(matches);
            
            // 更新匹配信息显示
            updateAutoMatchInfo(matches, stats);
            
            // 显示预览弹窗
            showMatchPreviewModal(matches, stats);
        }
        
        // 更新自动匹配信息显示
        function updateAutoMatchInfo(matches, stats) {
            const infoEl = document.getElementById('autoMatchInfo');
            
            if (matches.length > 0) {
                infoEl.style.display = 'block';
                infoEl.innerHTML = `
                    <strong>📊 匹配分析结果：</strong><br>
                    <span style="color: #28a745;">✅ 完美匹配: ${stats.perfect} 个</span> | 
                    <span style="color: #ffc107;">⚠️ 仅图片: ${stats.imageOnly} 个</span> | 
                    <span style="color: #ffc107;">⚠️ 仅音频: ${stats.narratorOnly} 个</span><br>
                    <span style="color: #17a2b8;">🎭 角色音频: ${stats.characterCount} 个</span><br>
                    <small>总共可创建 ${stats.total} 个页面</small>
                `;
            } else {
                infoEl.style.display = 'none';
            }
        }
        
        // 显示匹配预览弹窗
        function showMatchPreviewModal(matches, stats) {
            // 创建弹窗HTML
            const modal = document.createElement('div');
            modal.className = 'match-preview';
            modal.id = 'matchPreviewModal';
            
            const matchListHTML = matches.map(match => {
                const hasImage = match.image !== null;
                const hasNarrator = match.narrator !== null;
                const hasCharacters = match.characters && match.characters.length > 0;
                let itemClass = 'match-item';
                
                if (!hasImage && !hasNarrator && !hasCharacters) {
                    itemClass += ' missing';
                } else if (!hasImage || !hasNarrator) {
                    itemClass += ' incomplete';
                }
                
                // 生成角色音频显示
                const characterFiles = match.characters.map(char => 
                    `👤 角色${char.characterNumber}: ${char.file.name}`
                ).join('<br>');
                
                return `
                    <div class="${itemClass}">
                        <div class="match-number">第${match.pageNumber}页</div>
                        <div class="match-files">
                            <div class="match-file ${hasImage ? '' : 'empty'}">
                                📷 ${hasImage ? match.image.name : '无图片'}
                            </div>
                            <div class="match-file ${hasNarrator ? '' : 'empty'}">
                                🎵 ${hasNarrator ? match.narrator.name : '无旁白'}
                            </div>
                            <div class="match-file ${hasCharacters ? '' : 'empty'}">
                                🎭 ${hasCharacters ? characterFiles : '无角色音频'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            modal.innerHTML = `
                <div class="preview-content">
                    <h3>🤖 自动匹配预览</h3>
                    <p><strong>匹配统计：</strong> 完美匹配 ${stats.perfect} 个，不完整匹配 ${stats.imageOnly + stats.narratorOnly} 个，角色音频 ${stats.characterCount} 个</p>
                    <div style="max-height: 400px; overflow-y: auto; margin: 20px 0;">
                        ${matchListHTML}
                    </div>
                    <div class="preview-actions">
                        <button class="btn-confirm" onclick="confirmAutoMatch()">
                            <i class="fas fa-plus"></i> 一键添加匹配页面
                        </button>
                        <button class="btn-cancel" onclick="closeMatchPreview()">
                            <i class="fas fa-times"></i> 关闭预览
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 存储匹配结果供后续使用
            window.currentMatches = matches;
        }
        
        // 确认自动匹配并创建页面
        function confirmAutoMatch() {
            closeMatchPreview();
            autoCreateAllPages();
        }
        
        // 一键创建所有匹配的页面
        async function autoCreateAllPages() {
            const matches = window.currentMatches || autoMatcher.autoMatch(imageFiles, narratorFiles, characterFiles);
            
            if (matches.length === 0) {
                showErrorMessage('没有找到可匹配的文件！');
                return;
            }
            
            // 确认操作
            if (!confirm(`确定要创建 ${matches.length} 个页面吗？`)) {
                return;
            }
            
            showLoadingMessage(`正在批量创建 ${matches.length} 个页面...`);
            
            let successCount = 0;
            let errorCount = 0;
            
            try {
                for (const match of matches) {
                    if (match.image || match.narrator || match.characters.length > 0) {
                        await createPageFromMatch(match);
                        successCount++;
                    }
                }
                
                hideLoadingMessage();
                showSuccessMessage(`成功创建 ${successCount} 个页面！${errorCount > 0 ? ` (失败 ${errorCount} 个)` : ''}`);
                
                // 更新页面列表显示
                updatePageList();
                updateGenerateButton();
                
                // 清空当前匹配结果
                window.currentMatches = null;
                
            } catch (error) {
                hideLoadingMessage();
                showErrorMessage(`批量创建失败: ${error.message}`);
            }
        }
        
        // 从匹配结果创建单个页面
        async function createPageFromMatch(match) {
            const imageFile = match.image;
            const narratorFile = match.narrator;
            const characterFiles = match.characters || [];
            
            // 获取压缩参数
            let quality = parseFloat(document.getElementById('imageQuality').value);
            let maxWidth = parseInt(document.getElementById('maxImageWidth').value);
            
            if (document.getElementById('lowStorageMode').checked) {
                quality = Math.min(quality, 0.6);
                maxWidth = Math.min(maxWidth, 600);
            }
            
            // 处理图片
            let imageBase64 = null;
            let imageUrl = null;
            if (imageFile) {
                imageBase64 = await BookStorage.compressImageAndConvert(imageFile, maxWidth, quality);
                imageUrl = URL.createObjectURL(imageFile);
            }
            
            // 处理旁白音频
            let narratorBase64 = null;
            let narratorUrl = null;
            if (narratorFile) {
                narratorBase64 = await BookStorage.compressAudioAndConvert(narratorFile);
                narratorUrl = URL.createObjectURL(narratorFile);
            }
            
            // 处理角色音频
            const characters = [];
            for (const charData of characterFiles) {
                const charFile = charData.file;
                const charBase64 = await BookStorage.compressAudioAndConvert(charFile);
                const charUrl = URL.createObjectURL(charFile);
                
                characters.push({
                    name: `角色${charData.characterNumber}`,
                    audio: charFile,
                    audioUrl: charUrl,
                    audioBase64: charBase64
                });
            }
            
            // 创建页面对象
            const page = {
                id: Date.now() + Math.random(), // 确保唯一性
                image: imageFile,
                narrator: narratorFile,
                characters: characters,
                text: `页面 ${match.pageNumber} - ${imageFile ? imageFile.name.replace(/\.[^/.]+$/, '') : '无图片'}`,
                imageUrl: imageUrl,
                narratorUrl: narratorUrl,
                imageBase64: imageBase64,
                narratorBase64: narratorBase64
            };
            
            pages.push(page);
            return page;
        }
        
        // 关闭匹配预览
        function closeMatchPreview() {
            const modal = document.getElementById('matchPreviewModal');
            if (modal) {
                modal.remove();
            }
            window.currentMatches = null;
        }


        // =============== 预置绘本导出功能 ===============
        
        // 导出为预置绘本
        async function exportAsPresetBook(bookId) {
            const book = BookStorage.getById(bookId);
            if (!book) {
                showErrorMessage('绘本不存在！');
                return;
            }
            
            try {
                showLoadingMessage('正在准备导出文件...');
                
                // 生成绘本ID（使用故事名称的拼音或英文）
                const bookIdClean = generateBookId(book.title);
                
                // 创建ZIP文件
                const zip = new JSZip();
                
                // 生成绘本数据JSON
                const bookData = generateBookData(book, bookIdClean);
                zip.file(`${bookIdClean}/book-data.json`, JSON.stringify(bookData, null, 2));
                
                // 处理图片文件
                await processImages(zip, book, bookIdClean);
                
                // 处理音频文件
                await processAudio(zip, book, bookIdClean);
                
                // 生成ZIP文件
                const zipBlob = await zip.generateAsync({type: "blob"});
                
                // 下载ZIP文件
                downloadZipFile(zipBlob, `${bookIdClean}.zip`);
                
                hideLoadingMessage();
                showSuccessMessage(`预置绘本导出成功！文件名：${bookIdClean}.zip`);
                
            } catch (error) {
                hideLoadingMessage();
                showErrorMessage(`导出失败: ${error.message}`);
            }
        }
        
        // 生成绘本ID（清理标题，用于文件名）
        function generateBookId(title) {
            return title
                .replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '') // 只保留中文、英文、数字
                .replace(/\s+/g, '-') // 空格替换为连字符
                .toLowerCase();
        }
        
        // 生成绘本数据JSON
        function generateBookData(book, bookId) {
            return {
                id: bookId,
                title: book.title,
                description: book.description || `${book.title} - 一个精彩的绘本故事`,
                author: book.author || '绘本智能体',
                createdAt: book.createdDate || new Date().toISOString().split('T')[0],
                pages: book.pages.map((page, index) => ({
                    id: index + 1,
                    image: `./images/page${index + 1}.jpg`,
                    narrator: `./audio/p${index + 1}.mp3`,
                    characters: page.characters.map((char, charIndex) => ({
                        name: char.name,
                        audio: `./audio/${index + 1}-${charIndex + 1}.mp3`
                    })),
                    text: page.text || `第${index + 1}页内容`
                }))
            };
        }
        
        // 处理图片文件
        async function processImages(zip, book, bookId) {
            const imagesFolder = zip.folder(`${bookId}/images`);
            
            // 添加封面图片
            if (book.coverImage) {
                const coverBlob = BookStorage.base64ToBlob(book.coverImage);
                imagesFolder.file('cover.jpg', coverBlob);
            }
            
            // 添加页面图片
            book.pages.forEach((page, index) => {
                if (page.imageBase64) {
                    const imageBlob = BookStorage.base64ToBlob(page.imageBase64);
                    imagesFolder.file(`page${index + 1}.jpg`, imageBlob);
                }
            });
        }
        
        // 处理音频文件
        async function processAudio(zip, book, bookId) {
            const audioFolder = zip.folder(`${bookId}/audio`);
            
            // 添加旁白音频
            book.pages.forEach((page, index) => {
                if (page.narratorBase64) {
                    const audioBlob = BookStorage.base64ToBlob(page.narratorBase64);
                    audioFolder.file(`p${index + 1}.mp3`, audioBlob);
                }
            });
            
            // 添加角色音频
            book.pages.forEach((page, pageIndex) => {
                page.characters.forEach((char, charIndex) => {
                    if (char.audioBase64) {
                        const audioBlob = BookStorage.base64ToBlob(char.audioBase64);
                        audioFolder.file(`${pageIndex + 1}-${charIndex + 1}.mp3`, audioBlob);
                    }
                });
            });
        }
        
        // 下载ZIP文件
        function downloadZipFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // =============== 页面管理 ===============
        let isAddingPage = false; // 防止重复添加页面的标志
        
        async function addPage() {
            // 防止重复点击
            if (isAddingPage) {
                console.log('正在添加页面中，请稍候...');
                return;
            }
            
            const imageIndex = document.getElementById('pageImage').value;
            const narratorIndex = document.getElementById('pageNarrator').value;
            const text = document.getElementById('pageText').value;
            const pageType = document.getElementById('pageType').value;

            if (imageIndex === '') {
                alert('请选择背景图片！');
                return;
            }

            if (narratorIndex === '' && characterConfigs.filter(c => c.audioIndex !== '').length === 0) {
                alert('请至少选择旁白音频或配置一个角色音频！');
                return;
            }
            
            isAddingPage = true;

            const imageFile = imageFiles[parseInt(imageIndex)];
            const narratorFile = narratorIndex !== '' ? narratorFiles[parseInt(narratorIndex)] : null;

            try {
                // 显示加载提示
                showLoadingMessage('正在处理文件...');

                // 获取用户选择的压缩参数（保留压缩功能以提升性能）
                let quality = parseFloat(document.getElementById('imageQuality').value);
                let maxWidth = parseInt(document.getElementById('maxImageWidth').value);
                
                // 如果开启低存储模式，使用极致压缩设置
                if (document.getElementById('lowStorageMode').checked) {
                    quality = Math.min(quality, 0.6);
                    maxWidth = Math.min(maxWidth, 600);
                    console.log('🗜️ 低存储模式已启用，使用极致压缩设置');
                }
                
                console.log(`处理文件 - 图片: ${imageFile.name}, 旁白: ${narratorFile?.name || '无'}`);
                
                // 使用压缩功能转换文件为Base64
                const imageBase64 = await BookStorage.compressImageAndConvert(imageFile, maxWidth, quality);
                let narratorBase64 = null;
                let narratorUrl = null;
                
                if (narratorFile) {
                    narratorBase64 = await BookStorage.compressAudioAndConvert(narratorFile);
                    narratorUrl = URL.createObjectURL(narratorFile);
                }

                // 处理角色音频
                const characters = [];
                for (const config of characterConfigs) {
                    if (config.audioIndex !== '') {
                        const characterFile = characterFiles[parseInt(config.audioIndex)];
                        if (characterFile) {
                            const characterBase64 = await BookStorage.compressAudioAndConvert(characterFile);
                            characters.push({
                                id: config.id,
                                name: config.name,
                                order: config.order,
                                audioUrl: URL.createObjectURL(characterFile),
                                audioBase64: characterBase64
                            });
                        }
                    }
                }

                console.log(`图片文件大小: ${(imageFile.size/1024).toFixed(2)}KB, 旁白大小: ${narratorFile ? (narratorFile.size/1024).toFixed(2) + 'KB' : '无'}, 角色数量: ${characters.length}`);

                const page = {
                    id: Date.now(),
                    image: imageFile,
                    narrator: narratorFile,
                    characters: characters,
                    text: text,
                    pageType: pageType,
                    imageUrl: URL.createObjectURL(imageFile),
                    narratorUrl: narratorUrl,
                    // 存储原始文件的Base64数据用于持久化
                    imageBase64: imageBase64,
                    narratorBase64: narratorBase64
                };

                pages.push(page);
                updatePageList();
                clearForm();
                updateGenerateButton();
                
                // 隐藏加载提示
                hideLoadingMessage();
                
                // 重新获取存储信息显示最新的剩余空间
                const finalStorageInfo = BookStorage.getStorageInfo();
                showSuccessMessage(`页面添加成功！剩余存储空间: ${finalStorageInfo.remainingSpaceMB}MB`);
                
            } catch (error) {
                console.error('添加页面失败:', error);
                hideLoadingMessage();
                
                // 判断是否是存储空间不足的错误，显示相应的提示
                const isStorageError = error.message && error.message.includes('存储空间不足');
                const isFileSizeError = error.message && error.message.includes('文件过大');
                
                console.log('错误类型判断:', {
                    错误消息: error.message,
                    是存储错误: isStorageError,
                    是文件大小错误: isFileSizeError
                });
                
                if (isStorageError) {
                    showErrorMessage(error.message, true); // 显示带删除按钮的错误提示
                } else {
                    showErrorMessage(error.message || '文件处理失败，请重试！');
                }
            } finally {
                // 重置添加状态标志
                isAddingPage = false;
            }
        }

        function clearForm() {
            const pageImage = document.getElementById('pageImage');
            const pageNarrator = document.getElementById('pageNarrator');
            const pageText = document.getElementById('pageText');
            const pageType = document.getElementById('pageType');
            
            if (pageImage) pageImage.value = '';
            if (pageNarrator) pageNarrator.value = '';
            if (pageText) pageText.value = '';
            if (pageType) pageType.value = 'public'; // 重置为默认的公共页
            
            // 清空角色配置
            characterConfigs = [];
            renderCharacterConfigs();
        }

        function clearBookInfoForm() {
            // 重置绘本基本信息表单
            const bookTitle = document.getElementById('bookTitle');
            const bookAuthor = document.getElementById('bookAuthor');
            const bookDescription = document.getElementById('bookDescription');
            
            if (bookTitle) {
                bookTitle.value = '绘本作品';
                validateBookTitle(); // 更新字符计数
            }
            if (bookAuthor) {
                bookAuthor.value = '绘本智能体';
            }
            if (bookDescription) {
                bookDescription.value = '';
                updateDescriptionPlaceholder(); // 更新占位符和字符计数
            }
        }

        function updatePageList() {
            const pageList = document.getElementById('pageList');
            const emptyMessage = document.getElementById('emptyMessage');
            
            if (!pageList || !emptyMessage) return;
            
            // 移除所有现有的页面项，但保留标题和空消息
            const existingItems = pageList.querySelectorAll('.page-item, .page-items-container');
            existingItems.forEach(item => item.remove());
            
            console.log(`页面列表更新开始：准备显示 ${pages.length} 个页面`);
            
            if (pages.length === 0) {
                emptyMessage.style.display = 'block';
                document.getElementById('batchActions').style.display = 'none';
                console.log('页面列表为空，显示空消息');
                return;
            }
            
            emptyMessage.style.display = 'none';
            document.getElementById('batchActions').style.display = 'block';
            
            // 使用文档片段来批量创建页面项，避免多次DOM操作
            const fragment = document.createDocumentFragment();
            
            // 生成所有页面项
            pages.forEach((page, index) => {
                const pageItem = document.createElement('div');
                pageItem.className = 'page-item';
                
                const characterInfo = page.characters && page.characters.length > 0 
                    ? ` | 角色: ${page.characters.map(c => c.name).join(', ')}` 
                    : '';
                
                const pageTypeInfo = page.pageType === 'interactive' ? ' | 类型: 互动选项页 (仅选项访问)' : ' | 类型: 公共页';
                const pageTypeIcon = page.pageType === 'interactive' ? '🎯' : '📄';
                const accessInfo = page.pageType === 'interactive' ? ' | 仅通过选项跳转访问' : '';
                
                // 生成选项信息
                let optionsInfo = '';
                if (page.options && page.options.length > 0) {
                    const optionsList = page.options.map((option, optIndex) => {
                        const targetPageNum = option.targetPage; // targetPage已经是1-based页码
                        return `选项${optIndex + 1}: "${option.text}" → 跳转到页面${targetPageNum}`;
                    }).join('<br>');
                    optionsInfo = `<br><div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #007bff;"><strong>🎯 互动选项：</strong><br>${optionsList}</div>`;
                } else if (page.pageType === 'interactive') {
                    optionsInfo = `<br><div style="margin-top: 8px; padding: 8px; background: #e8f5e8; border-radius: 4px; border-left: 3px solid #28a745;"><strong>📖 答案承载页</strong><br>此页面用于承载前一页互动选项的答案内容</div>`;
                }
                
                pageItem.innerHTML = `
                    <div class="page-info">
                        <strong>${pageTypeIcon} 页面 ${index + 1}:</strong> ${page.text && page.text.trim() ? (page.text.substring(0, 50) + (page.text.length > 50 ? '...' : '')) : '无文字内容'}
                        <br><small>图片: ${page.image?.name || '未知'} | 旁白: ${page.narrator?.name || '无'}${characterInfo}${pageTypeInfo}</small>
                        ${page.pageType === 'interactive' ? '<br><small style="color: #ff6b6b; font-weight: bold;">⚠️ 此页面仅可通过选项跳转访问，不会在顺序播放中出现</small>' : ''}
                        ${optionsInfo}
                    </div>
                    <div class="page-actions">
                <button onclick="editPageOptions(${index})">编辑类型和选项</button>
                <button onclick="removePage(${index})">删除</button>
            </div>
                `;
                fragment.appendChild(pageItem);
            });
            
            // 一次性添加所有页面项
            pageList.appendChild(fragment);
            
            console.log(`页面列表更新完成：成功显示 ${pages.length} 个页面`);
            
            // 验证DOM中的页面项数量
            const actualItems = pageList.querySelectorAll('.page-item');
            console.log(`DOM验证：实际显示 ${actualItems.length} 个页面项`);
            
            if (actualItems.length !== pages.length) {
                console.error(`页面显示不匹配！预期：${pages.length}，实际：${actualItems.length}`);
            }
        }

        function removePage(index) {
            URL.revokeObjectURL(pages[index].imageUrl);
            URL.revokeObjectURL(pages[index].audioUrl);
            pages.splice(index, 1);
            updatePageList();
            updateGenerateButton();
        }

        function updateGenerateButton() {
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) {
                generateBtn.disabled = pages.length === 0;
            }
        }

        // 批量优化所有页面
        async function optimizeAllPages() {
            if (pages.length === 0) {
                showErrorMessage('没有页面需要优化！');
                return;
            }

            if (!confirm(`确定要重新压缩所有 ${pages.length} 个页面吗？这将使用当前的压缩设置。`)) {
                return;
            }

            try {
                showLoadingMessage(`正在重新压缩 ${pages.length} 个页面...`);
                
                // 获取当前压缩参数
                const lowStorageMode = document.getElementById('lowStorageMode').checked;
                let quality = parseFloat(document.getElementById('imageQuality').value);
                let maxWidth = parseInt(document.getElementById('maxImageWidth').value);
                
                // 如果开启低存储模式，使用极致压缩设置
                if (lowStorageMode) {
                    quality = 0.6;
                    maxWidth = 600;
                }
                
                let optimizedCount = 0;
                let totalSavedSize = 0;

                for (let i = 0; i < pages.length; i++) {
                    const page = pages[i];
                    
                    if (page.image) {
                        const originalBase64 = page.imageBase64;
                        const originalSize = originalBase64 ? new Blob([originalBase64]).size : 0;
                        
                        // 重新压缩图片
                        const newImageBase64 = await BookStorage.compressImageAndConvert(page.image, maxWidth, quality);
                        const newSize = new Blob([newImageBase64]).size;
                        
                        page.imageBase64 = newImageBase64;
                        page.imageUrl = URL.createObjectURL(page.image); // 重新创建URL
                        
                        const savedSize = originalSize - newSize;
                        if (savedSize > 0) {
                            totalSavedSize += savedSize;
                            optimizedCount++;
                        }
                        
                        console.log(`页面 ${i + 1} 图片优化: 原大小 ${(originalSize/1024).toFixed(1)}KB -> 新大小 ${(newSize/1024).toFixed(1)}KB`);
                    }
                }

                hideLoadingMessage();
                
                if (optimizedCount > 0) {
                    showSuccessMessage(`优化完成！${optimizedCount} 个页面已重新压缩，节省约 ${(totalSavedSize/1024).toFixed(1)}KB 存储空间。`);
                } else {
                    showSuccessMessage('优化完成！所有页面已处理。');
                }
                
                // 刷新页面列表
                updatePageList();
                
            } catch (error) {
                console.error('批量优化失败:', error);
                hideLoadingMessage();
                showErrorMessage('批量优化失败: ' + (error.message || '未知错误'));
            }
        }

        // =============== 绘本生成和保存 ===============
        async function generateBook() {
            if (pages.length === 0) {
                alert('请至少添加一个页面！');
                return;
            }
            
            try {
                // 显示加载提示
                showLoadingMessage('正在生成绘本...');
                
                // 获取用户输入的绘本信息
                const bookTitleInput = document.getElementById('bookTitle');
                const bookAuthorInput = document.getElementById('bookAuthor');
                const bookDescriptionInput = document.getElementById('bookDescription');
                
                const bookTitle = bookTitleInput ? bookTitleInput.value.trim() : '绘本作品';
                const bookAuthor = bookAuthorInput ? bookAuthorInput.value.trim() : '绘本智能体';
                const bookDescription = bookDescriptionInput ? bookDescriptionInput.value.trim() : `包含 ${pages.length} 页的精美绘本`;
                
                const finalBookTitle = bookTitle || '绘本作品'; // 如果为空则使用默认名称
                const finalBookAuthor = bookAuthor || '绘本智能体'; // 如果为空则使用默认作者
                const finalBookDescription = bookDescription || `包含 ${pages.length} 页的精美绘本`; // 如果为空则使用默认简介
                
                // 创建绘本对象（仅在当前会话中保存）
                const bookData = {
                    title: finalBookTitle,
                    author: finalBookAuthor,
                    description: finalBookDescription,
                    coverImage: pages[0]?.imageBase64, // 使用Base64作为封面
                    pages: pages.map(page => ({
                        imageBase64: page.imageBase64,     // Base64图片数据
                        narratorBase64: page.narratorBase64, // Base64旁白音频数据
                        text: page.text,
                        pageType: page.pageType || 'public', // 页面类型
                        // 保留URL用于当前会话
                        imageUrl: page.imageUrl,
                        narratorUrl: page.narratorUrl,
                        // 角色数据
                        characters: page.characters || [],
                        // 页面选项数据
                        options: page.options || []
                    }))
                };
                
                // 创建绘本并添加到当前会话
                const savedBook = BookStorage.save(bookData);
                savedBooks.push(savedBook);
                
                // 隐藏加载提示
                hideLoadingMessage();
                
                // 显示成功提示
                showSuccessMessage(`绘本《${finalBookTitle}》创建成功！已添加到当前会话 (共 ${savedBooks.length} 本绘本)`);
                
                // 等待一下再切换标签页，让用户看到成功消息
                setTimeout(() => {
                    // 切换回绘本库页面
                    AppState.switchTab('library');
                    
                    // 清空创建表单
                    resetCreateForm();
                }, 2000);
            } catch (error) {
                console.error('生成绘本失败:', error);
                hideLoadingMessage();
                showErrorMessage(error.message || '绘本生成失败，请重试！');
            }
        }

        function resetCreateForm() {
            // 清空文件数组
            narratorFiles = [];
            characterFiles = [];
            imageFiles = [];
            pages = [];
            characterConfigs = [];
            
            // 更新UI
            updateNarratorList();
            updateCharacterList();
            updateImageList();
            updatePageList();
            updateSelects();
            updateCharacterSelects();
            renderCharacterConfigs();
            updateGenerateButton();
            
            // 清空表单
            clearForm();
            clearBookInfoForm();
        }

        // =============== 音频控制 ===============
        function playCurrentPage() {
    // 优先使用window.pages，如果不存在则使用pages
    const pagesData = window.pages || pages;
    const currentPageData = pagesData[currentPage];
    
    console.log('playCurrentPage 被调用');
    console.log('currentPage:', currentPage);
    console.log('currentPageData:', currentPageData);
    console.log('页面类型:', currentPageData && currentPageData.pageType ? currentPageData.pageType : '未设置');
    console.log('页面是否有选项:', currentPageData && currentPageData.options ? currentPageData.options : '无选项');
    console.log('选项详情:', currentPageData && currentPageData.options ? JSON.stringify(currentPageData.options, null, 2) : '无选项数据');
    
    if (currentPageData) {
        // 停止当前播放
        if (currentAudioSequence) {
            currentAudioSequence.stop();
        }
        
        // 创建新的音频序列播放器
        currentAudioSequence = new AudioSequencePlayer(currentPageData);
        
        // 设置播放完成回调
        currentAudioSequence.onComplete = () => {
            console.log('音频播放完成回调被触发');
            isPlaying = false;
            updatePlayButton();
            
            // 重新获取当前页面数据，确保是最新的
            const pagesData = window.pages || pages;
            const latestPageData = pagesData[currentPage];
            
            console.log('音频播放完成，当前页面索引:', currentPage);
            console.log('最新页面数据:', latestPageData);
            console.log('页面类型:', latestPageData && latestPageData.pageType ? latestPageData.pageType : '未设置');
            console.log('页面选项:', latestPageData && latestPageData.options ? latestPageData.options : '无选项');
            
            // 检查是否是从选项跳转来的
            if (window.isOptionJump) {
                console.log('从选项跳转来的页面，等待播放完成后显示选项');
                // 如果是互动页面且有选项，显示选项
                if (latestPageData && latestPageData.pageType === 'interactive' && latestPageData.options && latestPageData.options.length > 0) {
                    console.log('选项跳转到的互动页面，显示选项');
                    showPageOptions(latestPageData);
                }
                return;
            }
            
            // 根据页面类型决定播放逻辑
            if (latestPageData && latestPageData.pageType === 'interactive') {
                // 互动选项页：必须等待用户选择选项
                if (latestPageData.options && latestPageData.options.length > 0) {
                    console.log('互动选项页：显示页面选项，选项数量：', latestPageData.options.length);
                    showPageOptions(latestPageData);
                } else {
                    console.log('互动选项页但没有选项，继续播放下一个公共页面');
                    // 继续播放下一个公共页面
                    const nextPublicPage = findNextPublicPage(currentPage + 1);
                    if (nextPublicPage !== -1) {
                        console.log('跳转到下一个公共页面:', nextPublicPage);
                        currentPage = nextPublicPage;
                        if (bookReader) {
                            bookReader.goToPage(nextPublicPage);
                        }
                        // 递归调用播放新页面
                        setTimeout(() => playCurrentPage(), 500);
                    } else {
                        console.log('没有更多公共页面，播放结束');
                        showEndMessage();
                    }
                }
            } else {
                // 公共页：按顺序播放
                if (latestPageData && latestPageData.options && latestPageData.options.length > 0) {
                    console.log('公共页但有选项：显示页面选项，选项数量：', latestPageData.options.length);
                    showPageOptions(latestPageData);
                } else if (autoPlay) {
                    // 继续播放下一个公共页面
                    const nextPublicPage = findNextPublicPage(currentPage + 1);
                    if (nextPublicPage !== -1) {
                        console.log('公共页：自动播放下一个公共页面');
                        currentPage = nextPublicPage;
                        if (bookReader) {
                            bookReader.goToPage(nextPublicPage);
                        }
                        // 递归调用播放新页面
                        setTimeout(() => playCurrentPage(), 500);
                    } else {
                        console.log('公共页：已经是最后一个公共页面，播放结束');
                        // 可以在这里添加播放结束的提示
                        showEndMessage();
                    }
                } else {
                    console.log('公共页：没有选项且不自动翻页');
                }
            }
        };
        
        // 开始播放
        currentAudioSequence.play();
        isPlaying = true;
        updatePlayButton();
    }
}

        function togglePlay() {
            if (isPlaying) {
                if (currentAudioSequence) {
                    currentAudioSequence.pause();
                }
                isPlaying = false;
            } else {
                if (currentAudioSequence) {
                    currentAudioSequence.resume();
                    isPlaying = true;
                } else {
                    playCurrentPage();
                }
            }
            updatePlayButton();
        }

        function pauseAudio() {
            if (currentAudioSequence) {
                currentAudioSequence.stop();
            }
            isPlaying = false;
            updatePlayButton();
        }

        function updatePlayButton() {
            const playBtn = document.getElementById('playBtn');
            if (playBtn) {
                playBtn.textContent = isPlaying ? '⏸️' : '▶️';
            }
        }

        function toggleAutoPlay() {
            autoPlay = !autoPlay;
            const autoPlayBtn = document.getElementById('autoPlayBtn');
            if (autoPlayBtn) {
                autoPlayBtn.textContent = autoPlay ? '自动播放: 开' : '自动播放: 关';
                autoPlayBtn.classList.toggle('active', autoPlay);
            }
        }

        // =============== 阅读器控制 ===============
        function closeBook() {
            document.getElementById('bookReader').style.display = 'none';
            pauseAudio();
            AppState.isReading = false;
            AppState.currentBook = null;
        }

        function prevPage() {
            if (bookReader) {
                pauseAudio();
                
                // 检查目标页面是否有选项
                const targetPageIndex = Math.max(0, bookReader.currentSpread - 1);
                if (checkTargetPageHasOptions(targetPageIndex)) {
                    // 如果目标页面有选项，直接显示选项而不翻页
                    showPageOptionsForTargetPage(targetPageIndex);
                    return;
                }
                
                bookReader.prevSpread();
                
                // 翻页后检查是否需要显示选项
                setTimeout(() => {
                    checkAndShowPageOptions();
                }, 500);
            }
        }

        function nextPage() {
            if (bookReader) {
                pauseAudio();
                
                // 检查目标页面是否有选项
                const targetPageIndex = Math.min((window.pages || pages).length - 1, bookReader.currentSpread + 1);
                if (checkTargetPageHasOptions(targetPageIndex)) {
                    // 如果目标页面有选项，直接显示选项而不翻页
                    showPageOptionsForTargetPage(targetPageIndex);
                    return;
                }
                
                bookReader.nextSpread();
                
                // 翻页后检查是否需要显示选项
                setTimeout(() => {
                    checkAndShowPageOptions();
                }, 500);
            }
        }

        // 检查并显示页面选项（用于手动翻页）
        function checkAndShowPageOptions() {
            const pagesData = window.pages || pages;
            if (!pagesData || pagesData.length === 0) return;
            
            // 获取当前页面索引
            const currentPageIndex = bookReader ? bookReader.currentSpread : currentPage;
            const currentPageData = pagesData[currentPageIndex];
            
            if (!currentPageData) return;
            
            console.log('检查页面选项:', currentPageIndex, currentPageData);
            
            // 如果当前页面有选项，显示选项
            if (currentPageData.options && currentPageData.options.length > 0) {
                console.log('手动翻页发现页面选项，显示选项');
                showPageOptions(currentPageData);
            }
        }
        
        // 检查目标页面是否有选项
        function checkTargetPageHasOptions(targetPageIndex) {
            const pagesData = window.pages || pages;
            if (!pagesData || pagesData.length === 0) return false;
            
            const targetPageData = pagesData[targetPageIndex];
            if (!targetPageData) return false;
            
            return targetPageData.options && targetPageData.options.length > 0;
        }
        
        // 显示目标页面的选项（不执行翻页）
        function showPageOptionsForTargetPage(targetPageIndex) {
            const pagesData = window.pages || pages;
            if (!pagesData || pagesData.length === 0) return;
            
            const targetPageData = pagesData[targetPageIndex];
            if (!targetPageData) return;
            
            console.log('手动翻页检测到目标页面有选项，直接显示选项:', targetPageIndex, targetPageData);
            showPageOptions(targetPageData);
        }

        // 查找下一个公共页面
        function findNextPublicPage(startIndex) {
            const pagesData = window.pages || pages;
            for (let i = startIndex; i < pagesData.length; i++) {
                const page = pagesData[i];
                if (page && page.pageType !== 'interactive') {
                    console.log(`找到下一个公共页面: ${i + 1}`);
                    return i;
                }
            }
            return -1; // 没有找到公共页面
        }

        // 显示播放结束消息
        function showEndMessage() {
            // 创建结束动画容器
            const endContainer = document.createElement('div');
            endContainer.id = 'bookEndContainer';
            endContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.8s ease-in-out;
            `;
            
            // 添加CSS动画
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; transform: scale(0.8); }
                    to { opacity: 1; transform: scale(1); }
                }
                @keyframes slideUp {
                    from { transform: translateY(50px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
                @keyframes pulse {
                    0%, 100% { transform: scale(1); }
                    50% { transform: scale(1.05); }
                }
            `;
            document.head.appendChild(style);
            
            // 创建结束内容
            const endContent = document.createElement('div');
            endContent.style.cssText = `
                text-align: center;
                color: white;
                animation: slideUp 1s ease-out 0.3s both;
            `;
            
            // 结束图标
            const endIcon = document.createElement('div');
            endIcon.innerHTML = '🎉';
            endIcon.style.cssText = `
                font-size: 80px;
                margin-bottom: 20px;
                animation: pulse 2s infinite;
            `;
            
            // 结束标题
            const endTitle = document.createElement('h1');
            endTitle.textContent = '故事结束，谢谢观看！';
            endTitle.style.cssText = `
                font-size: 36px;
                margin: 0 0 30px 0;
                font-weight: bold;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            `;
            
            // 关闭按钮
            const closeButton = document.createElement('button');
            closeButton.textContent = '关闭';
            closeButton.style.cssText = `
                background: rgba(255, 255, 255, 0.2);
                border: 2px solid white;
                color: white;
                padding: 12px 30px;
                font-size: 16px;
                border-radius: 25px;
                cursor: pointer;
                transition: all 0.3s ease;
                backdrop-filter: blur(10px);
            `;
            
            closeButton.onmouseover = () => {
                closeButton.style.background = 'rgba(255, 255, 255, 0.3)';
                closeButton.style.transform = 'scale(1.05)';
            };
            
            closeButton.onmouseout = () => {
                closeButton.style.background = 'rgba(255, 255, 255, 0.2)';
                closeButton.style.transform = 'scale(1)';
            };
            
            closeButton.onclick = () => {
                document.body.removeChild(endContainer);
                document.head.removeChild(style);
                
                // 关闭阅读器并切换到绘本库
                closeBook();
                AppState.switchTab('library');
            };
            
            // 组装内容
            endContent.appendChild(endIcon);
            endContent.appendChild(endTitle);
            endContent.appendChild(closeButton);
            endContainer.appendChild(endContent);
            
            // 添加到页面
            document.body.appendChild(endContainer);
        }

        function toggleFullscreen() {
            const bookReader = document.getElementById('bookReader');
            
            if (!document.fullscreenElement) {
                bookReader.requestFullscreen().catch(err => {
                    console.log('无法进入全屏模式:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // =============== 消息提示 ===============
        function showSuccessMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.className = 'success-message';
            messageEl.innerHTML = `
                <i class="fas fa-check-circle"></i>
                ${message}
            `;
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.parentNode.removeChild(messageEl);
                }
            }, 3000);
        }

        function showErrorMessage(message, showDeleteBtn = false) {
            const messageEl = document.createElement('div');
            messageEl.className = 'error-message';
            
            let deleteButtonHTML = '';
            if (showDeleteBtn) {
                deleteButtonHTML = `
                    <div style="margin-top: 10px;">
                        <button onclick="AppState.switchTab('library'); this.parentElement.parentElement.remove();" 
                                style="background: #fff; color: #dc3545; border: 1px solid #fff; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            前往删除绘本
                        </button>
                        <button onclick="this.parentElement.parentElement.remove();" 
                                style="background: transparent; color: #fff; border: 1px solid #fff; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                            我知道了
                        </button>
    </div>
                `;
            }
            
            messageEl.innerHTML = `
                <i class="fas fa-exclamation-circle"></i>
                ${message}
                ${deleteButtonHTML}
            `;
            
            document.body.appendChild(messageEl);
            
            // 如果有删除按钮，延长显示时间；否则3秒后自动消失
            const autoHideTime = showDeleteBtn ? 8000 : 3000;
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.parentNode.removeChild(messageEl);
                }
            }, autoHideTime);
        }

        function showLoadingMessage(message) {
            // 移除已存在的加载提示
            const existingLoading = document.querySelector('.loading');
            if (existingLoading) {
                existingLoading.remove();
            }
            
            const loadingEl = document.createElement('div');
            loadingEl.className = 'loading';
            loadingEl.innerHTML = `
                <i class="fas fa-spinner fa-spin"></i>
                <div style="margin-top: 10px;">${message}</div>
            `;
            
            document.body.appendChild(loadingEl);
        }

        function hideLoadingMessage() {
            const loadingEl = document.querySelector('.loading');
            if (loadingEl) {
                loadingEl.remove();
            }
        }

        // =============== 音频播放完成事件 ===============
        // (音频播放事件监听器已移至 initializeAudioEvents 函数中)

        // =============== 键盘控制 ===============
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('bookReader').style.display === 'block') {
                switch(e.key) {
                    case 'ArrowLeft':
                        prevPage();
                        break;
                    case 'ArrowRight':
                        nextPage();
                        break;
                    case ' ':
                        e.preventDefault();
                        togglePlay();
                        break;
                    case 'Escape':
                        closeBook();
                        break;
                    case 'f':
                    case 'F':
                        toggleFullscreen();
                        break;
                }
            }
        });

        // =============== 会话管理 ===============
        function clearCurrentSession() {
            if (confirm('确定要清空当前会话的所有绘本吗？')) {
                savedBooks = [];
                showSuccessMessage('当前会话已清空！');
                AppState.refreshLibrary();
                console.log('🗑️ 当前会话已清空');
            }
        }

        // =============== 页面选项编辑功能 ================
function editPageOptions(pageIndex) {
    // 创建模态窗口
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>编辑页面类型和选项 - 页面 ${pageIndex + 1}</h3>
                <button onclick="document.body.removeChild(this.parentElement.parentElement.parentElement)">×</button>
            </div>
            <div class="modal-body">
                <!-- 页面类型选择 -->
                <div class="input-group" style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 8px; border: 2px solid #dee2e6;">
                    <label for="editPageType" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333; font-size: 16px;">
                        📄 页面类型
                    </label>
                    <select id="editPageType" style="width: 100%; padding: 10px; border: 2px solid #4A90E2; border-radius: 6px; font-size: 14px; background: white; transition: border-color 0.3s ease;" onchange="updatePageTypeDescription()">
                        <option value="public">📄 公共页 - 按顺序播放</option>
                        <option value="interactive">🎯 互动选项页 - 基于选项播放</option>
                    </select>
                    <small id="pageTypeDescription" style="display: block; margin-top: 8px; color: #666; font-style: italic;">
                        公共页：按页面顺序自动播放，适合线性故事
                    </small>
                </div>
                
                <!-- 选项配置 -->
                <div class="input-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                        🎯 页面选项配置
                    </label>
                <div id="optionsContainer">
                    <!-- 选项将在这里动态生成 -->
                </div>
                    <button id="addOptionBtn" class="btn-primary" style="margin-top: 10px;">添加选项</button>
                    <small id="optionsDescription" style="display: block; margin-top: 8px; color: #666; font-style: italic;">
                        公共页可以设置选项，互动选项页通常不需要设置选项（作为答案承载页）
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="savePageOptions(${pageIndex})" style="background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                    <i class="fas fa-save"></i> 保存并继续编辑
                </button>
                <button onclick="savePageOptionsAndClose(${pageIndex})" style="background: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                    <i class="fas fa-check"></i> 保存并关闭
                </button>
                <button onclick="document.body.removeChild(this.parentElement.parentElement.parentElement)" style="background: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-times"></i> 取消
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // 加载现有选项（如果有）
    loadPageOptions(pageIndex);
    
    // 初始化页面类型描述
    updatePageTypeDescription();
    
    // 添加选项按钮事件监听
    document.getElementById('addOptionBtn').addEventListener('click', function() {
        addOption(pageIndex);
    });
}

// 更新页面类型描述
function updatePageTypeDescription() {
    const pageTypeSelect = document.getElementById('editPageType');
    const description = document.getElementById('pageTypeDescription');
    const optionsDescription = document.getElementById('optionsDescription');
    
    if (pageTypeSelect && description) {
        if (pageTypeSelect.value === 'interactive') {
            description.textContent = '互动选项页：作为答案承载页，仅通过选项跳转访问，不参与顺序播放';
            if (optionsDescription) {
                optionsDescription.textContent = '互动选项页通常不需要设置选项，它作为前一页选项的答案承载页';
                optionsDescription.style.color = '#28a745';
            }
        } else {
            description.textContent = '公共页：按页面顺序自动播放，适合线性故事';
            if (optionsDescription) {
                optionsDescription.textContent = '公共页可以设置选项，互动选项页通常不需要设置选项（作为答案承载页）';
                optionsDescription.style.color = '#666';
            }
        }
    }
}

function loadPageOptions(pageIndex) {
    const page = pages[pageIndex];
    const optionsContainer = document.getElementById('optionsContainer');
    const pageTypeSelect = document.getElementById('editPageType');
    
    // 加载页面类型
    if (pageTypeSelect && page.pageType) {
        pageTypeSelect.value = page.pageType;
    } else if (pageTypeSelect) {
        pageTypeSelect.value = 'public'; // 默认为公共页
    }
    
    // 清空容器
    optionsContainer.innerHTML = '';
    
    // 加载现有选项（如果有的话）
    if (page.options && page.options.length > 0) {
    page.options.forEach((option, optionIndex) => {
        createOptionElement(pageIndex, optionIndex, option.text, option.targetPage);
    });
    }
    // 不再自动创建默认选项，让用户手动添加
}

function createOptionElement(pageIndex, optionIndex, optionText = '', targetPage = 1) {
    const optionsContainer = document.getElementById('optionsContainer');
    
    const optionElement = document.createElement('div');
    optionElement.className = 'option-item';
    optionElement.setAttribute('data-option-index', optionIndex);
    
    // 创建目标页面下拉菜单
    let pageSelectHtml = '<select class="targetPage">';
    for (let i = 1; i <= pages.length; i++) {
        const selected = i === targetPage ? 'selected' : '';
        pageSelectHtml += `<option value="${i}" ${selected}>页面 ${i}</option>`;
    }
    pageSelectHtml += '</select>';
    
    optionElement.innerHTML = `
        <div class="option-content">
            <input type="text" class="optionText" placeholder="选项文本" value="${optionText}">
            <span>跳转到：</span>
            ${pageSelectHtml}
        </div>
        <button class="delete-option-btn" onclick="deleteOption(${pageIndex}, ${optionIndex})">&times;</button>
    `;
    
    optionsContainer.appendChild(optionElement);
}

function addOption(pageIndex) {
    const optionsContainer = document.getElementById('optionsContainer');
    const optionIndex = optionsContainer.querySelectorAll('.option-item').length;
    
    createOptionElement(pageIndex, optionIndex);
}

function deleteOption(pageIndex, optionIndex) {
    const optionsContainer = document.getElementById('optionsContainer');
    const optionElements = optionsContainer.querySelectorAll('.option-item');
    
    if (optionElements[optionIndex]) {
        optionElements[optionIndex].remove();
        
        // 重新编号剩余选项
        updateOptionIndices();
    }
}

function updateOptionIndices() {
    const optionsContainer = document.getElementById('optionsContainer');
    const optionElements = optionsContainer.querySelectorAll('.option-item');
    
    optionElements.forEach((element, index) => {
        element.setAttribute('data-option-index', index);
        // 更新删除按钮的事件
        const deleteBtn = element.querySelector('.delete-option-btn');
        if (deleteBtn) {
            const pageIndex = parseInt(deleteBtn.onclick.toString().match(/\d+/)[0]);
            deleteBtn.onclick = function() { deleteOption(pageIndex, index); };
        }
    });
}

function savePageOptions(pageIndex) {
    const page = pages[pageIndex];
    const optionsContainer = document.getElementById('optionsContainer');
    const optionElements = optionsContainer.querySelectorAll('.option-item');
    const pageTypeSelect = document.getElementById('editPageType');
    
    // 保存页面类型
    if (pageTypeSelect) {
        page.pageType = pageTypeSelect.value;
        console.log('页面类型已更新为:', page.pageType);
    }
    
    // 初始化选项数组
    page.options = [];
    
    // 收集选项数据
    optionElements.forEach(element => {
        const optionText = element.querySelector('.optionText').value.trim();
        const targetPage = parseInt(element.querySelector('.targetPage').value);
        
        if (optionText) {
            page.options.push({
                text: optionText,
                targetPage: targetPage
            });
        }
    });
    
    // 同步数据到window.pages（如果存在）
    if (window.pages && window.pages[pageIndex]) {
        window.pages[pageIndex].options = JSON.parse(JSON.stringify(page.options));
        window.pages[pageIndex].pageType = page.pageType; // 同步页面类型
    }
    
    // 更新页面列表显示
    updatePageList();
    
    // 保存到当前编辑的绘本（如果存在）
    if (currentEditingBookId) {
        const currentEditingBook = BookStorage.getById(currentEditingBookId);
        if (currentEditingBook && currentEditingBook.pages && currentEditingBook.pages[pageIndex]) {
            currentEditingBook.pages[pageIndex].options = JSON.parse(JSON.stringify(page.options));
            currentEditingBook.pages[pageIndex].pageType = page.pageType;
            
            // 更新savedBooks数组中的对应绘本
            const bookIndex = savedBooks.findIndex(book => book.id === currentEditingBookId);
            if (bookIndex !== -1) {
                savedBooks[bookIndex] = currentEditingBook;
                console.log('已更新绘本中的页面选项:', currentEditingBook.title);
            }
            
            // 同步更新全局pages数组（确保页面列表显示正确）
            if (pages && pages[pageIndex]) {
                pages[pageIndex].options = JSON.parse(JSON.stringify(page.options));
                pages[pageIndex].pageType = page.pageType;
                console.log('已同步更新全局pages数组');
            }
        }
    }
    
    // 不自动关闭模态窗口，让用户可以继续编辑
    showSuccessMessage('页面选项和类型已保存！');
}

// 保存页面选项并关闭模态窗口
function savePageOptionsAndClose(pageIndex) {
    // 先保存选项
    savePageOptions(pageIndex);
    
    // 然后关闭模态窗口
    const modal = document.querySelector('.modal');
    if (modal) {
        document.body.removeChild(modal);
    }
}

// 实现showPageOptions函数
function showPageOptions(pageData) {
    console.log('showPageOptions 被调用，调用堆栈:', new Error().stack);
    
    // 检查是否存在选项
    if (!pageData.options || pageData.options.length === 0) {
        console.log('没有可显示的选项');
        return;
    }
    
    console.log('显示选项数据:', pageData.options);
    
    // 移除已存在的选项容器
    const existingOptionsContainer = document.getElementById('pageOptionsContainer');
    if (existingOptionsContainer) {
        existingOptionsContainer.remove();
    }
    
    // 创建半透明遮罩层
    const overlay = document.createElement('div');
    overlay.id = 'optionsOverlay';
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
    overlay.style.zIndex = '9998';
    overlay.style.display = 'flex';
    overlay.style.justifyContent = 'center';
    overlay.style.alignItems = 'center';
    
    // 创建选项容器
    const optionsContainer = document.createElement('div');
    optionsContainer.id = 'pageOptionsContainer';
    optionsContainer.className = 'page-options-container';
    
    // 使用CSS类样式，确保在页面中间显示
    // 不需要重置样式，直接使用CSS中定义的居中样式
    
    // 创建选项标题
    const optionsTitle = document.createElement('div');
    optionsTitle.className = 'options-title';
    optionsTitle.style.fontSize = '24px';
    optionsTitle.style.fontWeight = 'bold';
    optionsTitle.style.marginBottom = '20px';
    optionsTitle.style.color = '#333';
    optionsTitle.textContent = '请选择：';
    optionsContainer.appendChild(optionsTitle);
    
    // 创建选项按钮组
    const optionsButtons = document.createElement('div');
    optionsButtons.className = 'options-buttons';
    optionsButtons.style.display = 'flex';
    optionsButtons.style.flexDirection = 'column';
    optionsButtons.style.gap = '15px';
    
    // 为每个选项创建按钮
    pageData.options.forEach((option, index) => {
        const optionBtn = document.createElement('button');
        optionBtn.className = 'option-button';
        optionBtn.textContent = option.text;
        
        // 设置按钮样式
        optionBtn.style.padding = '18px 30px';
        optionBtn.style.fontSize = '20px';
        optionBtn.style.border = 'none';
        optionBtn.style.borderRadius = '12px';
        optionBtn.style.backgroundColor = '#4A90E2';
        optionBtn.style.color = 'white';
        optionBtn.style.cursor = 'pointer';
        optionBtn.style.transition = 'all 0.3s ease';
        optionBtn.style.minWidth = '250px';
        optionBtn.style.margin = '8px 0';
        optionBtn.style.fontWeight = '500';
        
        // 添加悬停效果
        optionBtn.onmouseover = function() {
            this.style.backgroundColor = '#357ABD';
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 8px 25px rgba(74, 144, 226, 0.4)';
        };
        optionBtn.onmouseout = function() {
            this.style.backgroundColor = '#4A90E2';
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none';
        };
        
        // 添加点击事件
        optionBtn.addEventListener('click', function() {
            handleOptionClick(option, index);
        });
        
        optionsButtons.appendChild(optionBtn);
    });
    
    optionsContainer.appendChild(optionsButtons);
    overlay.appendChild(optionsContainer);
    
    // 添加到body
    document.body.appendChild(overlay);
}

function handleOptionClick(option, optionIndex) {
    console.log('选项被点击:', option);
    
    // 停止当前播放
    pauseAudio();
    
    // 移除选项容器和遮罩层
    const optionsContainer = document.getElementById('pageOptionsContainer');
    const overlay = document.getElementById('optionsOverlay');
    
    if (optionsContainer) {
        optionsContainer.remove();
    }
    if (overlay) {
        overlay.remove();
    }
    
    // 跳转到目标页面
    if (bookReader && option.targetPage) {
        const targetPageIndex = option.targetPage - 1; // 转换为0-based索引
        console.log('跳转到页面:', targetPageIndex + 1);
        
        // 更新当前页面索引
        currentPage = targetPageIndex;
        
        // 跳转到目标页面
        bookReader.goToPage(targetPageIndex);
        
        // 重新开始播放目标页面的音频
        setTimeout(() => {
            // 恢复自动播放
            autoPlay = true;
            const autoPlayBtn = document.getElementById('autoPlayBtn');
            if (autoPlayBtn) {
                autoPlayBtn.textContent = '自动播放: 开';
                autoPlayBtn.classList.add('active');
            }
            
            // 标记这是从选项跳转来的，避免重复播放
            window.isOptionJump = true;
            
            // 播放目标页面
            playCurrentPage();
            
            // 清除跳转标记，让页面可以正常显示选项
            setTimeout(() => {
                window.isOptionJump = false;
                console.log('选项跳转完成，清除跳转标记，页面可以显示选项');
            }, 2000); // 给目标页面足够时间播放完成
        }, 500);
    } else {
        console.error('无法跳转：bookReader或targetPage不存在', {bookReader, targetPage: option.targetPage});
    }
}

        // =============== 绘本名称验证 ===============
        function validateBookTitle() {
            const bookTitleInput = document.getElementById('bookTitle');
            const charCount = document.getElementById('charCount');
            
            if (bookTitleInput && charCount) {
                const currentLength = bookTitleInput.value.length;
                charCount.textContent = `${currentLength}/50`;
                
                // 根据字符数量改变颜色
                if (currentLength > 45) {
                    charCount.style.color = '#ff6b6b';
                } else if (currentLength > 35) {
                    charCount.style.color = '#ffa726';
                } else {
                    charCount.style.color = '#999';
                }
                
                // 检查是否为空或只有空格
                if (bookTitleInput.value.trim() === '') {
                    bookTitleInput.style.borderColor = '#ff6b6b';
                    bookTitleInput.title = '绘本名称不能为空';
                } else {
                    bookTitleInput.style.borderColor = '#4CAF50';
                    bookTitleInput.title = '';
                }
            }
        }

        // =============== 绘本简介处理 ===============
        function updateDescriptionPlaceholder() {
            const descInput = document.getElementById('bookDescription');
            const descCharCount = document.getElementById('descCharCount');
            
            if (descInput && descCharCount) {
                const currentLength = descInput.value.length;
                descCharCount.textContent = `${currentLength}/200`;
                
                // 根据字符数量改变颜色
                if (currentLength > 180) {
                    descCharCount.style.color = '#ff6b6b';
                } else if (currentLength > 150) {
                    descCharCount.style.color = '#ffa726';
                } else {
                    descCharCount.style.color = '#999';
                }
                
                // 更新占位符文本
                const pageCount = pages ? pages.length : 0;
                descInput.placeholder = `请输入绘本简介（默认：包含 ${pageCount} 页的精美绘本）`;
            }
        }

        // =============== 绘本编辑功能 ===============
        function editBook(bookId) {
            const book = BookStorage.getById(bookId);
            if (!book) {
                showErrorMessage('绘本不存在！');
                return;
            }
            
            // 创建编辑模态窗口
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>编辑绘本 - ${book.title}</h3>
                        <button onclick="document.body.removeChild(this.parentElement.parentElement.parentElement)">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="book-edit-info" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h4>📖 绘本信息</h4>
                            <p><strong>标题：</strong>${book.title}</p>
                            <p><strong>作者：</strong>${book.author || '未知'}</p>
                            <p><strong>简介：</strong>${book.description || '无'}</p>
                            <p><strong>页数：</strong>${book.pages ? book.pages.length : 0} 页</p>
                        </div>
                        
                        <div class="pages-edit-section">
                            <h4>📄 页面编辑</h4>
                            <div id="editPagesList" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px;">
                                <!-- 页面列表将在这里动态生成 -->
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button onclick="saveBookEdits('${bookId}')" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-save"></i> 保存修改
                        </button>
                        <button onclick="document.body.removeChild(this.parentElement.parentElement.parentElement)" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                            取消
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 生成页面编辑列表
            generateEditPagesList(book);
        }
        
        function generateEditPagesList(book) {
            const pagesList = document.getElementById('editPagesList');
            if (!pagesList || !book.pages) return;
            
            pagesList.innerHTML = '';
            
            book.pages.forEach((page, index) => {
                const pageItem = document.createElement('div');
                pageItem.className = 'edit-page-item';
                pageItem.style.cssText = `
                    margin-bottom: 15px; 
                    padding: 15px; 
                    border: 1px solid #ddd; 
                    border-radius: 8px; 
                    background: white;
                `;
                
                const pageTypeInfo = page.pageType === 'interactive' ? '🎯 互动选项页' : '📄 公共页';
                const pageTypeColor = page.pageType === 'interactive' ? '#ff6b6b' : '#28a745';
                
                pageItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h5 style="margin: 0; color: #333;">页面 ${index + 1}</h5>
                        <span style="background: ${pageTypeColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                            ${pageTypeInfo}
                        </span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>文字内容：</strong>
                        <p style="margin: 5px 0; color: #666; font-size: 14px;">
                            ${page.text && page.text.trim() ? page.text.substring(0, 100) + (page.text.length > 100 ? '...' : '') : '无文字内容'}
                        </p>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>选项数量：</strong>
                        <span style="color: #666;">${page.options ? page.options.length : 0} 个选项</span>
                    </div>
                    <div style="text-align: right;">
                        <button onclick="editPageInBook('${book.id}', ${index})" 
                                style="background: #007bff; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            <i class="fas fa-edit"></i> 编辑页面
                        </button>
                    </div>
                `;
                
                pagesList.appendChild(pageItem);
            });
        }
        
        function editPageInBook(bookId, pageIndex) {
            const book = BookStorage.getById(bookId);
            if (!book || !book.pages || !book.pages[pageIndex]) {
                showErrorMessage('页面不存在！');
                return;
            }
            
            // 设置当前编辑的绘本ID
            currentEditingBookId = bookId;
            
            // 关闭编辑模态窗口
            const modal = document.querySelector('.modal');
            if (modal) {
                document.body.removeChild(modal);
            }
            
            // 将绘本数据加载到全局pages数组中
            pages = book.pages.map(page => ({
                ...page,
                // 确保Base64数据正确转换
                imageUrl: page.imageBase64 ? BookStorage.base64ToUrl(page.imageBase64) : page.imageUrl,
                narratorUrl: page.narratorBase64 ? BookStorage.base64ToUrl(page.narratorBase64) : page.narratorUrl
            }));
            
            // 同步到window.pages
            window.pages = pages;
            
            // 使用现有的页面编辑功能
            editPageOptions(pageIndex);
        }
        
        function saveBookEdits(bookId) {
            // 这里可以添加保存逻辑，目前页面编辑会直接保存到全局pages数组
            showSuccessMessage('绘本编辑已保存！');
            
            // 关闭模态窗口
            const modal = document.querySelector('.modal');
            if (modal) {
                document.body.removeChild(modal);
            }
            
            // 刷新绘本库显示
            AppState.renderBooksGrid();
}

// =============== LORA标注工具 ================
let loraToolData = {
    uploadedFile: null,
    segments: [],
    config: {
        separatorType: 'emptyLine',
        customSeparator: '---',
        prefix: 'cameralora_hojo',
        nameSeparator: ' ',
        startNumber: 1,
        padZero: false,
        digits: 3
    }
};

// 打开LORA标注工具
function openLoraAnnotationTool() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'loraToolModal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3><i class="fas fa-tags"></i> LORA标注工具</h3>
                <button onclick="closeLoraToolModal()">×</button>
            </div>
            <div class="modal-body">
                <!-- 文件上传区域 -->
                <div class="lora-tool-section">
                    <h4><i class="fas fa-upload"></i> 上传标注文件</h4>
                    <label class="lora-file-upload" for="loraFileInput">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #6c757d; margin-bottom: 10px;"></i>
                        <p style="margin: 0; color: #6c757d;">点击选择TXT文件或拖拽文件到此处</p>
                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">支持UTF-8和GBK编码</p>
                        <input type="file" id="loraFileInput" accept=".txt" onchange="handleLoraFileUpload(event)">
                    </label>
                    <div id="loraFileInfo" style="display: none;"></div>
                </div>

                <!-- 分隔符设置 -->
                <div class="lora-tool-section">
                    <h4><i class="fas fa-scissors"></i> 分隔符设置</h4>
                    <div class="lora-radio-group">
                        <label class="lora-radio-option">
                            <input type="radio" name="separatorType" value="emptyLine" checked onchange="updateSeparatorType('emptyLine')">
                            <span><strong>空行</strong>（连续换行符）- 推荐</span>
                        </label>
                        <label class="lora-radio-option">
                            <input type="radio" name="separatorType" value="custom" onchange="updateSeparatorType('custom')">
                            <span><strong>自定义分隔符</strong></span>
                        </label>
                        <div class="lora-input-group" id="customSeparatorInput" style="display: none; margin-top: 10px;">
                            <input type="text" id="customSeparatorValue" placeholder="输入自定义分隔符，如: ---, ===, ###" value="---" oninput="updateCustomSeparator()">
                        </div>
                    </div>
                </div>

                <!-- 文件命名设置 -->
                <div class="lora-tool-section">
                    <h4><i class="fas fa-signature"></i> 文件命名设置</h4>
                    <div class="lora-input-group">
                        <label>文件前缀</label>
                        <input type="text" id="loraPrefix" value="cameralora_hojo" placeholder="如: cameralora_hojo" oninput="updateNamingConfig()">
                    </div>
                    <div class="lora-input-group">
                        <label>前缀后分隔符</label>
                        <input type="text" id="loraNameSeparator" value=" " placeholder="空格、下划线(_)等" oninput="updateNamingConfig()" style="width: 150px;">
                        <small style="color: #999; display: block; margin-top: 5px;">常用: 空格、下划线(_)、连字符(-)</small>
                    </div>
                    <div style="display: flex; gap: 15px;">
                        <div class="lora-input-group" style="flex: 1;">
                            <label>起始编号</label>
                            <input type="number" id="loraStartNumber" value="1" min="1" oninput="updateNamingConfig()">
                        </div>
                        <div class="lora-input-group" style="flex: 1;">
                            <label class="lora-checkbox-group">
                                <input type="checkbox" id="loraPadZero" onchange="updatePadZeroConfig()">
                                <span>补零对齐</span>
                            </label>
                            <input type="number" id="loraDigits" value="3" min="1" max="10" disabled oninput="updateNamingConfig()" style="margin-top: 8px;">
                            <small style="color: #999; display: block; margin-top: 5px;">如: 001, 002, 003...</small>
                        </div>
                    </div>
                </div>

                <!-- 预览结果 -->
                <div class="lora-tool-section" id="loraPreviewSection" style="display: none;">
                    <h4><i class="fas fa-eye"></i> 预览结果</h4>
                    <div style="padding: 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; margin-bottom: 15px; font-size: 13px; color: #856404;">
                        <i class="fas fa-info-circle"></i> 
                        <strong>保存方式说明：</strong><br>
                        • <strong>选择文件夹并保存</strong>：直接保存多个txt文件到指定文件夹（推荐，需Chrome/Edge浏览器）<br>
                        • <strong>下载ZIP压缩包</strong>：下载一个压缩包，手动解压后使用（兼容所有浏览器）
                    </div>
                    <div class="lora-stats">
                        <div class="lora-stat-item">
                            <span class="lora-stat-number" id="loraFileCount">0</span>
                            <span class="lora-stat-label">文件数量</span>
                        </div>
                        <div class="lora-stat-item">
                            <span class="lora-stat-number" id="loraTotalChars">0</span>
                            <span class="lora-stat-label">总字符数</span>
                        </div>
                    </div>
                    <div class="lora-preview-box" id="loraPreviewList">
                        <!-- 预览列表将在这里生成 -->
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #999;">
                        <i class="fas fa-arrow-up"></i> 滚动查看所有文件
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="lora-btn-primary" id="loraSaveToFolderBtn" onclick="saveLoraFilesToFolder()" disabled style="flex: 1;">
                    <i class="fas fa-folder-open"></i> 选择文件夹并保存
                </button>
                <button class="lora-btn-primary" id="loraDownloadBtn" onclick="downloadLoraFiles()" disabled style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="fas fa-download"></i> 下载ZIP压缩包
                </button>
                <button class="lora-btn-secondary" onclick="closeLoraToolModal()">
                    <i class="fas fa-times"></i> 关闭
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // 初始化配置
    loraToolData.config = {
        separatorType: 'emptyLine',
        customSeparator: '---',
        prefix: 'cameralora_hojo',
        nameSeparator: ' ',
        startNumber: 1,
        padZero: false,
        digits: 3
    };
}

// 关闭LORA工具模态框
function closeLoraToolModal() {
    const modal = document.getElementById('loraToolModal');
    if (modal) {
        document.body.removeChild(modal);
    }
    // 重置数据
    loraToolData = {
        uploadedFile: null,
        segments: [],
        config: {
            separatorType: 'emptyLine',
            customSeparator: '---',
            prefix: 'cameralora_hojo',
            nameSeparator: ' ',
            startNumber: 1,
            padZero: false,
            digits: 3
        }
    };
}

// 处理文件上传
function handleLoraFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // 验证文件类型
    if (!file.name.toLowerCase().endsWith('.txt')) {
        alert('⚠️ 请上传TXT文件！');
        event.target.value = '';
        return;
    }
    
    // 验证文件大小（限制10MB）
    if (file.size > 10 * 1024 * 1024) {
        alert('⚠️ 文件过大！请上传小于10MB的文件。');
        event.target.value = '';
        return;
    }
    
    loraToolData.uploadedFile = file;
    
    // 显示文件信息
    const fileInfo = document.getElementById('loraFileInfo');
    fileInfo.style.display = 'block';
    fileInfo.innerHTML = `
        <div class="lora-file-info">
            <i class="fas fa-file-alt"></i>
            <div style="flex: 1;">
                <div style="font-weight: bold;">${file.name}</div>
                <div style="font-size: 12px; color: #666;">${formatFileSize(file.size)}</div>
            </div>
            <i class="fas fa-check-circle"></i>
        </div>
    `;
    
    // 读取并解析文件
    parseLoraFile(file);
}

// 格式化文件大小
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

// 解析文件
function parseLoraFile(file) {
    const reader = new FileReader();
    
    reader.onload = function(e) {
        let content = e.target.result;
        
        // 处理文本内容
        processLoraContent(content);
    };
    
    // 先尝试UTF-8编码
    reader.readAsText(file, 'UTF-8');
}

// 处理文本内容
function processLoraContent(content) {
    const config = loraToolData.config;
    let segments = [];
    
    // 根据分隔符类型拆分
    if (config.separatorType === 'emptyLine') {
        // 按空行分割
        segments = content.split(/\n\s*\n/);
    } else {
        // 按自定义分隔符分割
        const separator = config.customSeparator;
        segments = content.split(separator);
    }
    
    // 处理每段内容
    segments = segments.map(segment => {
        return segment
            .trim()                      // 删除首尾空格空行
            .replace(/\n+/g, ' ')        // 换行符替换为空格
            .replace(/\s+/g, ' ')        // 多个空格合并为一个
            .trim();                     // 再次trim确保干净
    }).filter(s => s.length > 0);        // 过滤空内容
    
    loraToolData.segments = segments;
    
    // 更新预览
    updateLoraPreview();
}

// 更新预览
function updateLoraPreview() {
    const segments = loraToolData.segments;
    
    if (segments.length === 0) {
        document.getElementById('loraPreviewSection').style.display = 'none';
        document.getElementById('loraDownloadBtn').disabled = true;
        document.getElementById('loraSaveToFolderBtn').disabled = true;
        return;
    }
    
    // 显示预览区域
    document.getElementById('loraPreviewSection').style.display = 'block';
    document.getElementById('loraDownloadBtn').disabled = false;
    document.getElementById('loraSaveToFolderBtn').disabled = false;
    
    // 更新统计信息
    const totalChars = segments.reduce((sum, seg) => sum + seg.length, 0);
    document.getElementById('loraFileCount').textContent = segments.length;
    document.getElementById('loraTotalChars').textContent = totalChars.toLocaleString();
    
    // 生成文件名预览 - 显示所有文件
    const config = loraToolData.config;
    const previewList = document.getElementById('loraPreviewList');
    let html = '';
    
    // 显示所有文件
    for (let i = 0; i < segments.length; i++) {
        const fileName = generateLoraFileName(i);
        const preview = segments[i].length > 50 ? segments[i].substring(0, 50) + '...' : segments[i];
        html += `
            <div class="lora-preview-item" title="${segments[i]}">
                <i class="fas fa-check-circle"></i>
                <div style="flex: 1;">
                    <div style="font-weight: 500;">${fileName}</div>
                    <div style="font-size: 12px; color: #666; margin-top: 4px;">${preview}</div>
                </div>
                <span style="font-size: 11px; color: #999; white-space: nowrap;">${segments[i].length} 字符</span>
            </div>
        `;
    }
    
    previewList.innerHTML = html;
    
    // 滚动到顶部
    previewList.scrollTop = 0;
}

// 生成文件名
function generateLoraFileName(index) {
    const config = loraToolData.config;
    const number = config.startNumber + index;
    
    let numberStr = number.toString();
    if (config.padZero) {
        numberStr = numberStr.padStart(config.digits, '0');
    }
    
    return `${config.prefix}${config.nameSeparator}${numberStr}.txt`;
}

// 更新分隔符类型
function updateSeparatorType(type) {
    loraToolData.config.separatorType = type;
    
    // 显示/隐藏自定义分隔符输入框
    const customInput = document.getElementById('customSeparatorInput');
    if (type === 'custom') {
        customInput.style.display = 'block';
    } else {
        customInput.style.display = 'none';
    }
    
    // 重新解析
    if (loraToolData.uploadedFile) {
        parseLoraFile(loraToolData.uploadedFile);
    }
}

// 更新自定义分隔符
function updateCustomSeparator() {
    const value = document.getElementById('customSeparatorValue').value;
    loraToolData.config.customSeparator = value;
    
    // 重新解析
    if (loraToolData.uploadedFile) {
        parseLoraFile(loraToolData.uploadedFile);
    }
}

// 更新命名配置
function updateNamingConfig() {
    loraToolData.config.prefix = document.getElementById('loraPrefix').value;
    loraToolData.config.nameSeparator = document.getElementById('loraNameSeparator').value;
    loraToolData.config.startNumber = parseInt(document.getElementById('loraStartNumber').value) || 1;
    loraToolData.config.digits = parseInt(document.getElementById('loraDigits').value) || 3;
    
    // 更新预览
    updateLoraPreview();
}

// 更新补零配置
function updatePadZeroConfig() {
    const checked = document.getElementById('loraPadZero').checked;
    loraToolData.config.padZero = checked;
    document.getElementById('loraDigits').disabled = !checked;
    
    // 更新预览
    updateLoraPreview();
}

// 保存文件到自选文件夹
async function saveLoraFilesToFolder() {
    const segments = loraToolData.segments;
    
    if (segments.length === 0) {
        alert('⚠️ 没有可保存的内容！');
        return;
    }
    
    // 检查浏览器是否支持 File System Access API
    if (!('showDirectoryPicker' in window)) {
        alert('⚠️ 您的浏览器不支持此功能！\n\n请使用最新版本的 Chrome、Edge 或其他基于 Chromium 的浏览器。\n\n或者使用"下载ZIP压缩包"功能。');
        return;
    }
    
    try {
        // 让用户选择文件夹
        const dirHandle = await window.showDirectoryPicker({
            mode: 'readwrite',
            startIn: 'downloads'
        });
        
        showLoadingMessage('正在保存文件...');
        
        let successCount = 0;
        let errorCount = 0;
        
        // 逐个保存文件
        for (let i = 0; i < segments.length; i++) {
            try {
                const fileName = generateLoraFileName(i);
                const content = segments[i];
                
                // 创建文件
                const fileHandle = await dirHandle.getFileHandle(fileName, { create: true });
                
                // 写入内容
                const writable = await fileHandle.createWritable();
                await writable.write(content);
                await writable.close();
                
                successCount++;
                
                // 更新进度
                showLoadingMessage(`正在保存文件... (${successCount}/${segments.length})`);
                
            } catch (error) {
                console.error(`保存文件 ${i} 失败:`, error);
                errorCount++;
            }
        }
        
        hideLoadingMessage();
        
        if (errorCount === 0) {
            showSuccessMessage(`✅ 成功保存 ${successCount} 个文件到选定文件夹！`);
        } else {
            showErrorMessage(`⚠️ 保存完成：${successCount} 个成功，${errorCount} 个失败`);
        }
        
    } catch (error) {
        hideLoadingMessage();
        
        if (error.name === 'AbortError') {
            // 用户取消选择
            console.log('用户取消了文件夹选择');
        } else {
            console.error('保存文件失败:', error);
            showErrorMessage('保存失败：' + error.message);
        }
    }
}

// 下载文件（ZIP压缩包）
async function downloadLoraFiles() {
    const segments = loraToolData.segments;
    
    if (segments.length === 0) {
        alert('⚠️ 没有可下载的内容！');
        return;
    }
    
    try {
        // 创建ZIP文件
        const zip = new JSZip();
        
        // 添加每个文件
        segments.forEach((content, index) => {
            const fileName = generateLoraFileName(index);
            zip.file(fileName, content);
        });
        
        // 生成ZIP
        showLoadingMessage('正在打包文件...');
        const blob = await zip.generateAsync({ type: 'blob' });
        
        // 下载
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `lora_annotations_${Date.now()}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        hideLoadingMessage();
        showSuccessMessage(`✅ 成功导出 ${segments.length} 个文件！`);
        
    } catch (error) {
        console.error('导出失败:', error);
        hideLoadingMessage();
        showErrorMessage('导出失败：' + error.message);
    }
}

// =============== 应用启动 ================
document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>

