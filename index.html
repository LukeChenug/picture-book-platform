<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»˜æœ¬ä¸–ç•Œ - åˆ›ä½œä¸é˜…è¯»å¹³å°</title>
    <meta name="version" content="v1.1.1">
    <meta name="release-date" content="2025-10-27">
    <meta name="description" content="åŠŸèƒ½å¼ºå¤§çš„Webç»˜æœ¬ç”Ÿæˆå’Œé˜…è¯»å¹³å°ï¼Œæ”¯æŒåœ¨çº¿ç”Ÿæˆäº¤äº’å¼ç»˜æœ¬å’Œé¢„ç½®ç»˜æœ¬é˜…è¯»">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- JSZip for ZIP file creation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        /* å¼•å…¥æœ¬åœ°å­—ä½“ */
        @font-face {
            font-family: 'AaErZhiYuan';
            src: url('./AaErZhiYuan-2.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        /* å…¨å±€æ ·å¼é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        /* =============== ä¸»åº”ç”¨å¸ƒå±€ =============== */
        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            color: white;
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: rgba(255,255,255,0.9);
            color: #667eea;
        }

        .main {
            flex: 1;
            position: relative;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* =============== ç»˜æœ¬åº“æ ·å¼ =============== */
        .library-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .library-header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .library-header h2 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .search-box {
            max-width: 400px;
            margin: 20px auto;
            position: relative;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px;
            border: none;
            border-radius: 25px;
            background: rgba(255,255,255,0.9);
            font-size: 16px;
            outline: none;
        }

        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .book-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .book-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .book-cover {
            position: relative;
            height: 200px;
            background: linear-gradient(45deg, #f0f2f5, #e1e8ed);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .book-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* å›¾ç‰‡æ¸²æŸ“ä¼˜åŒ– */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            image-rendering: high-quality;
            image-rendering: auto;
            /* æŠ—é”¯é½¿ä¼˜åŒ– */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* ç¡®ä¿å›¾ç‰‡ä¸è¢«å‹ç¼© */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            /* å¼ºåˆ¶ç¡¬ä»¶åŠ é€Ÿ */
            will-change: transform;
        }

        .book-cover .placeholder {
            color: #999;
            font-size: 48px;
        }

        .book-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .book-card:hover .book-overlay {
            opacity: 1;
        }

        .overlay-btn {
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            color: #333;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .overlay-btn:hover {
            background: white;
            transform: scale(1.05);
        }

        .book-info {
            padding: 20px;
        }

        .book-info h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #333;
        }

        .book-meta {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .book-tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .tag {
            background: #e1e8ed;
            color: #667eea;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: rgba(255,255,255,0.8);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 16px;
            margin-bottom: 30px;
        }

        .create-first-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .create-first-btn:hover {
            transform: translateY(-2px);
        }

        /* =============== ç»˜æœ¬åˆ›å»ºå™¨æ ·å¼ =============== */
        .creator-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .creator-header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .creator-header h2 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .creation-method-selector {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }

        .method-btn {
            padding: 12px 24px;
            border: 2px solid #4A90E2;
            background: transparent;
            color: #4A90E2;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .method-btn:hover {
            background: #4A90E2;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
        }

        .method-btn.active {
            background: #4A90E2;
            color: white;
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
        }

        .import-section {
            display: none;
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .import-section.active {
            display: block;
        }

        .file-drop-zone {
            border: 3px dashed #4A90E2;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-drop-zone:hover {
            border-color: #357ABD;
            background: #f0f4ff;
        }

        .file-drop-zone.dragover {
            border-color: #357ABD;
            background: #e8f2ff;
            transform: scale(1.02);
        }

        .upload-section {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .upload-box {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            background: #f9f9f9;
            position: relative;
        }

        .upload-box:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .upload-box.active {
            border-color: #667eea;
            background: #e8f2ff;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: transform 0.2s ease;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
        }

        .page-setup {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .input-group input, .input-group textarea, .input-group select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .page-list {
            margin-top: 20px;
        }

        .page-item {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-info {
            flex: 1;
        }

        .page-actions button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .generate-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: transform 0.2s ease;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
        }

        .generate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .file-list {
            margin-top: 10px;
            font-size: 14px;
        }

        .file-item {
            background: #e9ecef;
            padding: 5px 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .remove-file {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 12px;
        }

        /* =============== è§’è‰²éŸ³é¢‘é…ç½®æ ·å¼ =============== */
        .character-audio-section {
            margin: 20px 0;
        }

        .character-config-list {
            margin-bottom: 15px;
        }

        .character-config-item {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .character-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .character-config-title {
            font-weight: bold;
            color: #495057;
        }

        .character-config-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .character-name-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            min-width: 120px;
        }

        .character-audio-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            min-width: 150px;
        }

        .remove-character-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-character-btn:hover {
            background: #c82333;
        }

        .drag-handle {
            cursor: move;
            color: #6c757d;
            font-size: 16px;
            user-select: none;
        }

        /* =============== è‡ªåŠ¨åŒ¹é…æ ·å¼ =============== */
        .auto-match-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            border: 2px dashed #28a745;
        }

        .auto-match-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .auto-match-info {
            font-size: 14px;
            line-height: 1.5;
        }

        .match-preview {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .match-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .match-item.incomplete {
            border-left-color: #ffc107;
        }

        .match-item.missing {
            border-left-color: #dc3545;
        }

        .match-number {
            font-weight: bold;
            min-width: 60px;
            color: #495057;
        }

        .match-files {
            flex: 1;
            display: flex;
            gap: 20px;
        }

        .match-file {
            flex: 1;
            padding: 8px;
            background: white;
            border-radius: 5px;
            font-size: 13px;
        }

        .match-file.empty {
            background: #e9ecef;
            color: #6c757d;
            font-style: italic;
        }

        .preview-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .preview-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-confirm {
            background: #28a745;
            color: white;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        /* =============== é¢„ç½®ç»˜æœ¬æ ·å¼ =============== */




        .book-description {
            font-size: 14px;
            color: #666;
            margin: 8px 0;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* =============== 3Dç¿»é¡µé˜…è¯»å™¨æ ·å¼ =============== */
        .book-reader {
            display: none;
            background: linear-gradient(135deg, #8b4513, #a0522d);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            padding: 20px;
        }

        .reader-container {
            max-width: 1400px;
            width: 100%;
            position: relative;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* 3Dç¿»é¡µç³»ç»Ÿæ ·å¼ */
        .controls {
            background: rgba(139, 69, 19, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .control-group label {
            font-size: 14px;
            font-weight: 500;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* ç»˜æœ¬æ ‡é¢˜æ ·å¼ */
        .book-title {
            font-family: 'AaErZhiYuan', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            letter-spacing: 0.5px;
        }

        .slider {
            width: 120px;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .book-container {
            height: 600px;
            position: relative;
            perspective: 2000px;
            background: var(--bg-color, #faf7f0);
            border-radius: 0 0 15px 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            aspect-ratio: 2.33 / 1;
        }

        .book {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            display: flex;
        }

        .book-spread {
            width: 100%;
            height: 100%;
            display: flex;
            position: absolute;
        }

        .book-container.has-spread-image .book-spread {
            gap: 0;
            transform: translateZ(0);
            backface-visibility: hidden;
            will-change: auto;
        }

        .page-left,
        .page-right {
            width: calc(50% - 20px);
            height: 100%;
            background: var(--bg-color, #faf7f0);
            padding: 50px 40px 80px 40px;
            position: relative;
            box-shadow: inset 0 0 20px rgba(139, 69, 19, 0.1);
        }

        .page-left.spread-page,
        .page-right.spread-page {
            padding: 0;
            width: 50%;
            transform: translateZ(0);
            border-radius: 0;
            box-shadow: none;
            background: transparent;
            backface-visibility: hidden;
            will-change: auto;
            position: relative;
        }

        .page-left.spread-page {
            margin-right: 0;
            margin-left: 0;
        }

        .page-right.spread-page {
            margin-left: 0;
            margin-right: 0;
        }

        .page-left {
            margin-right: 20px;
            border-radius: 15px 0 0 15px;
            background: linear-gradient(
                45deg,
                rgba(139, 69, 19, 0.02) 0%,
                rgba(139, 69, 19, 0.01) 100%
            ),
            linear-gradient(
                to right,
                var(--bg-color, #faf7f0) 0%,
                rgba(139, 69, 19, 0.01) 95%,
                rgba(139, 69, 19, 0.05) 100%
            ),
            var(--bg-color, #faf7f0);
            box-shadow: inset -8px 0 20px -10px rgba(139, 69, 19, 0.1),
                inset -2px 0 5px -2px rgba(139, 69, 19, 0.05);
            transform-origin: right center;
        }

        .page-right {
            margin-left: 20px;
            border-radius: 0 15px 15px 0;
            background: linear-gradient(
                45deg,
                rgba(139, 69, 19, 0.02) 0%,
                rgba(139, 69, 19, 0.01) 100%
            ),
            linear-gradient(
                to left,
                var(--bg-color, #faf7f0) 0%,
                rgba(139, 69, 19, 0.01) 95%,
                rgba(139, 69, 19, 0.05) 100%
            ),
            var(--bg-color, #faf7f0);
            box-shadow: inset 8px 0 20px -10px rgba(139, 69, 19, 0.1),
                inset 2px 0 5px -2px rgba(139, 69, 19, 0.05);
            transform-origin: left center;
        }

        .page-content {
            width: 100%;
            height: 100%;
            line-height: 1.7;
            color: var(--text-color, #2c2c2c);
            font-size: var(--font-size, 16px);
            text-align: justify;
            text-justify: inter-word;
            word-wrap: break-word;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .page-content.spread-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 0;
            margin: 0;
        }

        /* ç»˜æœ¬å›¾ç‰‡æ ·å¼ */
        .page-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            filter: brightness(var(--image-brightness, 1));
            transition: filter 0.3s ease;
            /* å›¾ç‰‡æ¸²æŸ“ä¼˜åŒ– - é’ˆå¯¹ä½åˆ†è¾¨ç‡å›¾ç‰‡ä¼˜åŒ– */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            image-rendering: high-quality;
            image-rendering: auto;
            /* é’ˆå¯¹ä½åˆ†è¾¨ç‡å›¾ç‰‡çš„é¢å¤–ä¼˜åŒ– */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            /* å°è¯•æ”¹å–„ä½åˆ†è¾¨ç‡å›¾ç‰‡æ˜¾ç¤º */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            /* æŠ—é”¯é½¿ä¼˜åŒ– */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* ç¡®ä¿å›¾ç‰‡ä¸è¢«å‹ç¼© */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            /* å¼ºåˆ¶ç¡¬ä»¶åŠ é€Ÿ */
            will-change: transform;
        }

        /* è·¨é¡µå›¾ç‰‡æ ·å¼ */
        .spread-image-left {
            position: absolute;
            width: 200%;
            height: 100%;
            object-fit: cover;
            object-position: center center;
            left: 0;
            top: 0;
            border-radius: 0;
            z-index: 1;
            clip-path: inset(0 50% 0 0);
            transform: translateZ(0);
            filter: brightness(var(--image-brightness, 1));
            transition: filter 0.3s ease;
            backface-visibility: hidden;
            will-change: transform;
            /* å›¾ç‰‡æ¸²æŸ“ä¼˜åŒ– */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            image-rendering: high-quality;
            image-rendering: auto;
            /* æŠ—é”¯é½¿ä¼˜åŒ– */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .spread-image-right {
            position: absolute;
            width: 200%;
            height: 100%;
            object-fit: cover;
            object-position: center center;
            left: -100%;
            top: 0;
            border-radius: 0;
            z-index: 1;
            clip-path: inset(0 0 0 50%);
            transform: translateZ(0);
            filter: brightness(var(--image-brightness, 1));
            transition: filter 0.3s ease;
            backface-visibility: hidden;
            will-change: transform;
            /* å›¾ç‰‡æ¸²æŸ“ä¼˜åŒ– */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            image-rendering: high-quality;
            image-rendering: auto;
            /* æŠ—é”¯é½¿ä¼˜åŒ– */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* é¡µé¢æ–‡å­—æ˜¾ç¤º - å·²ç§»é™¤å­—å¹•åŠŸèƒ½ */

        .binding-gutter {
            position: absolute;
            left: 50%;
            top: 0;
            width: 40px;
            height: 100%;
            transform: translateX(-50%);
            z-index: 20;
            background: linear-gradient(
                to right,
                rgba(139, 69, 19, 0.1) 0%,
                rgba(139, 69, 19, 0.3) 50%,
                rgba(139, 69, 19, 0.1) 100%
            );
        }

        .book-container.has-spread-image .binding-gutter {
            display: none;
        }

        .flipping-page {
            position: absolute;
            top: 0;
            width: calc(50% - 20px);
            height: 100%;
            background: var(--bg-color, #faf7f0);
            transform-style: preserve-3d;
            transition: transform 1.0s ease-in-out;
            z-index: 10;
            transform: rotateY(0deg);
        }

        .flipping-page.next-flip {
            right: 20px;
            transform-origin: left center;
            margin-left: 10px;
        }

        .flipping-page.prev-flip {
            left: 0;
            transform-origin: right center;
            margin-right: 10px;
        }

        /* è·¨é¡µå›¾ç‰‡ç¿»é¡µå…ƒç´ å°ºå¯¸å’Œä½ç½® */
        .flipping-page.has-spread-image {
            width: 50%;
            margin: 0;
        }

        .flipping-page.has-spread-image.next-flip {
            right: 0;
            margin-left: 0;
        }

        .flipping-page.has-spread-image.prev-flip {
            left: 0;
            margin-right: 0;
        }

        .flipping-page.flipping.next-flip {
            transform: rotateY(-180deg);
        }

        .flipping-page.flipping.prev-flip {
            transform: rotateY(180deg);
        }

        .flipping-page .page-front,
        .flipping-page .page-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            padding: 50px 40px 80px 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .flipping-page .page-front.spread-content,
        .flipping-page .page-back.spread-content {
            padding: 0;
        }

        .flipping-page .page-front {
            z-index: 2;
            background: linear-gradient(
                45deg,
                rgba(139, 69, 19, 0.02) 0%,
                rgba(139, 69, 19, 0.01) 100%
            ),
            linear-gradient(
                to left,
                var(--bg-color, #faf7f0) 0%,
                rgba(139, 69, 19, 0.01) 95%,
                rgba(139, 69, 19, 0.05) 100%
            ),
            var(--bg-color, #faf7f0);
        }

        .flipping-page .page-back {
            transform: rotateY(180deg);
            background: linear-gradient(
                45deg,
                rgba(139, 69, 19, 0.02) 0%,
                rgba(139, 69, 19, 0.01) 100%
            ),
            linear-gradient(
                to right,
                var(--bg-color, #faf7f0) 0%,
                rgba(139, 69, 19, 0.01) 95%,
                rgba(139, 69, 19, 0.05) 100%
            ),
            var(--bg-color, #faf7f0);
        }

        .click-areas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 15;
            display: flex;
        }

        .click-area {
            height: 100%;
            width: 50%;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .click-area:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        /* å¤–éƒ¨é¡µç æŒ‡ç¤ºå™¨æ ·å¼ */
        .external-page-indicator {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            padding: 0 20px;
        }

        .page-numbers {
            background: rgba(139, 69, 19, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .reader-controls {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .control-btn {
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: white;
            transform: scale(1.1);
        }

        /* åº•éƒ¨æ§åˆ¶åŒºåŸŸçš„å¯¼èˆªæŒ‰é’® */
        .reader-nav-btn {
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reader-nav-btn:hover {
            background: rgba(255,255,255,1);
            transform: scale(1.1);
        }

        /* å³ä¸Šè§’æŒ‰é’®å®¹å™¨ */
        .top-right-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
            z-index: 1100;
        }

        .close-btn {
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .close-btn:hover {
            background: rgba(255,255,255,1);
            transform: scale(1.1);
        }

        .fullscreen-btn {
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .fullscreen-btn:hover {
            background: rgba(255,255,255,1);
            transform: scale(1.1);
        }

        .auto-play-toggle {
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .auto-play-toggle.active {
            background: #28a745;
            color: white;
        }

        /* =============== å“åº”å¼è®¾è®¡ =============== */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .nav {
                flex-wrap: wrap;
                justify-content: center;
            }

            .books-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 20px;
            }

            .book-container {
                height: 450px;
            }

            .controls {
                flex-direction: column;
                gap: 10px;
            }

            .book-title {
                font-size: 16px;
            }

            .reader-nav-btn {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }

            .top-right-controls {
                top: 10px;
                right: 10px;
                gap: 8px;
            }

            .close-btn, .fullscreen-btn {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }
        }

        /* =============== åŠ è½½å’Œåé¦ˆæ ·å¼ =============== */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 9999;
        }

        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 9999;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 9999;
            animation: slideInRight 0.3s ease;
        }

        /* é¡µé¢é€‰é¡¹å®¹å™¨æ ·å¼ */
        .page-options-container {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 20px;
            color: #333;
    z-index: 9999;
            min-width: 400px;
            max-width: 90%;
            max-height: 80vh;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: fadeIn 0.3s ease;
            text-align: center;
            overflow-y: auto;
}

.options-title {
    font-size: 24px;
    margin-bottom: 20px;
    text-align: center;
    font-weight: bold;
}

.options-buttons {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.option-button {
    padding: 15px 20px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 18px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.option-button:hover {
    background: #218838;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
}

        .options-title {
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }

        .options-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option-button {
            padding: 10px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .option-button:hover {
            background: #218838;
        }

        /* ç¼–è¾‘é€‰é¡¹å¼¹çª—æ ·å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }

        .modal-header h3 {
            margin: 0;
        }

        .modal-header button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 15px;
        }

        .modal-footer {
            padding: 15px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .option-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .option-content {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .optionText {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .targetPage {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .delete-option-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        #addOptionBtn {
            width: 100%;
            padding: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        #addOptionBtn:hover {
            background: #0056b3;
        }

        .page-actions {
            display: flex;
            gap: 10px;
        }

        .page-actions button {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .page-actions button:first-child {
            background: #007bff;
            color: white;
        }

        .page-actions button:first-child:hover {
            background: #0056b3;
        }

        .page-actions button:last-child {
            background: #dc3545;
            color: white;
        }

        .page-actions button:last-child:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="header-content">
                <h1 class="logo">
                    <i class="fas fa-book-open"></i>
                    ç»˜æœ¬ä¸–ç•Œ
                </h1>
                <nav class="nav">
                    <button class="nav-btn active" data-tab="library">
                        <i class="fas fa-home"></i>
                        ç»˜æœ¬åº“
                    </button>
                    <button class="nav-btn" data-tab="create">
                        <i class="fas fa-plus"></i>
                        åˆ›å»ºç»˜æœ¬
                    </button>
                    <button class="nav-btn" data-tab="import">
                        <i class="fas fa-file-import"></i>
                        å¯¼å…¥ç»˜æœ¬
                    </button>
                </nav>
            </div>
        </header>

        <main class="main">
            <!-- ç»˜æœ¬åº“é¡µé¢ -->
            <div class="tab-content active" id="library">
                <div class="library-container">
                <div class="library-header">
                    <h2>æˆ‘çš„ç»˜æœ¬æ”¶è—</h2>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="æœç´¢ç»˜æœ¬..." id="searchInput">
                    </div>
                    <div class="storage-info" id="storageInfo" style="margin-top: 10px; font-size: 14px; color: rgba(255,255,255,0.8);"></div>
                </div>
                <div class="books-grid" id="booksGrid">
                    <!-- ç»˜æœ¬å¡ç‰‡å°†åŠ¨æ€æ’å…¥è¿™é‡Œ -->
                        <div class="empty-state" id="emptyState">
                            <i class="fas fa-book-open"></i>
                            <h3>å½“å‰ä¼šè¯ä¸­è¿˜æ²¡æœ‰ç»˜æœ¬</h3>
                            <p>åˆ›å»ºæ‚¨çš„ç¬¬ä¸€æœ¬ç»˜æœ¬å§ï¼<br><small>æ³¨æ„ï¼šåˆ·æ–°é¡µé¢åç»˜æœ¬å°†æ¶ˆå¤±</small></p>
                            <button class="create-first-btn" onclick="switchToCreateTab()">
                                <i class="fas fa-plus"></i>
                                åˆ›å»ºç»˜æœ¬
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åˆ›å»ºç»˜æœ¬é¡µé¢ -->
            <div class="tab-content" id="create">
                <div class="creator-container">
                    <div class="creator-header">
                        <h2>ğŸ“š åˆ›å»ºæ–°ç»˜æœ¬</h2>
                        <p>ä¸Šä¼ å›¾ç‰‡å’ŒéŸ³é¢‘ï¼Œåˆ›é€ å±äºæ‚¨çš„äº’åŠ¨ç»˜æœ¬æ•…äº‹</p>
                        
                        </div>
                        
                    <div class="upload-section">
                        <h3>ğŸ“ æ–‡ä»¶ä¸Šä¼ </h3>
                        
                        <div class="upload-grid">
                            <div class="upload-box" id="narratorUpload">
                                <h4>ğŸ“¢ æ—ç™½éŸ³é¢‘</h4>
                                <p>ä¸Šä¼ æ•…äº‹æ—ç™½éŸ³é¢‘æ–‡ä»¶ï¼ˆMP3, WAVç­‰ï¼‰</p>
                                <p><small>æ”¯æŒä¸€æ¬¡é€‰æ‹©å¤šä¸ªæ–‡ä»¶</small></p>
                                <input type="file" class="file-input" id="narratorFiles" multiple accept="audio/*">
                                <button class="upload-btn" onclick="document.getElementById('narratorFiles').click()">é€‰æ‹©æ—ç™½éŸ³é¢‘</button>
                                <div class="file-list" id="narratorList"></div>
                            </div>
                            
                            <div class="upload-box" id="characterUpload">
                                <h4>ğŸ­ è§’è‰²éŸ³é¢‘</h4>
                                <p>ä¸Šä¼ è§’è‰²å¯¹è¯éŸ³é¢‘æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰</p>
                                <p><small>æ”¯æŒä¸€æ¬¡é€‰æ‹©å¤šä¸ªæ–‡ä»¶</small></p>
                                <input type="file" class="file-input" id="characterFiles" multiple accept="audio/*">
                                <button class="upload-btn" onclick="document.getElementById('characterFiles').click()">é€‰æ‹©è§’è‰²éŸ³é¢‘</button>
                                <div class="file-list" id="characterList"></div>
                        </div>

                            <div class="upload-box" id="imageUpload">
                                <h4>ğŸ–¼ï¸ èƒŒæ™¯å›¾ç‰‡</h4>
                                <p>ä¸Šä¼ ç»˜æœ¬èƒŒæ™¯å›¾ç‰‡ï¼ˆJPG, PNGç­‰ï¼‰</p>
                                <p><small>æ”¯æŒä¸€æ¬¡é€‰æ‹©å¤šä¸ªæ–‡ä»¶</small></p>
                                <input type="file" class="file-input" id="imageFiles" multiple accept="image/*">
                                <button class="upload-btn" onclick="document.getElementById('imageFiles').click()">é€‰æ‹©å¤šä¸ªå›¾ç‰‡æ–‡ä»¶</button>
                                <div class="file-list" id="imageList"></div>
                                </div>
                        </div>

                        <h3>âš™ï¸ å›¾ç‰‡ä¼˜åŒ–è®¾ç½®</h3>
                        <div class="page-setup">
                            <div class="input-group">
                                <label for="imageQuality">å›¾ç‰‡è´¨é‡ (0.1-1.0):</label>
                                <input type="range" id="imageQuality" min="0.1" max="1.0" step="0.1" value="1.0">
                                <span id="qualityDisplay">1.0</span>
                                <small>è¾ƒä½è´¨é‡å¯æå‡åŠ è½½æ€§èƒ½</small>
                            </div>
                            <div class="input-group">
                                <label for="maxImageWidth">å›¾ç‰‡æœ€å¤§å®½åº¦:</label>
                                <select id="maxImageWidth">
                                    <option value="600">600px (æå°ï¼Œæœ€çœç©ºé—´)</option>
                                    <option value="800">800px (è¾ƒå°ï¼ŒèŠ‚çœç©ºé—´)</option>
                                    <option value="1200">1200px (æ¨è)</option>
                                    <option value="1600">1600px (é«˜è´¨é‡)</option>
                                    <option value="2000" selected>2000px (åŸç”»è´¨)</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>
                                    <input type="checkbox" id="lowStorageMode"> 
                                    æ€§èƒ½ä¼˜åŒ–æ¨¡å¼ (è‡ªåŠ¨ä½¿ç”¨æœ€å°è®¾ç½®)
                                </label>
                                <small>å¼€å¯åå°†ä½¿ç”¨ 600px + 0.6 è´¨é‡è¿›è¡Œä¼˜åŒ–</small>
                            </div>
                        </div>

                        <h3>ğŸ“– é¡µé¢è®¾ç½®</h3>
                        <div class="page-setup">
                            <div class="input-group">
                                <label for="pageImage">é€‰æ‹©èƒŒæ™¯å›¾ç‰‡:</label>
                                <select id="pageImage">
                                    <option value="">è¯·å…ˆä¸Šä¼ å›¾ç‰‡</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="pageNarrator">é€‰æ‹©æ—ç™½éŸ³é¢‘:</label>
                                <select id="pageNarrator">
                                    <option value="">è¯·å…ˆä¸Šä¼ æ—ç™½éŸ³é¢‘</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="pageText">é¡µé¢æ–‡å­—ï¼ˆå¯é€‰ï¼‰:</label>
                                <textarea id="pageText" rows="3" placeholder="è¾“å…¥è¿™ä¸€é¡µè¦æ˜¾ç¤ºçš„æ–‡å­—ï¼ˆå¯ç•™ç©ºï¼‰"></textarea>
                            </div>
                            <div class="input-group">
                                <label for="pageType">é¡µé¢ç±»å‹:</label>
                                <select id="pageType" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                    <option value="public">å…¬å…±é¡µ - æŒ‰é¡ºåºæ’­æ”¾</option>
                                    <option value="interactive">äº’åŠ¨é€‰é¡¹é¡µ - åŸºäºé€‰é¡¹æ’­æ”¾</option>
                                </select>
                                <small style="display: block; margin-top: 5px; color: #666;">
                                    å…¬å…±é¡µï¼šæŒ‰é¡µé¢é¡ºåºè‡ªåŠ¨æ’­æ”¾ | äº’åŠ¨é€‰é¡¹é¡µï¼šéœ€è¦ç”¨æˆ·é€‰æ‹©é€‰é¡¹åè·³è½¬æ’­æ”¾
                                </small>
                            </div>
                        </div>

                        <h3>ğŸ­ è§’è‰²éŸ³é¢‘é…ç½®</h3>
                        <div class="character-audio-section">
                            <div class="character-config-list" id="characterConfigList">
                                <!-- è§’è‰²é…ç½®é¡¹å°†åŠ¨æ€æ’å…¥è¿™é‡Œ -->
                            </div>
                            <button class="upload-btn" onclick="addCharacterConfig()" style="background: #17a2b8;">
                                <i class="fas fa-plus"></i> æ·»åŠ è§’è‰²å¯¹è¯
                            </button>
                        </div>

                        <h3>ğŸ¤– æ™ºèƒ½åŒ¹é…</h3>
                        <div class="auto-match-section">
                            <div class="auto-match-info" id="autoMatchInfo" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;">
                                <!-- åŒ¹é…ä¿¡æ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                            </div>
                            <div class="auto-match-controls">
                                <button class="upload-btn" onclick="showAutoMatchPreview()" style="background: #28a745;">
                                    <i class="fas fa-magic"></i> åˆ†ææ–‡ä»¶åŒ¹é…
                                </button>
                            </div>
                        </div>

                        <h3>ğŸ“– æ‰‹åŠ¨æ·»åŠ é¡µé¢</h3>
                        <div class="page-setup">
                            <div class="input-group">
                                <button class="upload-btn" onclick="addPage()">æ·»åŠ å•ä¸ªé¡µé¢</button>
                            </div>
                        </div>

                        <div class="page-list" id="pageList">
                            <h3>ğŸ“‹ é¡µé¢åˆ—è¡¨</h3>
                            <p id="emptyMessage">è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•é¡µé¢</p>
                            <div id="batchActions" style="display: none; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <h4>ğŸ”§ æ‰¹é‡æ“ä½œ</h4>
                                <button class="upload-btn" onclick="optimizeAllPages()" style="background: #17a2b8;">
                                    <i class="fas fa-compress"></i> é‡æ–°å‹ç¼©æ‰€æœ‰é¡µé¢
                                </button>
                                <small style="display: block; margin-top: 5px; color: #666;">
                                    ä½¿ç”¨å½“å‰å‹ç¼©è®¾ç½®é‡æ–°å‹ç¼©æ‰€æœ‰é¡µé¢ï¼Œå¯èƒ½ä¼šèŠ‚çœå­˜å‚¨ç©ºé—´
                                </small>
                            </div>
                        </div>


                        <!-- ç»˜æœ¬åŸºæœ¬ä¿¡æ¯è¾“å…¥ -->
                        <div class="book-info-input" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;">
                            <label for="bookTitle" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                                ğŸ“– ç»˜æœ¬åç§°
                            </label>
                            <input 
                                type="text" 
                                id="bookTitle" 
                                placeholder="è¯·è¾“å…¥ç»˜æœ¬åç§°ï¼ˆé»˜è®¤ï¼šç»˜æœ¬ä½œå“ï¼‰" 
                                value="ç»˜æœ¬ä½œå“"
                                style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; transition: border-color 0.3s ease; margin-bottom: 15px;"
                                maxlength="50"
                                onfocus="this.style.borderColor='#4A90E2'; this.style.boxShadow='0 0 5px rgba(74, 144, 226, 0.3)';"
                                onblur="this.style.borderColor='#ccc'; this.style.boxShadow='none';"
                                oninput="validateBookTitle()"
                            />
                            <small style="display: block; margin-bottom: 15px; color: #666;">
                                ä¸ºä½ çš„ç»˜æœ¬èµ·ä¸€ä¸ªå¥½å¬çš„åå­—å§ï¼<span id="charCount" style="float: right; color: #999;">0/50</span>
                            </small>
                            
                            <label for="bookAuthor" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                                âœï¸ ä½œè€…
                            </label>
                            <input 
                                type="text" 
                                id="bookAuthor" 
                                placeholder="è¯·è¾“å…¥ä½œè€…åç§°ï¼ˆé»˜è®¤ï¼šç»˜æœ¬æ™ºèƒ½ä½“ï¼‰" 
                                value="ç»˜æœ¬æ™ºèƒ½ä½“"
                                style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; transition: border-color 0.3s ease; margin-bottom: 15px;"
                                maxlength="30"
                                onfocus="this.style.borderColor='#4A90E2'; this.style.boxShadow='0 0 5px rgba(74, 144, 226, 0.3)';"
                                onblur="this.style.borderColor='#ccc'; this.style.boxShadow='none';"
                            />
                            <small style="display: block; margin-bottom: 15px; color: #666;">
                                ç»˜æœ¬çš„åˆ›ä½œè€…åç§°
                            </small>
                            
                            <label for="bookDescription" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                                ğŸ“ ç»˜æœ¬ç®€ä»‹
                            </label>
                            <textarea 
                                id="bookDescription" 
                                placeholder="è¯·è¾“å…¥ç»˜æœ¬ç®€ä»‹ï¼ˆé»˜è®¤ï¼šåŒ…å« X é¡µçš„ç²¾ç¾ç»˜æœ¬ï¼‰" 
                                style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; transition: border-color 0.3s ease; resize: vertical; min-height: 80px;"
                                maxlength="200"
                                onfocus="this.style.borderColor='#4A90E2'; this.style.boxShadow='0 0 5px rgba(74, 144, 226, 0.3)';"
                                onblur="this.style.borderColor='#ccc'; this.style.boxShadow='none';"
                                oninput="updateDescriptionPlaceholder()"
                            ></textarea>
                            <small style="display: block; margin-top: 5px; color: #666;">
                                ç®€å•æè¿°ä¸€ä¸‹ä½ çš„ç»˜æœ¬å†…å®¹å§ï¼<span id="descCharCount" style="float: right; color: #999;">0/200</span>
                            </small>
                        </div>

                        <button class="generate-btn" onclick="generateBook()" id="generateBtn" disabled>ğŸš€ ç”Ÿæˆç»˜æœ¬</button>
                    </div>
                </div>
            </div>

            <!-- å¯¼å…¥ç»˜æœ¬é¡µé¢ -->
            <div class="tab-content" id="import">
                <div class="creator-container">
                    <div class="creator-header">
                        <h2>ğŸ“ å¯¼å…¥ç»˜æœ¬</h2>
                        <p>ä»æœ¬åœ°æ–‡ä»¶å¯¼å…¥ç»˜æœ¬æ•°æ®ï¼Œå¿«é€Ÿåˆ›å»ºæ‚¨çš„äº’åŠ¨ç»˜æœ¬</p>
                    </div>
                    
                    <div class="import-section active">
                        <h3>ğŸ“ å¯¼å…¥æœ¬åœ°æ–‡ä»¶</h3>
                        <p style="color: #666; margin-bottom: 20px;">
                            é€‰æ‹©åŒ…å«ç»˜æœ¬æ•°æ®çš„JSONæ–‡ä»¶ï¼Œæˆ–æ‹–æ‹½æ–‡ä»¶åˆ°ä¸‹æ–¹åŒºåŸŸ
                        </p>
                        
                        <div class="file-drop-zone" id="fileDropZone" onclick="document.getElementById('fileInput').click()">
                            <div style="font-size: 48px; color: #4A90E2; margin-bottom: 15px;">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <h4 style="margin: 10px 0; color: #333;">æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©</h4>
                            <p style="color: #666; margin: 5px 0;">æ”¯æŒ .json æ ¼å¼çš„ç»˜æœ¬æ•°æ®æ–‡ä»¶</p>
                            <small style="color: #999;">ä¾‹å¦‚ï¼šbook-data.json</small>
                        </div>
                        
                        <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileImport(event)">
                        
                        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
                            <h4 style="margin: 0 0 10px 0; color: #856404;">âš ï¸ é‡è¦æç¤º</h4>
                            <p style="margin: 0; color: #856404; font-size: 14px;">
                                ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œç›´æ¥å¯¼å…¥åŒ…å«æ–‡ä»¶è·¯å¾„çš„JSONå¯èƒ½æ— æ³•æ­£å¸¸åŠ è½½å›¾ç‰‡å’ŒéŸ³é¢‘ã€‚<br>
                                å»ºè®®ä½¿ç”¨"åˆ›å»ºç»˜æœ¬"åŠŸèƒ½æ‰‹åŠ¨ä¸Šä¼ å›¾ç‰‡å’ŒéŸ³é¢‘æ–‡ä»¶ï¼Œæˆ–ç¡®ä¿JSONæ–‡ä»¶ä¸­çš„å›¾ç‰‡å’ŒéŸ³é¢‘æ•°æ®æ˜¯base64æ ¼å¼ã€‚
                            </p>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border: 1px solid #4caf50; border-radius: 8px;">
                            <h4 style="margin: 0 0 10px 0; color: #2e7d32;">ğŸ“š è½¬æ¢å·²åˆ›å»ºçš„ç»˜æœ¬</h4>
                            <p style="margin: 0 0 15px 0; color: #2e7d32; font-size: 14px;">
                                å¦‚æœæ‚¨å·²ç»åˆ›å»ºäº†ç»˜æœ¬ï¼Œå¯ä»¥å°†å…¶è½¬æ¢ä¸ºé¢„åˆ¶ç»˜æœ¬ï¼Œæ–¹ä¾¿é‡å¤ä½¿ç”¨ã€‚
                            </p>
                            <button onclick="showCreatedBooksList()" style="background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                                <i class="fas fa-list"></i> æŸ¥çœ‹å·²åˆ›å»ºçš„ç»˜æœ¬
                            </button>
                            <small style="color: #2e7d32; display: block; margin-top: 10px;">
                                åœ¨ç»˜æœ¬åº“ä¸­ï¼Œæ¯æœ¬å·²åˆ›å»ºçš„ç»˜æœ¬éƒ½æœ‰"è½¬ä¸ºé¢„åˆ¶"æŒ‰é’®ï¼Œç‚¹å‡»å³å¯è½¬æ¢ã€‚
                            </small>
                        </div>
                        
                        <div id="importPreview" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;">
                            <h4 style="margin: 0 0 10px 0; color: #333;">ğŸ“‹ å¯¼å…¥é¢„è§ˆ</h4>
                            <div id="importInfo"></div>
                            <button id="confirmImportBtn" class="btn btn-primary" style="margin-top: 15px;" onclick="confirmImport()">
                                <i class="fas fa-check"></i> ç¡®è®¤å¯¼å…¥
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 3Dç¿»é¡µé˜…è¯»å™¨ -->
        <div class="book-reader" id="bookReader">
            <!-- å³ä¸Šè§’æ§åˆ¶æŒ‰é’® -->
            <div class="top-right-controls">
                <button class="fullscreen-btn" onclick="toggleFullscreen()">â›¶</button>
                <button class="close-btn" onclick="closeBook()">Ã—</button>
            </div>
            
                <div class="reader-container">
                <!-- ç»˜æœ¬é˜…è¯»å™¨æ§åˆ¶å™¨ -->
                <div class="controls">
                    <div class="control-group">
                        <span class="book-title" id="currentBookTitle">ç»˜æœ¬æ ‡é¢˜</span>
                    </div>
                    <div class="control-group">
                        <label for="brightness">ç”»é¢äº®åº¦</label>
                        <input type="range" id="brightness" class="slider" min="0.4" max="1" step="0.1" value="1">
                    </div>
                    </div>
                    
                <!-- 3Dç¿»é¡µä¹¦ç±å®¹å™¨ -->
                <div class="book-container" id="bookContainer">
                    <div class="binding-gutter"></div>

                    <div class="book" id="book">
                        <div class="book-spread" id="currentSpread">
                            <div class="page-left">
                                <div class="page-content" id="leftPageContent"></div>
                            </div>
                        <div class="page-right">
                                <div class="page-content" id="rightPageContent"></div>
                            </div>
                        </div>
                    </div>

                    <div class="click-areas">
                        <div class="click-area" id="prevArea"></div>
                        <div class="click-area" id="nextArea"></div>
                    </div>
                </div>

                <!-- é¡µç æŒ‡ç¤ºå™¨ -->
                <div class="external-page-indicator">
                    <div class="page-numbers" id="pageIndicator">Page 1</div>
                </div>

                <!-- éŸ³é¢‘æ§åˆ¶å™¨ -->
                    <div class="reader-controls">
                    <button class="reader-nav-btn" onclick="prevPage()">â€¹</button>
                    <button class="control-btn" onclick="togglePlay()" id="playBtn">â–¶ï¸</button>
                    <button class="auto-play-toggle" onclick="toggleAutoPlay()" id="autoPlayBtn">è‡ªåŠ¨æ’­æ”¾</button>
                    <button class="reader-nav-btn" onclick="nextPage()">â€º</button>
                        </div>
                    </div>

            <audio id="audioPlayer" preload="auto"></audio>
                        </div>
                    </div>

    <script>
        // =============== å…¨å±€å˜é‡å’ŒçŠ¶æ€ç®¡ç† ===============
        let narratorFiles = [];     // æ—ç™½éŸ³é¢‘æ–‡ä»¶
        let characterFiles = [];    // è§’è‰²éŸ³é¢‘æ–‡ä»¶
        let imageFiles = [];
        let pages = [];
        let currentPage = 0;
        let isPlaying = false;
        let autoPlay = true;
        let bookReader = null; // 3Dç¿»é¡µé˜…è¯»å™¨å®ä¾‹
        let savedBooks = []; // ä¿å­˜çš„ç»˜æœ¬åˆ—è¡¨
        let characterConfigs = []; // è§’è‰²é…ç½®åˆ—è¡¨
        let currentAudioSequence = null; // å½“å‰æ’­æ”¾çš„éŸ³é¢‘åºåˆ—
        let autoMatcher = null; // è‡ªåŠ¨åŒ¹é…å™¨å®ä¾‹
        let currentEditingBookId = null; // å½“å‰ç¼–è¾‘çš„ç»˜æœ¬ID


        // é¢„ç½®ç»˜æœ¬æ•°æ®
        const PresetBooks = [
            {
                id: 'å¥‡å¥‡çš„è”¬èœç‹å›½',
                title: 'å¥‡å¥‡çš„è”¬èœç‹å›½',
                description: 'ä¸€ä¸ªå…³äºå°æœ‹å‹åƒé¥­çš„ç»˜æœ¬æ•…äº‹ã€‚',
                author: 'ç»˜æœ¬æ™ºèƒ½ä½“',
                coverImage: './books/å¥‡å¥‡çš„è”¬èœç‹å›½/images/cover.jpg',
                dataUrl: './books/å¥‡å¥‡çš„è”¬èœç‹å›½/book-data.json',
                source: 'preset'
            }
        ];

        // æ˜¾ç¤ºå·²åˆ›å»ºçš„ç»˜æœ¬åˆ—è¡¨
        function showCreatedBooksList() {
            if (savedBooks.length === 0) {
                showErrorMessage('å½“å‰æ²¡æœ‰å·²åˆ›å»ºçš„ç»˜æœ¬ï¼è¯·å…ˆåˆ›å»ºä¸€æœ¬ç»˜æœ¬ã€‚');
                return;
            }

            let message = 'å·²åˆ›å»ºçš„ç»˜æœ¬åˆ—è¡¨ï¼š\n\n';
            savedBooks.forEach((book, index) => {
                message += `${index + 1}. ã€Š${book.title}ã€‹\n`;
                message += `   ä½œè€…ï¼š${book.author || 'æœªçŸ¥'}\n`;
                message += `   é¡µæ•°ï¼š${book.pages ? book.pages.length : 0} é¡µ\n`;
                message += `   åˆ›å»ºæ—¶é—´ï¼š${book.createdAt ? new Date(book.createdAt).toLocaleString() : 'æœªçŸ¥'}\n\n`;
            });

            alert(message);
        }

        // å°†ç”Ÿæˆçš„ç»˜æœ¬è½¬æ¢ä¸ºé¢„åˆ¶ç»˜æœ¬
        function convertGeneratedBookToPreset(bookId) {
            const book = BookStorage.getById(bookId);
            if (!book) {
                showErrorMessage('ç»˜æœ¬ä¸å­˜åœ¨ï¼');
                return;
            }

            console.log('å¼€å§‹è½¬æ¢ç»˜æœ¬:', book.title);
            console.log('ç»˜æœ¬æ•°æ®:', book);

            // åˆ›å»ºæ–°çš„é¢„åˆ¶ç»˜æœ¬æ•°æ®
            const presetBook = {
                id: book.id,
                title: book.title,
                description: book.description,
                author: book.author,
                coverImage: `./books/${book.id}/images/cover.jpg`,
                dataUrl: `./books/${book.id}/book-data.json`,
                source: 'preset'
            };

            // åˆ›å»ºé¡µé¢æ•°æ®
            const pagesData = book.pages.map((page, index) => ({
                id: index + 1,
                image: `./images/page${index + 1}.jpg`,
                narrator: `./audio/p${index + 1}.mp3`,
                characters: page.characters || [],
                text: page.text,
                pageType: page.pageType || 'public',
                options: page.options || []
            }));

            // åˆ›å»ºå®Œæ•´çš„ç»˜æœ¬æ•°æ®
            const bookData = {
                id: book.id,
                title: book.title,
                description: book.description,
                author: book.author,
                createdAt: new Date().toISOString(),
                pages: pagesData
            };

            // ç”ŸæˆJSONæ–‡ä»¶å†…å®¹
            const jsonContent = JSON.stringify(bookData, null, 2);
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'book-data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showSuccessMessage('ç»˜æœ¬æ•°æ®å·²å¯¼å‡ºä¸ºJSONæ–‡ä»¶ï¼è¯·å°†æ–‡ä»¶ä¿å­˜åˆ° books/æ‚¨çš„ç»˜æœ¬åç§°/ æ–‡ä»¶å¤¹ä¸­ã€‚');
            
            // è¯¢é—®æ˜¯å¦è¦æ›´æ–°é¢„åˆ¶ç»˜æœ¬åˆ—è¡¨
            if (confirm('æ˜¯å¦è¦å°†æ­¤ç»˜æœ¬æ·»åŠ åˆ°é¢„åˆ¶ç»˜æœ¬åˆ—è¡¨ä¸­ï¼Ÿ')) {
                // æ›´æ–°é¢„åˆ¶ç»˜æœ¬åˆ—è¡¨
                const existingIndex = PresetBooks.findIndex(pb => pb.id === bookId);
                if (existingIndex >= 0) {
                    PresetBooks[existingIndex] = presetBook;
                    console.log('æ›´æ–°äº†ç°æœ‰é¢„åˆ¶ç»˜æœ¬:', presetBook.title);
                } else {
                    PresetBooks.push(presetBook);
                    console.log('æ·»åŠ äº†æ–°é¢„åˆ¶ç»˜æœ¬:', presetBook.title);
                }
                
                // åˆ·æ–°ç»˜æœ¬åº“æ˜¾ç¤º
                AppState.renderBooksGrid();
                
                showSuccessMessage(`ç»˜æœ¬ã€Š${book.title}ã€‹å·²æˆåŠŸè½¬æ¢ä¸ºé¢„åˆ¶ç»˜æœ¬ï¼`);
            }
            
            return { presetBook, bookData, pagesData };
        }

        // åº”ç”¨çŠ¶æ€ç®¡ç†
        const AppState = {
            currentTab: 'library',
            currentBook: null,
            isReading: false,

            switchTab(tabName) {
                // éšè—æ‰€æœ‰tabå†…å®¹
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // æ˜¾ç¤ºç›®æ ‡tab
                document.getElementById(tabName).classList.add('active');
                
                // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                
                this.currentTab = tabName;
                
                // å¦‚æœåˆ‡æ¢åˆ°ç»˜æœ¬åº“ï¼Œåˆ·æ–°åˆ—è¡¨
                if (tabName === 'library') {
                    this.refreshLibrary();
                }
            },

            refreshLibrary() {
                this.loadBooks();
                this.renderBooksGrid();
            }
        };

        // ç®€åŒ–çš„ç»˜æœ¬ç®¡ç†ï¼ˆæ— æœ¬åœ°å­˜å‚¨ï¼‰
        class BookStorage {
            static save(book) {
                // ç®€å•æ·»åŠ IDå’Œåˆ›å»ºæ—¶é—´ï¼Œä½†ä¸ä¿å­˜åˆ°localStorage
                book.id = this.generateId();
                book.createdDate = new Date().toISOString();
                console.log('ç»˜æœ¬åˆ›å»ºæˆåŠŸï¼ˆä»…åœ¨å½“å‰ä¼šè¯æœ‰æ•ˆï¼‰');
                return book;
            }
            
            static getAll() {
                // è¿”å›å½“å‰ä¼šè¯ä¸­åˆ›å»ºçš„ç»˜æœ¬
                return savedBooks || [];
            }
            
            static getById(bookId) {
                return savedBooks.find(book => book.id === bookId);
            }
            
            static delete(bookId) {
                const index = savedBooks.findIndex(book => book.id === bookId);
                if (index > -1) {
                    savedBooks.splice(index, 1);
                }
            }
            
            static generateId() {
                return 'book_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            // å°†æ–‡ä»¶è½¬æ¢ä¸ºBase64
            static async fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            // å‹ç¼©å›¾ç‰‡å¹¶è½¬æ¢ä¸ºBase64
            static async compressImageAndConvert(file, maxWidth = 1200, quality = 0.8) {
                return new Promise((resolve, reject) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = () => {
                        // è®¡ç®—å‹ç¼©åçš„å°ºå¯¸
                        let { width, height } = img;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        // è®¾ç½®canvaså°ºå¯¸
                        canvas.width = width;
                        canvas.height = height;
                        
                        // ç»˜åˆ¶å¹¶å‹ç¼©å›¾ç‰‡
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        try {
                            // è¾“å‡ºä¸ºå‹ç¼©åçš„base64
                            const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                            console.log(`å›¾ç‰‡å‹ç¼©: ${file.name} åŸå°ºå¯¸ ${img.width}x${img.height} -> æ–°å°ºå¯¸ ${width}x${height}`);
                            resolve(compressedBase64);
                        } catch (error) {
                            console.error('å›¾ç‰‡å‹ç¼©å¤±è´¥:', error);
                            // å¦‚æœå‹ç¼©å¤±è´¥ï¼Œå›é€€åˆ°åŸæ–‡ä»¶
                            this.fileToBase64(file).then(resolve).catch(reject);
                        }
                    };
                    
                    img.onerror = () => {
                        console.error('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸæ–‡ä»¶');
                        // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå›é€€åˆ°åŸæ–‡ä»¶
                        this.fileToBase64(file).then(resolve).catch(reject);
                    };
                    
                    img.src = URL.createObjectURL(file);
                });
            }

            // éŸ³é¢‘å‹ç¼©ï¼ˆç®€åŒ–ç‰ˆæœ¬ - ä¸»è¦æ˜¯æ ¼å¼è½¬æ¢ï¼‰
            static async compressAudioAndConvert(file) {
                // å¯¹äºéŸ³é¢‘ï¼Œæˆ‘ä»¬æš‚æ—¶ä¸åšå¤æ‚çš„å‹ç¼©å¤„ç†
                // å¦‚æœæ–‡ä»¶è¿‡å¤§ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ éŸ³é¢‘å‹ç¼©é€»è¾‘
                if (file.size > 5 * 1024 * 1024) { // 5MBä»¥ä¸Šçš„éŸ³é¢‘ç»™å‡ºè­¦å‘Š
                    console.warn(`éŸ³é¢‘æ–‡ä»¶è¾ƒå¤§: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)ï¼Œå»ºè®®ä½¿ç”¨éŸ³é¢‘ç¼–è¾‘è½¯ä»¶é¢„å…ˆå‹ç¼©`);
                }
                return this.fileToBase64(file);
            }

            // å°†Base64è½¬æ¢ä¸ºBlob URL
            static base64ToUrl(base64Data) {
                if (!base64Data || !base64Data.startsWith('data:')) {
                    return null;
                }
                try {
                    // ä»Base64åˆ›å»ºBlob
                    const byteCharacters = atob(base64Data.split(',')[1]);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const mimeType = base64Data.split(',')[0].split(':')[1].split(';')[0];
                    const blob = new Blob([byteArray], { type: mimeType });
                    return URL.createObjectURL(blob);
                } catch (error) {
                    console.error('Base64è½¬æ¢å¤±è´¥:', error);
                    return null;
                }
            }
            
            // å°†Base64è½¬æ¢ä¸ºBlobï¼ˆç”¨äºå¯¼å‡ºï¼‰
            static base64ToBlob(base64Data) {
                if (!base64Data || !base64Data.startsWith('data:')) {
                    return null;
                }
                try {
                    const byteCharacters = atob(base64Data.split(',')[1]);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const mimeType = base64Data.split(',')[0].split(':')[1].split(';')[0];
                    return new Blob([byteArray], { type: mimeType });
                } catch (error) {
                    console.error('Base64è½¬Blobå¤±è´¥:', error);
                    return null;
                }
            }

            // è·å–å½“å‰ä¼šè¯ä¿¡æ¯ï¼ˆæ— å­˜å‚¨é™åˆ¶ï¼‰
            static getStorageInfo() {
                return {
                    totalBooks: savedBooks ? savedBooks.length : 0,
                    totalSizeMB: 'æ— é™åˆ¶',
                    remainingSpaceMB: 'æ— é™åˆ¶'
                };
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°å¹¶ç»™å‡ºå»ºè®®
            static checkFileSize(file, type = 'file') {
                const maxImageSize = 2 * 1024 * 1024; // 2MBå»ºè®®å¤§å°
                const maxAudioSize = 3 * 1024 * 1024; // 3MBå»ºè®®å¤§å°
                
                if (type === 'image' && file.size > maxImageSize) {
                    console.warn(`å›¾ç‰‡æ–‡ä»¶ ${file.name || 'æœªçŸ¥'} è¾ƒå¤§ (${(file.size/1024/1024).toFixed(2)}MB)ï¼Œå»ºè®®é€šè¿‡Figmaç­‰å·¥å…·å‹ç¼©åä¸Šä¼ `);
                } else if (type === 'audio' && file.size > maxAudioSize) {
                    console.warn(`éŸ³é¢‘æ–‡ä»¶ ${file.name || 'æœªçŸ¥'} è¾ƒå¤§ (${(file.size/1024/1024).toFixed(2)}MB)ï¼Œå»ºè®®å‹ç¼©åä¸Šä¼ `);
                }
                
                return file; // ç›´æ¥è¿”å›åŸæ–‡ä»¶ï¼Œä¸è¿›è¡Œå‹ç¼©
            }
        }

        // =============== æ–‡ä»¶åè§£æå™¨ç±» ===============
        class FileNameParser {
            // æå–æ–‡ä»¶åä¸­çš„æ•°å­—åºå·
            extractNumber(filename) {
                // å»æ‰æ–‡ä»¶æ‰©å±•å
                const nameWithoutExt = filename.replace(/\.[^/.]+$/, "");
                // æŸ¥æ‰¾æ•°å­—æ¨¡å¼
                const matches = nameWithoutExt.match(/(\d+)/g);
                if (matches && matches.length > 0) {
                    // å–æœ€åä¸€ä¸ªæ•°å­—ä½œä¸ºåºå·ï¼ˆé€šå¸¸æ˜¯æœ€ç›¸å…³çš„ï¼‰
                    return parseInt(matches[matches.length - 1]);
                }
                return null;
            }
            
            // æå–æ–‡ä»¶åå‰ç¼€ï¼ˆæ•°å­—å‰çš„éƒ¨åˆ†ï¼‰
            extractPrefix(filename) {
                const nameWithoutExt = filename.replace(/\.[^/.]+$/, "");
                return nameWithoutExt.replace(/\d+.*$/, '').trim();
            }
            
            // è§£æè§’è‰²éŸ³é¢‘æ–‡ä»¶å (æ ¼å¼: é¡µé¢å·-è§’è‰²å·.mp3)
            parseCharacterAudio(filename) {
                const nameWithoutExt = filename.replace(/\.[^/.]+$/, "");
                const match = nameWithoutExt.match(/^(\d+)-(\d+)$/);
                if (match) {
                    return {
                        pageNumber: parseInt(match[1]),
                        characterNumber: parseInt(match[2])
                    };
                }
                return null;
            }
            
            // è§£ææ—ç™½éŸ³é¢‘æ–‡ä»¶å (æ ¼å¼: pé¡µé¢å·.mp3)
            parseNarratorAudio(filename) {
                const nameWithoutExt = filename.replace(/\.[^/.]+$/, "");
                const match = nameWithoutExt.match(/^p(\d+)$/i);
                if (match) {
                    return {
                        pageNumber: parseInt(match[1])
                    };
                }
                return null;
            }
            
            // æŒ‰åºå·æ’åºæ–‡ä»¶
            sortByNumber(files) {
                return [...files].sort((a, b) => {
                    const numA = this.extractNumber(a.name) || 999999;
                    const numB = this.extractNumber(b.name) || 999999;
                    return numA - numB;
                });
            }
            
            // æŒ‰é¡µé¢å·åˆ†ç»„è§’è‰²éŸ³é¢‘
            groupCharacterAudiosByPage(characterFiles) {
                const grouped = {};
                characterFiles.forEach(file => {
                    const parsed = this.parseCharacterAudio(file.name);
                    if (parsed) {
                        const pageNum = parsed.pageNumber;
                        if (!grouped[pageNum]) {
                            grouped[pageNum] = [];
                        }
                        grouped[pageNum].push({
                            file: file,
                            characterNumber: parsed.characterNumber
                        });
                    }
                });
                
                // å¯¹æ¯ä¸ªé¡µé¢çš„è§’è‰²éŸ³é¢‘æŒ‰è§’è‰²ç¼–å·æ’åº
                Object.keys(grouped).forEach(pageNum => {
                    grouped[pageNum].sort((a, b) => a.characterNumber - b.characterNumber);
                });
                
                return grouped;
            }
            
            // è·å–æ–‡ä»¶æ’åºä¿¡æ¯ï¼ˆç”¨äºè°ƒè¯•ï¼‰
            getFileInfo(file) {
                const characterInfo = this.parseCharacterAudio(file.name);
                const narratorInfo = this.parseNarratorAudio(file.name);
                
                return {
                    name: file.name,
                    number: this.extractNumber(file.name),
                    prefix: this.extractPrefix(file.name),
                    characterInfo: characterInfo,
                    narratorInfo: narratorInfo
                };
            }
        }

        // =============== è‡ªåŠ¨åŒ¹é…å™¨ç±» ===============
        class AutoMatcher {
            constructor() {
                this.parser = new FileNameParser();
            }
            
            // è‡ªåŠ¨åŒ¹é…å›¾ç‰‡ã€æ—ç™½éŸ³é¢‘å’Œè§’è‰²éŸ³é¢‘
            autoMatch(imageFiles, narratorFiles, characterFiles = []) {
                console.log('å¼€å§‹è‡ªåŠ¨åŒ¹é…...');
                console.log('å›¾ç‰‡æ–‡ä»¶:', imageFiles.map(f => this.parser.getFileInfo(f)));
                console.log('æ—ç™½æ–‡ä»¶:', narratorFiles.map(f => this.parser.getFileInfo(f)));
                console.log('è§’è‰²æ–‡ä»¶:', characterFiles.map(f => this.parser.getFileInfo(f)));
                
                // æŒ‰åºå·æ’åºå›¾ç‰‡
                const sortedImages = this.parser.sortByNumber(imageFiles);
                
                // è§£ææ—ç™½éŸ³é¢‘ï¼ŒæŒ‰é¡µé¢å·åˆ†ç»„
                const narratorByPage = {};
                narratorFiles.forEach(file => {
                    const parsed = this.parser.parseNarratorAudio(file.name);
                    if (parsed) {
                        narratorByPage[parsed.pageNumber] = file;
                    }
                });
                
                // è§£æè§’è‰²éŸ³é¢‘ï¼ŒæŒ‰é¡µé¢å·åˆ†ç»„
                const characterByPage = this.parser.groupCharacterAudiosByPage(characterFiles);
                
                // è·å–æ‰€æœ‰é¡µé¢å·
                const allPageNumbers = new Set();
                sortedImages.forEach(img => {
                    const num = this.parser.extractNumber(img.name);
                    if (num) allPageNumbers.add(num);
                });
                Object.keys(narratorByPage).forEach(num => allPageNumbers.add(parseInt(num)));
                Object.keys(characterByPage).forEach(num => allPageNumbers.add(parseInt(num)));
                
                const sortedPageNumbers = Array.from(allPageNumbers).sort((a, b) => a - b);
                
                // ç”ŸæˆåŒ¹é…ç»“æœ
                const matches = [];
                sortedPageNumbers.forEach(pageNumber => {
                    // æ‰¾åˆ°å¯¹åº”çš„å›¾ç‰‡
                    const image = sortedImages.find(img => 
                        this.parser.extractNumber(img.name) === pageNumber
                    ) || null;
                    
                    // æ‰¾åˆ°å¯¹åº”çš„æ—ç™½
                    const narrator = narratorByPage[pageNumber] || null;
                    
                    // æ‰¾åˆ°å¯¹åº”çš„è§’è‰²éŸ³é¢‘
                    const characters = characterByPage[pageNumber] || [];
                    
                    matches.push({
                        pageNumber: pageNumber,
                        image: image,
                        narrator: narrator,
                        characters: characters,
                        imageIndex: image ? imageFiles.indexOf(image) : -1,
                        narratorIndex: narrator ? narratorFiles.indexOf(narrator) : -1,
                        characterIndices: characters.map(c => characterFiles.indexOf(c.file))
                    });
                });
                
                console.log('åŒ¹é…ç»“æœ:', matches);
                return matches;
            }
            
            // è·å–åŒ¹é…ç»Ÿè®¡ä¿¡æ¯
            getMatchStats(matches) {
                const totalMatches = matches.length;
                const perfectMatches = matches.filter(m => m.image && m.narrator).length;
                const imageOnly = matches.filter(m => m.image && !m.narrator).length;
                const narratorOnly = matches.filter(m => !m.image && m.narrator).length;
                const characterCount = matches.reduce((sum, m) => sum + m.characters.length, 0);
                
                return {
                    total: totalMatches,
                    perfect: perfectMatches,
                    imageOnly: imageOnly,
                    narratorOnly: narratorOnly,
                    characterCount: characterCount
                };
            }
        }

        // =============== éŸ³é¢‘åºåˆ—æ’­æ”¾å™¨ç±» ===============
        class AudioSequencePlayer {
            constructor(pageData) {
                this.pageData = pageData;
                this.audioQueue = this.buildAudioQueue(pageData);
                this.currentIndex = 0;
                this.isPlaying = false;
                this.currentAudio = null;
                this.onComplete = null;
            }

            buildAudioQueue(pageData) {
                const queue = [];
                console.log('æ„å»ºéŸ³é¢‘é˜Ÿåˆ—ï¼Œé¡µé¢æ•°æ®:', pageData);
                
                // æ·»åŠ æ—ç™½éŸ³é¢‘
                if (pageData.narratorUrl) {
                    console.log('æ·»åŠ æ—ç™½éŸ³é¢‘:', pageData.narratorUrl);
                    queue.push({
                        type: 'narrator',
                        audioUrl: pageData.narratorUrl,
                        name: 'æ—ç™½'
                    });
                }
                
                // æ·»åŠ 0.5ç§’é—´éš”
                if (pageData.narratorUrl && pageData.characters && pageData.characters.length > 0) {
                    queue.push({
                        type: 'silence',
                        duration: 0.5,
                        name: 'é—´éš”'
                    });
                }
                
                // æ·»åŠ è§’è‰²éŸ³é¢‘ï¼ˆæŒ‰orderæ’åºï¼‰
                if (pageData.characters) {
                    const sortedCharacters = pageData.characters
                        .filter(char => char.audioUrl) // åªæ·»åŠ æœ‰éŸ³é¢‘çš„è§’è‰²
                        .sort((a, b) => a.order - b.order);
                    
                    sortedCharacters.forEach(character => {
                        queue.push({
                            type: 'character',
                            characterId: character.id,
                            characterName: character.name,
                            audioUrl: character.audioUrl,
                            name: character.name
                        });
                    });
                }
                
                return queue;
            }

            play() {
                console.log('AudioSequencePlayer.play() è¢«è°ƒç”¨');
                console.log('éŸ³é¢‘é˜Ÿåˆ—:', this.audioQueue);
                
                if (this.audioQueue.length === 0) {
                    console.log('æ²¡æœ‰éŸ³é¢‘å¯æ’­æ”¾');
                    return;
                }
                
                this.isPlaying = true;
                this.currentIndex = 0;
                this.playNext();
            }

            playNext() {
                if (this.currentIndex >= this.audioQueue.length) {
                    this.complete();
                    return;
                }

                const currentItem = this.audioQueue[this.currentIndex];
                console.log(`æ’­æ”¾: ${currentItem.name} (${currentItem.type})`);

                if (currentItem.type === 'silence') {
                    // å¤„ç†é™éŸ³é—´éš”
                    setTimeout(() => {
                        this.currentIndex++;
                        this.playNext();
                    }, currentItem.duration * 1000);
                } else {
                    // æ’­æ”¾éŸ³é¢‘
                    this.currentAudio = new Audio(currentItem.audioUrl);
                    this.currentAudio.addEventListener('ended', () => {
                        this.currentIndex++;
                        this.playNext();
                    });
                    this.currentAudio.addEventListener('error', (e) => {
                        console.error('éŸ³é¢‘æ’­æ”¾é”™è¯¯:', e);
                        this.currentIndex++;
                        this.playNext();
                    });
                    this.currentAudio.play();
                }
            }

            pause() {
                this.isPlaying = false;
                if (this.currentAudio) {
                    this.currentAudio.pause();
                }
            }

            resume() {
                this.isPlaying = true;
                if (this.currentAudio) {
                    this.currentAudio.play();
                }
            }

            stop() {
                this.isPlaying = false;
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio = null;
                }
                this.currentIndex = 0;
            }

            complete() {
                this.isPlaying = false;
                this.currentAudio = null;
                this.currentIndex = 0;
                if (this.onComplete) {
                    this.onComplete();
                }
            }

            getCurrentStatus() {
                if (this.currentIndex < this.audioQueue.length) {
                    return this.audioQueue[this.currentIndex];
                }
                return null;
            }
        }

        // =============== 3Dç¿»é¡µé˜…è¯»å™¨ç±» ===============
        class DigitalBookReader {
            constructor(pagesData, bookTitle = "ç»˜æœ¬") {
                console.log('DigitalBookReader æ„é€ å‡½æ•°è¢«è°ƒç”¨');
                console.log('pagesData:', pagesData);
                console.log('bookTitle:', bookTitle);
                
                this.currentSpread = 0;
                this.totalPages = 0;
                this.pages = [];
                this.isAnimating = false;
                this.pagesData = pagesData; // ä»å¤–éƒ¨ä¼ å…¥çš„é¡µé¢æ•°æ®
                this.bookTitle = bookTitle;

                this.book = document.getElementById("book");
                this.currentSpreadEl = document.getElementById("currentSpread");
                this.leftPageContent = document.getElementById("leftPageContent");
                this.rightPageContent = document.getElementById("rightPageContent");
                this.pageIndicator = document.getElementById("pageIndicator");
                this.brightnessSlider = document.getElementById("brightness");
                this.bookContainer = document.getElementById("bookContainer");
                this.prevArea = document.getElementById("prevArea");
                this.nextArea = document.getElementById("nextArea");

                // è®¾ç½®ä¹¦ç±æ ‡é¢˜
                document.getElementById('currentBookTitle').textContent = this.bookTitle;

                this.initializeFromData();
                this.initializeEventListeners();

                setTimeout(() => {
                    this.repaginateContent();
                    this.adjustBrightness(this.brightnessSlider.value);
                }, 100);
            }

            initializeFromData() {
                // å°†ä¸Šä¼ çš„é¡µé¢æ•°æ®è½¬æ¢ä¸ºç¿»é¡µç³»ç»Ÿæ ¼å¼ - è·¨é¡µå›¾ç‰‡æ•ˆæœ
                this.bookElements = this.pagesData.map(page => ({
                    type: "spread-image",
                    src: page.imageUrl,
                    alt: `ç»˜æœ¬ç¬¬${this.pagesData.indexOf(page) + 1}é¡µ`,
                    text: page.text,
                    audioUrl: page.audioUrl
                }));
            }

            repaginateContent() {
                this.pages = [];
                
                this.bookElements.forEach(element => {
                    if (element.type === "spread-image") {
                        // æ¯ä¸ªè·¨é¡µå›¾ç‰‡ç”Ÿæˆå·¦å³ä¸¤é¡µ
                        this.pages.push([
                            { ...element, position: "left" },
                            { ...element, position: "right" }
                        ]);
                    } else {
                        this.pages.push([element]);
                    }
                });
                
                this.totalPages = this.pages.length;

                if (this.currentSpread * 2 >= this.totalPages) {
                    this.currentSpread = Math.max(0, Math.floor((this.totalPages - 1) / 2));
                }

                this.updateCurrentSpread();
                this.updateUI();
            }

            renderSpreadPart(element) {
                if (!element) return "";
                
                if (element.type === "spread-image") {
                    const cssClass = element.position === "left" ? "spread-image-left" : "spread-image-right";
                    return `<img src="${element.src}" alt="${element.alt}" class="${cssClass}">`;
                }
                return "";
            }

            updateCurrentSpread() {
                // å¯¹äºè·¨é¡µå›¾ç‰‡ï¼Œä¸€ä¸ªspreadå¯¹åº”ä¸€ä¸ªpageså…ƒç´ ï¼ŒåŒ…å«[left_part, right_part]
                const spreadIndex = this.currentSpread;
                const spreadData = this.pages[spreadIndex];
                
                const leftPage = spreadData ? [spreadData[0]] : null;
                const rightPage = spreadData ? [spreadData[1]] : null;
                
                this.leftPageContent.classList.remove('spread-content');
                this.rightPageContent.classList.remove('spread-content');
                this.leftPageContent.parentElement.classList.remove('spread-page');
                this.rightPageContent.parentElement.classList.remove('spread-page');
                this.bookContainer.classList.remove('has-spread-image');
                
                const hasSpreadImage = (leftPage && leftPage[0] && leftPage[0].type === 'spread-image') ||
                                      (rightPage && rightPage[0] && rightPage[0].type === 'spread-image');
                
                if (hasSpreadImage) {
                    this.leftPageContent.style.opacity = '0';
                    this.rightPageContent.style.opacity = '0';
                    
                    requestAnimationFrame(() => {
                        // ç›´æ¥æ¸²æŸ“å·¦å³éƒ¨åˆ†
                        this.leftPageContent.innerHTML = this.renderSpreadPart(spreadData[0]);
                        this.rightPageContent.innerHTML = this.renderSpreadPart(spreadData[1]);
                        
                        this.bookContainer.classList.add('has-spread-image');
                        
                        if (leftPage && leftPage[0] && leftPage[0].type === 'spread-image') {
                            this.leftPageContent.classList.add('spread-content');
                            this.leftPageContent.parentElement.classList.add('spread-page');
                        }
                        if (rightPage && rightPage[0] && rightPage[0].type === 'spread-image') {
                            this.rightPageContent.classList.add('spread-content');
                            this.rightPageContent.parentElement.classList.add('spread-page');
                        }
                        
                        this.leftPageContent.style.opacity = '1';
                        this.rightPageContent.style.opacity = '1';
                        
                        this.applyBrightnessToNewImages();
                    });
                } else {
                    // å¯¹äºéè·¨é¡µå›¾ç‰‡ï¼Œä¿æŒåŸæœ‰é€»è¾‘
                    this.leftPageContent.innerHTML = leftPage ? this.renderSpreadPart(spreadData[0]) : '';
                    this.rightPageContent.innerHTML = '';
                    
                    this.applyBrightnessToNewImages();
                }
            }

            nextSpread() {
                if (this.isAnimating || this.currentSpread >= this.totalPages - 1)
                    return;

                this.isAnimating = true;
                this.createFlippingPage("next");
            }

            prevSpread() {
                if (this.isAnimating || this.currentSpread <= 0) return;

                this.isAnimating = true;
                this.createFlippingPage("prev");
            }

            createFlippingPage(direction) {
                const flippingPage = document.createElement("div");
                flippingPage.className = `flipping-page ${direction}-flip`;

                const pageFront = document.createElement("div");
                pageFront.className = "page-front";

                const pageBack = document.createElement("div");
                pageBack.className = "page-back";

                let hasSpreadImage = false;

                // é¢„å…ˆæ£€æŸ¥æ˜¯å¦ä¸ºè·¨é¡µå›¾ç‰‡ä»¥é¿å…ä½ç§»
                const currentSpreadIndex = this.currentSpread;
                const targetSpreadIndex = direction === "next" ? this.currentSpread + 1 : this.currentSpread - 1;
                const currentSpreadData = this.pages[currentSpreadIndex];
                const targetSpreadData = this.pages[targetSpreadIndex];
                
                // å¦‚æœå½“å‰æˆ–ç›®æ ‡é¡µé¢æ˜¯è·¨é¡µå›¾ç‰‡ï¼Œç«‹å³åº”ç”¨ç±»é¿å…ä½ç§»
                if ((currentSpreadData && currentSpreadData[0] && currentSpreadData[0].type === 'spread-image') ||
                    (targetSpreadData && targetSpreadData[0] && targetSpreadData[0].type === 'spread-image')) {
                    flippingPage.classList.add('has-spread-image');
                    hasSpreadImage = true;
                }

                if (direction === "next") {
                    const currentSpread = this.pages[currentSpreadIndex];
                    const nextSpread = this.pages[targetSpreadIndex];
                    
                    const currentRightPage = currentSpread ? [currentSpread[1]] : null; // å½“å‰è·¨é¡µçš„å³ä¾§éƒ¨åˆ†
                    const nextLeftPage = nextSpread ? [nextSpread[0]] : null; // ä¸‹ä¸€è·¨é¡µçš„å·¦ä¾§éƒ¨åˆ†
                    
                    const frontPageContent = `<div class="page-content${currentRightPage && currentRightPage[0] && currentRightPage[0].type === 'spread-image' ? ' spread-content' : ''}">${currentSpread ? this.renderSpreadPart(currentSpread[1]) : ''}</div>`;
                    const backPageContent = `<div class="page-content${nextLeftPage && nextLeftPage[0] && nextLeftPage[0].type === 'spread-image' ? ' spread-content' : ''}">${nextSpread ? this.renderSpreadPart(nextSpread[0]) : ''}</div>`;

                    pageFront.innerHTML = frontPageContent;
                    pageBack.innerHTML = backPageContent;
                            
                    if (currentRightPage && currentRightPage[0] && currentRightPage[0].type === 'spread-image') {
                        pageFront.classList.add('spread-content');
                    }
                    if (nextLeftPage && nextLeftPage[0] && nextLeftPage[0].type === 'spread-image') {
                        pageBack.classList.add('spread-content');
                    }
                } else {
                    const currentSpread = this.pages[currentSpreadIndex];
                    const prevSpread = this.pages[targetSpreadIndex];
                    
                    const currentLeftPage = currentSpread ? [currentSpread[0]] : null; // å½“å‰è·¨é¡µçš„å·¦ä¾§éƒ¨åˆ†
                    const prevLeftPage = prevSpread ? [prevSpread[0]] : null; // ä¸Šä¸€è·¨é¡µçš„å·¦ä¾§éƒ¨åˆ†
                    
                    const frontPageContent = `<div class="page-content${currentLeftPage && currentLeftPage[0] && currentLeftPage[0].type === 'spread-image' ? ' spread-content' : ''}">${currentSpread ? this.renderSpreadPart(currentSpread[0]) : ''}</div>`;
                    const backPageContent = `<div class="page-content${prevLeftPage && prevLeftPage[0] && prevLeftPage[0].type === 'spread-image' ? ' spread-content' : ''}">${prevSpread ? this.renderSpreadPart(prevSpread[0]) : ''}</div>`;

                    pageFront.innerHTML = frontPageContent;
                    pageBack.innerHTML = backPageContent;
                            
                    if (currentLeftPage && currentLeftPage[0] && currentLeftPage[0].type === 'spread-image') {
                        pageFront.classList.add('spread-content');
                    }
                    if (prevLeftPage && prevLeftPage[0] && prevLeftPage[0].type === 'spread-image') {
                        pageBack.classList.add('spread-content');
                    }
                }

                flippingPage.appendChild(pageFront);
                flippingPage.appendChild(pageBack);
                this.book.appendChild(flippingPage);

                requestAnimationFrame(() => {
                    flippingPage.classList.add("flipping");
                });

                setTimeout(() => {
                    if (direction === "next") {
                        this.currentSpread++;
                    } else {
                        this.currentSpread--;
                    }
                    this.updateCurrentSpread();
                    this.updateUI();
                    
                    // è§¦å‘éŸ³é¢‘æ’­æ”¾
                    this.triggerAudioForCurrentSpread();
                }, 500);

                setTimeout(() => {
                    this.book.removeChild(flippingPage);
                    this.isAnimating = false;
                }, 1250);
            }

            updateUI() {
                // å¯¹äºè·¨é¡µå›¾ç‰‡ï¼Œæ¯ä¸ªspreadä»£è¡¨ä¸€ä¸ªå®Œæ•´çš„é¡µé¢
                const currentPageNum = this.currentSpread + 1;
                const totalPageNum = this.totalPages;
                this.pageIndicator.textContent = `Page ${currentPageNum} of ${totalPageNum}`;
            }

            adjustBrightness(value) {
                const brightness = parseFloat(value);
                
                this.bookContainer.style.setProperty("--image-brightness", brightness);
                this.applyBrightnessToNewImages();
            }
            
            applyBrightnessToNewImages() {
                const brightness = this.brightnessSlider.value;
                const images = this.bookContainer.querySelectorAll('img');
                images.forEach(img => {
                    img.style.filter = `brightness(${brightness})`;
                });
            }

            initializeEventListeners() {
                this.prevArea.addEventListener("click", () => this.prevSpread());
                this.nextArea.addEventListener("click", () => this.nextSpread());

                this.brightnessSlider.addEventListener("input", (e) =>
                    this.adjustBrightness(e.target.value)
                );

                document.addEventListener("keydown", (e) => {
                    if (document.getElementById('bookReader').style.display === 'block') {
                        switch(e.key) {
                            case 'ArrowLeft':
                                this.prevSpread();
                                break;
                            case 'ArrowRight':
                                this.nextSpread();
                                break;
                        }
                    }
                });
            }

            goToPage(pageIndex) {
                // ç¡®ä¿é¡µé¢ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
                if (pageIndex < 0 || pageIndex >= this.totalPages) {
                    console.error('é¡µé¢ç´¢å¼•è¶…å‡ºèŒƒå›´:', pageIndex);
                    return;
                }
                
                // æ›´æ–°å½“å‰è·¨é¡µç´¢å¼•
                this.currentSpread = pageIndex;
                
                // æ›´æ–°é¡µé¢æ˜¾ç¤º
                this.updateUI();
                
                // æ›´æ–°å½“å‰é¡µé¢å†…å®¹
                const currentSpread = this.pages[this.currentSpread];
                if (currentSpread) {
                    this.leftPageContent.innerHTML = `<div class="page-content${currentSpread[0] && currentSpread[0].type === 'spread-image' ? ' spread-content' : ''}">${this.renderSpreadPart(currentSpread[0])}</div>`;
                    this.rightPageContent.innerHTML = `<div class="page-content${currentSpread[1] && currentSpread[1].type === 'spread-image' ? ' spread-content' : ''}">${this.renderSpreadPart(currentSpread[1])}</div>`;
                }
                
                // è§¦å‘éŸ³é¢‘æ’­æ”¾
                this.triggerAudioForCurrentSpread();
            }

            triggerAudioForCurrentSpread() {
                // è·å–å½“å‰è·¨é¡µå¯¹åº”çš„åŸå§‹é¡µé¢æ•°æ®
                const originalPageIndex = this.currentSpread;
                console.log('triggerAudioForCurrentSpread è¢«è°ƒç”¨ï¼Œé¡µé¢ç´¢å¼•:', originalPageIndex);
                
                if (originalPageIndex < this.pagesData.length) {
                    const pageData = this.pagesData[originalPageIndex];
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ—ç™½éŸ³é¢‘æˆ–è§’è‰²éŸ³é¢‘
                    const hasAudio = (pageData && pageData.narratorUrl) || 
                                   (pageData && pageData.characters && pageData.characters.length > 0);
                    
                    console.log('é¡µé¢æ•°æ®:', pageData);
                    console.log('æ˜¯å¦æœ‰éŸ³é¢‘:', hasAudio);
                    console.log('è‡ªåŠ¨æ’­æ”¾çŠ¶æ€:', autoPlay);
                    
                    if (hasAudio) {
                        // æ›´æ–°å…¨å±€çš„å½“å‰é¡µé¢ç´¢å¼•
                        currentPage = originalPageIndex;
                        // æ’­æ”¾éŸ³é¢‘
                        if (autoPlay) {
                            console.log('å‡†å¤‡æ’­æ”¾é¡µé¢éŸ³é¢‘ï¼Œé¡µé¢ç´¢å¼•:', originalPageIndex);
                            setTimeout(() => playCurrentPage(), 300);
                        }
                    }
                }
            }
        }

        // =============== å¯¼å…¥ç»˜æœ¬åŠŸèƒ½ ===============
        let importedBookData = null;

        // å¤„ç†æ–‡ä»¶å¯¼å…¥
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.json')) {
                showErrorMessage('è¯·é€‰æ‹©JSONæ ¼å¼çš„æ–‡ä»¶ï¼');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    validateAndPreviewImport(data);
                } catch (error) {
                    console.error('JSONè§£æé”™è¯¯:', error);
                    showErrorMessage('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·ç¡®ä¿æ˜¯æœ‰æ•ˆçš„JSONæ–‡ä»¶ï¼');
                }
            };
            reader.readAsText(file);
        }

        // éªŒè¯å¹¶é¢„è§ˆå¯¼å…¥æ•°æ®
        function validateAndPreviewImport(data) {
            // éªŒè¯å¿…è¦å­—æ®µ
            if (!data.title || !data.pages || !Array.isArray(data.pages)) {
                showErrorMessage('ç»˜æœ¬æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘å¿…è¦å­—æ®µï¼');
                return;
            }

            if (data.pages.length === 0) {
                showErrorMessage('ç»˜æœ¬æ•°æ®ä¸­æ²¡æœ‰é¡µé¢ï¼');
                return;
            }

            // éªŒè¯é¡µé¢æ•°æ®
            for (let i = 0; i < data.pages.length; i++) {
                const page = data.pages[i];
                if (!page.image || !page.narrator) {
                    showErrorMessage(`ç¬¬${i + 1}é¡µç¼ºå°‘å›¾ç‰‡æˆ–éŸ³é¢‘æ•°æ®ï¼`);
                    return;
                }
            }

            // ä¿å­˜å¯¼å…¥æ•°æ®
            importedBookData = data;

            // æ˜¾ç¤ºé¢„è§ˆ
            showImportPreview(data);
        }

        // æ˜¾ç¤ºå¯¼å…¥é¢„è§ˆ
        function showImportPreview(data) {
            const preview = document.getElementById('importPreview');
            const info = document.getElementById('importInfo');
            
            const pageTypes = data.pages.reduce((acc, page) => {
                const type = page.pageType || 'public';
                acc[type] = (acc[type] || 0) + 1;
                return acc;
            }, {});

            const optionsCount = data.pages.reduce((acc, page) => {
                return acc + (page.options ? page.options.length : 0);
            }, 0);

            info.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <strong>ğŸ“– ç»˜æœ¬åç§°:</strong><br>
                        <span style="color: #666;">${data.title}</span>
                    </div>
                    <div>
                        <strong>âœï¸ ä½œè€…:</strong><br>
                        <span style="color: #666;">${data.author || 'æœªçŸ¥'}</span>
                    </div>
                    <div>
                        <strong>ğŸ“ ç®€ä»‹:</strong><br>
                        <span style="color: #666;">${data.description || 'æ— '}</span>
                    </div>
                    <div>
                        <strong>ğŸ“Š é¡µé¢ç»Ÿè®¡:</strong><br>
                        <span style="color: #666;">å…± ${data.pages.length} é¡µ</span>
                    </div>
                </div>
                <div style="background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                    <strong>ğŸ“‹ é¡µé¢ç±»å‹åˆ†å¸ƒ:</strong><br>
                    <span style="color: #666;">
                        ${pageTypes.public ? `å…¬å…±é¡µ: ${pageTypes.public} é¡µ` : ''}
                        ${pageTypes.interactive ? ` | äº’åŠ¨é¡µ: ${pageTypes.interactive} é¡µ` : ''}
                        ${optionsCount > 0 ? ` | é€‰é¡¹æ€»æ•°: ${optionsCount} ä¸ª` : ''}
                    </span>
                </div>
                <div style="color: #28a745; font-weight: bold;">
                    âœ… æ•°æ®éªŒè¯é€šè¿‡ï¼Œå¯ä»¥å¯¼å…¥ï¼
                </div>
            `;

            preview.style.display = 'block';
        }

        // ç¡®è®¤å¯¼å…¥
        async function confirmImport() {
            if (!importedBookData) {
                showErrorMessage('æ²¡æœ‰å¯å¯¼å…¥çš„æ•°æ®ï¼');
                return;
            }

            try {
                showLoadingMessage('æ­£åœ¨å¯¼å…¥ç»˜æœ¬...');

                // è½¬æ¢æ•°æ®æ ¼å¼ - å¤„ç†æ–‡ä»¶è·¯å¾„
                const convertedPages = [];
                
                console.log('å¼€å§‹è½¬æ¢å¯¼å…¥æ•°æ®ï¼Œå…±', importedBookData.pages.length, 'é¡µ');
                
                for (let i = 0; i < importedBookData.pages.length; i++) {
                    const page = importedBookData.pages[i];
                    console.log(`å¤„ç†ç¬¬ ${i + 1} é¡µ:`, page);
                    
                    // å¤„ç†å›¾ç‰‡æ•°æ®
                    let imageBase64 = '';
                    if (page.image) {
                        if (page.image.startsWith('data:')) {
                            // å·²ç»æ˜¯base64æ ¼å¼
                            console.log(`ç¬¬ ${i + 1} é¡µå›¾ç‰‡å·²æ˜¯base64æ ¼å¼`);
                            imageBase64 = page.image;
                        } else {
                            // æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œéœ€è¦è½¬æ¢ä¸ºbase64
                            console.log(`ç¬¬ ${i + 1} é¡µå›¾ç‰‡è·¯å¾„: ${page.image}`);
                            try {
                                // å°è¯•ä½¿ç”¨ç›¸å¯¹è·¯å¾„åŠ è½½å›¾ç‰‡
                                const imageUrl = page.image.startsWith('./') ? page.image : './' + page.image;
                                console.log(`å°è¯•åŠ è½½å›¾ç‰‡: ${imageUrl}`);
                                
                                const imageResponse = await fetch(imageUrl);
                                console.log(`å›¾ç‰‡å“åº”çŠ¶æ€: ${imageResponse.status}`);
                                if (imageResponse.ok) {
                                    const imageBlob = await imageResponse.blob();
                                    console.log(`å›¾ç‰‡blobå¤§å°: ${imageBlob.size} bytes`);
                                    imageBase64 = await convertBlobToBase64(imageBlob);
                                    console.log(`å›¾ç‰‡è½¬æ¢æˆåŠŸï¼Œbase64é•¿åº¦: ${imageBase64.length}`);
                                } else {
                                    console.warn(`æ— æ³•åŠ è½½å›¾ç‰‡: ${imageUrl}, çŠ¶æ€: ${imageResponse.status}`);
                                    imageBase64 = createPlaceholderImage(800, 600, `å›¾ç‰‡ ${i + 1}`);
                                }
                            } catch (error) {
                                console.warn(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${page.image}`, error);
                                console.log('CORSé”™è¯¯ï¼Œåˆ›å»ºå ä½å›¾ç‰‡');
                                imageBase64 = createPlaceholderImage(800, 600, `å›¾ç‰‡ ${i + 1}`);
                            }
                        }
                    } else {
                        console.warn(`ç¬¬ ${i + 1} é¡µæ²¡æœ‰å›¾ç‰‡æ•°æ®`);
                        imageBase64 = createPlaceholderImage(800, 600, `å›¾ç‰‡ ${i + 1}`);
                    }

                    // å¤„ç†éŸ³é¢‘æ•°æ®
                    let audioBase64 = '';
                    if (page.narrator) {
                        if (page.narrator.startsWith('data:')) {
                            // å·²ç»æ˜¯base64æ ¼å¼
                            console.log(`ç¬¬ ${i + 1} é¡µéŸ³é¢‘å·²æ˜¯base64æ ¼å¼`);
                            audioBase64 = page.narrator;
                        } else {
                            // æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œéœ€è¦è½¬æ¢ä¸ºbase64
                            console.log(`ç¬¬ ${i + 1} é¡µéŸ³é¢‘è·¯å¾„: ${page.narrator}`);
                            try {
                                // å°è¯•ä½¿ç”¨ç›¸å¯¹è·¯å¾„åŠ è½½éŸ³é¢‘
                                const audioUrl = page.narrator.startsWith('./') ? page.narrator : './' + page.narrator;
                                console.log(`å°è¯•åŠ è½½éŸ³é¢‘: ${audioUrl}`);
                                
                                const audioResponse = await fetch(audioUrl);
                                console.log(`éŸ³é¢‘å“åº”çŠ¶æ€: ${audioResponse.status}`);
                                if (audioResponse.ok) {
                                    const audioBlob = await audioResponse.blob();
                                    console.log(`éŸ³é¢‘blobå¤§å°: ${audioBlob.size} bytes`);
                                    audioBase64 = await convertBlobToBase64(audioBlob);
                                    console.log(`éŸ³é¢‘è½¬æ¢æˆåŠŸï¼Œbase64é•¿åº¦: ${audioBase64.length}`);
                                } else {
                                    console.warn(`æ— æ³•åŠ è½½éŸ³é¢‘: ${audioUrl}, çŠ¶æ€: ${audioResponse.status}`);
                                    // åˆ›å»ºé™éŸ³éŸ³é¢‘
                                    audioBase64 = await createSilentAudio(1000); // 1ç§’é™éŸ³
                                }
                            } catch (error) {
                                console.warn(`éŸ³é¢‘åŠ è½½å¤±è´¥: ${page.narrator}`, error);
                                console.log('CORSé”™è¯¯ï¼Œåˆ›å»ºé™éŸ³éŸ³é¢‘');
                                // åˆ›å»ºé™éŸ³éŸ³é¢‘
                                audioBase64 = await createSilentAudio(1000); // 1ç§’é™éŸ³
                            }
                        }
                    } else {
                        console.warn(`ç¬¬ ${i + 1} é¡µæ²¡æœ‰éŸ³é¢‘æ•°æ®`);
                        audioBase64 = await createSilentAudio(1000); // 1ç§’é™éŸ³
                    }

                    convertedPages.push({
                        id: page.id || `page_${i}`,
                        imageBase64: imageBase64,
                        audioBase64: audioBase64,
                        text: page.text || '',
                        pageType: page.pageType || 'public',
                        options: page.options || [],
                        characters: page.characters || []
                    });
                }

                // åˆ›å»ºç»˜æœ¬å¯¹è±¡
                const bookData = {
                    title: importedBookData.title,
                    author: importedBookData.author || 'ç»˜æœ¬æ™ºèƒ½ä½“',
                    description: importedBookData.description || `åŒ…å« ${convertedPages.length} é¡µçš„ç²¾ç¾ç»˜æœ¬`,
                    coverImage: convertedPages[0]?.imageBase64,
                    pages: convertedPages.map(page => ({
                        id: page.id,
                        image: page.imageBase64,
                        narrator: page.audioBase64,
                        text: page.text,
                        pageType: page.pageType,
                        options: page.options
                    }))
                };

                // ä¿å­˜ç»˜æœ¬
                const savedBook = BookStorage.save(bookData);
                savedBooks.push(savedBook);

                // éšè—åŠ è½½æç¤º
                hideLoadingMessage();

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showSuccessMessage(`ç»˜æœ¬ã€Š${bookData.title}ã€‹å¯¼å…¥æˆåŠŸï¼å·²æ·»åŠ åˆ°ç»˜æœ¬åº“ (å…± ${savedBooks.length} æœ¬ç»˜æœ¬)`);

                // æ¸…ç©ºå¯¼å…¥æ•°æ®
                importedBookData = null;
                document.getElementById('importPreview').style.display = 'none';
                document.getElementById('fileInput').value = '';

                // åˆ‡æ¢åˆ°ç»˜æœ¬åº“
                setTimeout(() => {
                    AppState.switchTab('library');
                }, 2000);

            } catch (error) {
                console.error('å¯¼å…¥å¤±è´¥:', error);
                hideLoadingMessage();
                showErrorMessage('å¯¼å…¥å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            }
        }

        // è½¬æ¢Blobä¸ºBase64
        function convertBlobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // åˆ›å»ºå ä½å›¾ç‰‡
        function createPlaceholderImage(width, height, text) {
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            
            // èƒŒæ™¯è‰²
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, width, height);
            
            // è¾¹æ¡†
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 2;
            ctx.strokeRect(0, 0, width, height);
            
            // æ–‡å­—
            ctx.fillStyle = '#666';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, width / 2, height / 2);
            
            return canvas.toDataURL('image/png');
        }

        // åˆ›å»ºé™éŸ³éŸ³é¢‘
        function createSilentAudio(duration) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const sampleRate = audioContext.sampleRate;
            const length = sampleRate * duration / 1000;
            const buffer = audioContext.createBuffer(1, length, sampleRate);
            
            // åˆ›å»ºé™éŸ³æ•°æ®
            const channelData = buffer.getChannelData(0);
            for (let i = 0; i < length; i++) {
                channelData[i] = 0;
            }
            
            // è½¬æ¢ä¸ºWAVæ ¼å¼çš„base64
            const wav = encodeWAV(buffer);
            const blob = new Blob([wav], { type: 'audio/wav' });
            
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        }

        // ç¼–ç WAVæ ¼å¼
        function encodeWAV(buffer) {
            const length = buffer.length;
            const arrayBuffer = new ArrayBuffer(44 + length * 2);
            const view = new DataView(arrayBuffer);
            
            // WAVæ–‡ä»¶å¤´
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, buffer.sampleRate, true);
            view.setUint32(28, buffer.sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, length * 2, true);
            
            // å†™å…¥éŸ³é¢‘æ•°æ®
            const channelData = buffer.getChannelData(0);
            let offset = 44;
            for (let i = 0; i < length; i++) {
                const sample = Math.max(-1, Math.min(1, channelData[i]));
                view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
                offset += 2;
            }
            
            return arrayBuffer;
        }

        // æ·»åŠ æ‹–æ‹½åŠŸèƒ½
        function initializeDragAndDrop() {
            const dropZone = document.getElementById('fileDropZone');
            
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.name.toLowerCase().endsWith('.json')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            try {
                                const data = JSON.parse(e.target.result);
                                validateAndPreviewImport(data);
                            } catch (error) {
                                console.error('JSONè§£æé”™è¯¯:', error);
                                showErrorMessage('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·ç¡®ä¿æ˜¯æœ‰æ•ˆçš„JSONæ–‡ä»¶ï¼');
                            }
                        };
                        reader.readAsText(file);
                    } else {
                        showErrorMessage('è¯·é€‰æ‹©JSONæ ¼å¼çš„æ–‡ä»¶ï¼');
                    }
                }
            });
        }

        // =============== å¯¼èˆªå’Œæ ‡ç­¾é¡µç®¡ç† ===============
        function switchToCreateTab() {
            AppState.switchTab('create');
        }

        function switchToLibraryTab() {
            AppState.switchTab('library');
        }

        // =============== ä¸»åˆå§‹åŒ–å‡½æ•° ===============
        function initializeApp() {
            console.log('å¼€å§‹åˆå§‹åŒ–åº”ç”¨...');
            
            // åˆå§‹åŒ–å¯¼èˆªäº‹ä»¶
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    AppState.switchTab(tabName);
                });
            });
            
            // åŠ è½½ä¿å­˜çš„ç»˜æœ¬
            AppState.loadBooks();
            AppState.renderBooksGrid();
            
            // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
            initializeFileUploads();
            
            // åˆå§‹åŒ–éŸ³é¢‘æ’­æ”¾äº‹ä»¶
            initializeAudioEvents();
            
            // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
            initializeDragAndDrop();
            
            // åˆå§‹åŒ–è¡¨å•å’ŒUI
            updateSelects();
            updatePageList();
            updateGenerateButton();
            initializeCompressionControls();
            
            // è®¾ç½®è‡ªåŠ¨æ’­æ”¾æŒ‰é’®åˆå§‹çŠ¶æ€
            const autoPlayBtn = document.getElementById('autoPlayBtn');
            if (autoPlayBtn) {
                autoPlayBtn.classList.add('active');
            }
            
            // åˆå§‹åŒ–è‡ªåŠ¨åŒ¹é…å™¨
            autoMatcher = new AutoMatcher();
            
            console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
        }
        
        // æ–‡ä»¶ä¸Šä¼ åˆå§‹åŒ–
        function initializeFileUploads() {
            // æ—ç™½éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ 
            const narratorFilesInput = document.getElementById('narratorFiles');
            if (narratorFilesInput) {
                narratorFilesInput.addEventListener('change', function(e) {
                    const newFiles = Array.from(e.target.files);
                    if (newFiles.length > 0) {
                        newFiles.forEach(file => {
                            if (!narratorFiles.find(f => f.name === file.name && f.size === file.size)) {
                                narratorFiles.push(file);
                            }
                        });
                        updateNarratorList();
                        updateSelects();
                        
                        // æ˜¾ç¤ºä¸Šä¼ æˆåŠŸæç¤º
                        showUploadFeedback('narratorUpload', `æˆåŠŸä¸Šä¼  ${newFiles.length} ä¸ªæ—ç™½éŸ³é¢‘ï¼`);
                    }
                    this.value = '';
                });
            }

            // è§’è‰²éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ 
            const characterFilesInput = document.getElementById('characterFiles');
            if (characterFilesInput) {
                characterFilesInput.addEventListener('change', function(e) {
                    const newFiles = Array.from(e.target.files);
                    if (newFiles.length > 0) {
                        newFiles.forEach(file => {
                            if (!characterFiles.find(f => f.name === file.name && f.size === file.size)) {
                                characterFiles.push(file);
                            }
                        });
                        updateCharacterList();
                        updateCharacterSelects();
                        
                        // æ˜¾ç¤ºä¸Šä¼ æˆåŠŸæç¤º
                        showUploadFeedback('characterUpload', `æˆåŠŸä¸Šä¼  ${newFiles.length} ä¸ªè§’è‰²éŸ³é¢‘ï¼`);
                    }
                    this.value = '';
                });
            }

            // å›¾ç‰‡æ–‡ä»¶ä¸Šä¼ 
            const imageFilesInput = document.getElementById('imageFiles');
            if (imageFilesInput) {
                imageFilesInput.addEventListener('change', function(e) {
                    const newFiles = Array.from(e.target.files);
                    if (newFiles.length > 0) {
                        newFiles.forEach(file => {
                            if (!imageFiles.find(f => f.name === file.name && f.size === file.size)) {
                                imageFiles.push(file);
                            }
                        });
                        updateImageList();
                        updateSelects();
                        
                        // æ˜¾ç¤ºä¸Šä¼ æˆåŠŸæç¤º
                        showUploadFeedback('imageUpload', `æˆåŠŸä¸Šä¼  ${newFiles.length} ä¸ªå›¾ç‰‡æ–‡ä»¶ï¼`);
                    }
                    // æ¸…ç©ºè¾“å…¥æ¡†ï¼Œå…è®¸é‡å¤é€‰æ‹©ç›¸åŒæ–‡ä»¶
                    this.value = '';
                });
            }
        }
        
        // å‹ç¼©æ§åˆ¶åˆå§‹åŒ–
        function initializeCompressionControls() {
            const qualitySlider = document.getElementById('imageQuality');
            const qualityDisplay = document.getElementById('qualityDisplay');
            
            if (qualitySlider && qualityDisplay) {
                qualitySlider.addEventListener('input', function(e) {
                    qualityDisplay.textContent = e.target.value;
                });
            }
        }
        
        // éŸ³é¢‘æ’­æ”¾äº‹ä»¶åˆå§‹åŒ–
        function initializeAudioEvents() {
            // ç§»é™¤æ—§çš„audioPlayeräº‹ä»¶ç›‘å¬å™¨ï¼Œç°åœ¨ä½¿ç”¨AudioSequencePlayer
            console.log('éŸ³é¢‘äº‹ä»¶åˆå§‹åŒ–å®Œæˆ - ä½¿ç”¨AudioSequencePlayer');
        }

        // =============== ç»˜æœ¬åº“ç®¡ç† ===============
        AppState.loadBooks = function() {
            // åˆå§‹åŒ–ç©ºçš„ç»˜æœ¬åˆ—è¡¨ï¼ˆä»…å½“å‰ä¼šè¯æœ‰æ•ˆï¼‰
            if (!savedBooks) {
                savedBooks = [];
            }
        };

        AppState.renderBooksGrid = function() {
            const booksGrid = document.getElementById('booksGrid');
            const emptyState = document.getElementById('emptyState');
            
            // æ›´æ–°å­˜å‚¨ä¿¡æ¯æ˜¾ç¤º
            this.updateStorageInfo();
            
            // åˆå¹¶é¢„ç½®ç»˜æœ¬å’Œç”¨æˆ·ç»˜æœ¬
            const allBooks = [...PresetBooks, ...savedBooks];
            
            if (allBooks.length === 0) {
                emptyState.style.display = 'block';
                // æ¸…é™¤å…¶ä»–å†…å®¹
                const existingCards = booksGrid.querySelectorAll('.book-card');
                existingCards.forEach(card => card.remove());
                return;
            }
            
            emptyState.style.display = 'none';
            
            // æ¸…é™¤ç°æœ‰å¡ç‰‡
            const existingCards = booksGrid.querySelectorAll('.book-card');
            existingCards.forEach(card => card.remove());
            
            // ç”Ÿæˆç»˜æœ¬å¡ç‰‡
            allBooks.forEach(book => {
                const bookCard = createBookCard(book);
                booksGrid.appendChild(bookCard);
            });
        };

        AppState.updateStorageInfo = function() {
            const storageInfoEl = document.getElementById('storageInfo');
            if (storageInfoEl) {
                const info = BookStorage.getStorageInfo();
                
                storageInfoEl.innerHTML = `
                    <i class="fas fa-memory"></i> 
                    å½“å‰ä¼šè¯ï¼š${info.totalBooks} æœ¬ç»˜æœ¬ï¼ˆåˆ·æ–°é¡µé¢åå°†æ¸…ç©ºï¼‰
                `;
                storageInfoEl.style.color = 'rgba(255,255,255,0.8)';
            }
        };

        function createBookCard(book) {
            const card = document.createElement('div');
            card.className = 'book-card';
            card.setAttribute('data-book-id', book.id);
            
            // å¤„ç†å°é¢å›¾ç‰‡URL
            let coverImageUrl = '';
            if (book.coverImage) {
                if (book.coverImage.startsWith('data:')) {
                    // ç”¨æˆ·ç»˜æœ¬ï¼šBase64æ•°æ®
                    coverImageUrl = BookStorage.base64ToUrl(book.coverImage);
                } else {
                    // é¢„ç½®ç»˜æœ¬ï¼šç›¸å¯¹è·¯å¾„
                    coverImageUrl = book.coverImage;
                }
            }
            
            // å¤„ç†åˆ›å»ºæ—¥æœŸ
            const createdDate = book.createdDate ? 
                new Date(book.createdDate).toLocaleDateString('zh-CN') : 
                'é¢„ç½®ç»˜æœ¬';
            
            // å¤„ç†é¡µé¢æ•°é‡
            const pageCount = book.pages ? book.pages.length : 'æœªçŸ¥';
            
            // ç”Ÿæˆæ“ä½œæŒ‰é’®
            const actionButtons = book.source === 'preset' ? 
                `<button class="overlay-btn" onclick="loadPresetBook('${book.id}')">
                    <i class="fas fa-book-open"></i> é˜…è¯»
                </button>` :
                `<button class="overlay-btn" onclick="openBookForReading('${book.id}')">
                    <i class="fas fa-book-open"></i> é˜…è¯»
                </button>
                <button class="overlay-btn" onclick="editBook('${book.id}')" style="background: #ffc107;">
                    <i class="fas fa-edit"></i> ç¼–è¾‘
                </button>
                <button class="overlay-btn" onclick="convertGeneratedBookToPreset('${book.id}')" style="background: #28a745;">
                    <i class="fas fa-magic"></i> è½¬ä¸ºé¢„åˆ¶
                </button>
                <button class="overlay-btn" onclick="exportAsPresetBook('${book.id}')" style="background: #17a2b8;">
                    <i class="fas fa-download"></i> å¯¼å‡ºé¢„ç½®
                </button>
                <button class="overlay-btn" onclick="deleteBook('${book.id}')">
                    <i class="fas fa-trash"></i> åˆ é™¤
                </button>`;
            
            card.innerHTML = `
                <div class="book-cover">
                    ${coverImageUrl ? 
                        `<img src="${coverImageUrl}" alt="${book.title || 'ç»˜æœ¬å°é¢'}" onerror="this.parentElement.innerHTML='<div class=&quot;placeholder&quot;><i class=&quot;fas fa-book&quot;></i></div>'">` : 
                        `<div class="placeholder"><i class="fas fa-book"></i></div>`
                    }

                    <div class="book-overlay">
                        ${actionButtons}
                    </div>
                </div>
                <div class="book-info">
                    <h3>${book.title || 'æœªå‘½åç»˜æœ¬'}</h3>
                    <p class="book-description">${book.description || 'æš‚æ— æè¿°'}</p>
                    <div class="book-meta">
                        <span><i class="fas fa-user"></i> ${book.author || 'æœªçŸ¥ä½œè€…'}</span>
                        <span><i class="fas fa-calendar"></i> ${createdDate}</span>
                        <span><i class="fas fa-file-alt"></i> ${pageCount} é¡µ</span>
                    </div>
                    <div class="book-tags">
                        <span class="tag">ç»˜æœ¬</span>

                        ${pageCount > 5 ? '<span class="tag">é•¿ç¯‡</span>' : '<span class="tag">çŸ­ç¯‡</span>'}
                    </div>
                </div>
            `;
            
            return card;
        }

        // åŠ è½½é¢„ç½®ç»˜æœ¬
        // æµ‹è¯•æ–‡ä»¶è®¿é—®çš„å‡½æ•°
        async function testFileAccess(url) {
            try {
                const response = await fetch(url);
                return {
                    success: response.ok,
                    status: response.status,
                    statusText: response.statusText
                };
            } catch (error) {
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        async function loadPresetBook(bookId) {
            const presetBook = PresetBooks.find(book => book.id === bookId);
            if (!presetBook) {
                showErrorMessage('é¢„ç½®ç»˜æœ¬ä¸å­˜åœ¨ï¼');
                return;
            }
            
            try {
                showLoadingMessage('æ­£åœ¨åŠ è½½ç»˜æœ¬...');
                
                let bookData;
                
                // å…ˆæµ‹è¯•æ–‡ä»¶è®¿é—®
                console.log('æµ‹è¯•æ–‡ä»¶è®¿é—®...');
                const testResult = await testFileAccess(presetBook.dataUrl);
                console.log('æ–‡ä»¶è®¿é—®æµ‹è¯•ç»“æœ:', testResult);
                
                if (!testResult.success) {
                    throw new Error(`æ— æ³•è®¿é—®ç»˜æœ¬æ•°æ®æ–‡ä»¶: ${testResult.error || testResult.statusText}`);
                }
                
                // ä»JSONæ–‡ä»¶åŠ è½½ç»˜æœ¬æ•°æ®
                console.log('å°è¯•åŠ è½½ç»˜æœ¬æ•°æ®:', presetBook.dataUrl);
                console.log('å½“å‰é¡µé¢URL:', window.location.href);
                console.log('å®Œæ•´æ•°æ®URL:', new URL(presetBook.dataUrl, window.location.href).href);
                
                const response = await fetch(presetBook.dataUrl);
                console.log('å“åº”çŠ¶æ€:', response.status, response.statusText);
                console.log('å“åº”å¤´:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`æ— æ³•åŠ è½½ç»˜æœ¬æ•°æ®: ${response.status} ${response.statusText}`);
                }
                
                const jsonText = await response.text();
                console.log('JSONå†…å®¹:', jsonText.substring(0, 200) + '...');
                
                try {
                    bookData = JSON.parse(jsonText);
                    console.log('ä»æ–‡ä»¶åŠ è½½çš„ç»˜æœ¬æ•°æ®:', bookData);
                } catch (parseError) {
                    console.error('JSONè§£æé”™è¯¯:', parseError);
                    throw new Error('ç»˜æœ¬æ•°æ®æ ¼å¼é”™è¯¯');
                }
                
                // è½¬æ¢ä¸ºé˜…è¯»å™¨éœ€è¦çš„æ ¼å¼
                const pages = bookData.pages.map((page, index) => {
                    const imageUrl = presetBook.dataUrl.replace('book-data.json', page.image);
                    const audioUrl = presetBook.dataUrl.replace('book-data.json', page.narrator);
                    
                    console.log(`é¡µé¢ ${index + 1}:`, {
                        image: page.image,
                        imageUrl: imageUrl,
                        narrator: page.narrator,
                        audioUrl: audioUrl
                    });
                    
                    return {
                        id: page.id || `page_${index}`,
                        imageUrl: imageUrl,
                        narratorUrl: audioUrl,
                        audioUrl: audioUrl,
                    characters: page.characters ? page.characters.map(char => ({
                        name: char.name,
                        audioUrl: presetBook.dataUrl.replace('book-data.json', char.audio)
                    })) : [],
                        text: page.text,
                        pageType: page.pageType || 'public',
                        options: page.options || []
                    };
                });
                
                console.log('è½¬æ¢åçš„é¡µé¢æ•°æ®:', pages);
                console.log('é¡µé¢ç±»å‹ç»Ÿè®¡:', pages.map(p => ({ page: p.id, type: p.pageType, options: p.options?.length || 0 })));
                
                // è®¾ç½®å…¨å±€pageså˜é‡ä¾›éŸ³é¢‘ç³»ç»Ÿä½¿ç”¨
                window.pages = pages;
                
                // é‡ç½®é¡µé¢çŠ¶æ€
                currentPage = 0;
                
                // åˆå§‹åŒ–3Dé˜…è¯»å™¨
                bookReader = new DigitalBookReader(pages, bookData.title);
                
                // æ˜¾ç¤ºé˜…è¯»å™¨
                document.getElementById('bookReader').style.display = 'block';
                document.getElementById('currentBookTitle').textContent = bookData.title;
                
                // éšè—åŠ è½½æç¤º
                hideLoadingMessage();
                
                // è®¾ç½®åº”ç”¨çŠ¶æ€
                AppState.isReading = true;
                AppState.currentBook = {
                    id: bookData.id,
                    title: bookData.title,
                    description: bookData.description,
                    author: bookData.author
                };
                
                // è‡ªåŠ¨æ’­æ”¾ç¬¬ä¸€é¡µéŸ³é¢‘
                if (autoPlay) {
                    setTimeout(() => {
                        playCurrentPage();
                    }, 800);
                }
                
            } catch (error) {
                console.error('åŠ è½½é¢„ç½®ç»˜æœ¬å¤±è´¥:', error);
                hideLoadingMessage();
                showErrorMessage(`åŠ è½½ç»˜æœ¬å¤±è´¥: ${error.message}`);
            }
        }
        
        function openBookForReading(bookId) {
            const book = BookStorage.getById(bookId);
            if (!book) {
                showErrorMessage('ç»˜æœ¬ä¸å­˜åœ¨ï¼');
                return;
            }
            
            try {
                // æ˜¾ç¤ºåŠ è½½æç¤º
                showLoadingMessage('æ­£åœ¨åŠ è½½ç»˜æœ¬...');
                
                // ä»Base64æ¢å¤é¡µé¢æ•°æ®
                const restoredPages = book.pages.map(page => {
                    const restoredPage = { ...page };
                    
                    // ä»Base64åˆ›å»ºæ–°çš„URL
                    if (page.imageBase64) {
                        restoredPage.imageUrl = BookStorage.base64ToUrl(page.imageBase64);
                    }
                    if (page.narratorBase64) {
                        restoredPage.narratorUrl = BookStorage.base64ToUrl(page.narratorBase64);
                    }
                    
                    // æ¢å¤è§’è‰²éŸ³é¢‘URL
                    if (page.characters && page.characters.length > 0) {
                        restoredPage.characters = page.characters.map(character => ({
                            ...character,
                            audioUrl: character.audioBase64 ? BookStorage.base64ToUrl(character.audioBase64) : null
                        }));
                    }
                    
                    // ç¡®ä¿é€‰é¡¹æ•°æ®è¢«æ­£ç¡®æ¢å¤
                    if (page.options) {
                        restoredPage.options = page.options;
                    }
                    
                    return restoredPage;
                });
                
                // è®¾ç½®å½“å‰ç»˜æœ¬
                AppState.currentBook = book;
                AppState.isReading = true;
                
                // é‡ç½®é¡µé¢çŠ¶æ€
                currentPage = 0;
                pages = restoredPages; // è®¾ç½®å…¨å±€pageså˜é‡ä¾›éŸ³é¢‘ç³»ç»Ÿä½¿ç”¨
                window.pages = restoredPages; // ç¡®ä¿window.pagesä¹ŸåŒ…å«é€‰é¡¹æ•°æ®
                
                // åˆå§‹åŒ–3Dé˜…è¯»å™¨
                bookReader = new DigitalBookReader(restoredPages, book.title);
                
                // æ˜¾ç¤ºé˜…è¯»å™¨
                document.getElementById('bookReader').style.display = 'block';
                
                // éšè—åŠ è½½æç¤º
                hideLoadingMessage();
                
                // è‡ªåŠ¨æ’­æ”¾ç¬¬ä¸€é¡µéŸ³é¢‘
                if (autoPlay) {
                    setTimeout(() => {
                        playCurrentPage();
                    }, 800);
                }
            } catch (error) {
                console.error('æ‰“å¼€ç»˜æœ¬å¤±è´¥:', error);
                hideLoadingMessage();
                showErrorMessage('ç»˜æœ¬åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ˜¯æ•°æ®æŸåï¼');
            }
        }

        function deleteBook(bookId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æœ¬ç»˜æœ¬å—ï¼Ÿ')) {
                BookStorage.delete(bookId);
                AppState.refreshLibrary();
                showSuccessMessage('ç»˜æœ¬å·²åˆ é™¤ï¼');
            }
        }

        // =============== æ–‡ä»¶ä¸Šä¼ å¤„ç† ===============
        // (æ–‡ä»¶ä¸Šä¼ äº‹ä»¶ç›‘å¬å™¨å·²ç§»è‡³ initializeFileUploads å‡½æ•°ä¸­)

        function updateNarratorList() {
            const narratorList = document.getElementById('narratorList');
            if (!narratorList) return;
            
            if (narratorFiles.length === 0) {
                narratorList.innerHTML = '';
                return;
            }
            
            narratorList.innerHTML = `
                <div style="margin-bottom: 10px; font-weight: bold; color: #28a745;">
                    å·²ä¸Šä¼  ${narratorFiles.length} ä¸ªæ—ç™½éŸ³é¢‘
                </div>
            ` + narratorFiles.map((file, index) => `
                <div class="file-item">
                    <span>ğŸ“¢ ${file?.name || 'æœªçŸ¥æ–‡ä»¶'} (${formatFileSize(file?.size || 0)})</span>
                    <button class="remove-file" onclick="removeNarratorFile(${index})">åˆ é™¤</button>
                </div>
            `).join('');
        }

        function updateCharacterList() {
            const characterList = document.getElementById('characterList');
            if (!characterList) return;
            
            if (characterFiles.length === 0) {
                characterList.innerHTML = '';
                return;
            }
            
            characterList.innerHTML = `
                <div style="margin-bottom: 10px; font-weight: bold; color: #28a745;">
                    å·²ä¸Šä¼  ${characterFiles.length} ä¸ªè§’è‰²éŸ³é¢‘
                </div>
            ` + characterFiles.map((file, index) => `
                <div class="file-item">
                    <span>ğŸ­ ${file?.name || 'æœªçŸ¥æ–‡ä»¶'} (${formatFileSize(file?.size || 0)})</span>
                    <button class="remove-file" onclick="removeCharacterFile(${index})">åˆ é™¤</button>
                </div>
            `).join('');
        }

        function updateImageList() {
            const imageList = document.getElementById('imageList');
            if (!imageList) return;
            
            if (imageFiles.length === 0) {
                imageList.innerHTML = '';
                return;
            }
            
            imageList.innerHTML = `
                <div style="margin-bottom: 10px; font-weight: bold; color: #28a745;">
                    å·²ä¸Šä¼  ${imageFiles.length} ä¸ªå›¾ç‰‡æ–‡ä»¶
                    </div>
            ` + imageFiles.map((file, index) => `
                <div class="file-item">
                    <span>ğŸ–¼ï¸ ${file?.name || 'æœªçŸ¥æ–‡ä»¶'} (${formatFileSize(file?.size || 0)})</span>
                    <button class="remove-file" onclick="removeImageFile(${index})">åˆ é™¤</button>
                </div>
            `).join('');
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // æ˜¾ç¤ºä¸Šä¼ åé¦ˆ
        function showUploadFeedback(uploadBoxId, message) {
            const uploadBox = document.getElementById(uploadBoxId);
            if (!uploadBox) return;
            
            const feedback = document.createElement('div');
            feedback.style.cssText = `
                position: absolute;
                top: 10px;
                right: 10px;
                background: #28a745;
                color: white;
                padding: 8px 12px;
                border-radius: 5px;
                font-size: 12px;
                z-index: 100;
                animation: fadeInOut 3s ease-in-out;
            `;
            feedback.textContent = message;
            
            uploadBox.style.position = 'relative';
            uploadBox.appendChild(feedback);
            
            setTimeout(() => {
                if (feedback.parentNode) {
                    feedback.parentNode.removeChild(feedback);
                }
            }, 3000);
        }

        function removeNarratorFile(index) {
            narratorFiles.splice(index, 1);
            updateNarratorList();
            updateSelects();
        }

        function removeCharacterFile(index) {
            characterFiles.splice(index, 1);
            updateCharacterList();
            updateCharacterSelects();
        }

        function removeImageFile(index) {
            imageFiles.splice(index, 1);
            updateImageList();
            updateSelects();
        }

        function updateSelects() {
            const pageImage = document.getElementById('pageImage');
            const pageNarrator = document.getElementById('pageNarrator');
            
            if (pageImage) {
                pageImage.innerHTML = '<option value="">é€‰æ‹©èƒŒæ™¯å›¾ç‰‡</option>' + 
                    imageFiles.map((file, index) => `<option value="${index}">${file?.name || 'æœªçŸ¥å›¾ç‰‡æ–‡ä»¶'}</option>`).join('');
            }
            
            if (pageNarrator) {
                pageNarrator.innerHTML = '<option value="">é€‰æ‹©æ—ç™½éŸ³é¢‘</option>' + 
                    narratorFiles.map((file, index) => `<option value="${index}">${file?.name || 'æœªçŸ¥æ—ç™½æ–‡ä»¶'}</option>`).join('');
            }
        }

        function updateCharacterSelects() {
            // æ›´æ–°æ‰€æœ‰è§’è‰²é…ç½®ä¸­çš„éŸ³é¢‘é€‰æ‹©å™¨
            const characterSelects = document.querySelectorAll('.character-audio-select');
            characterSelects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">é€‰æ‹©è§’è‰²éŸ³é¢‘</option>' + 
                    characterFiles.map((file, index) => `<option value="${index}">${file?.name || 'æœªçŸ¥è§’è‰²éŸ³é¢‘'}</option>`).join('');
                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }

        // æ·»åŠ è§’è‰²é…ç½®
        function addCharacterConfig() {
            const configId = 'char_' + Date.now();
            const order = characterConfigs.length + 1;
            
            const characterConfig = {
                id: configId,
                name: `è§’è‰²${order}`,
                audioIndex: '',
                order: order
            };
            
            characterConfigs.push(characterConfig);
            renderCharacterConfigs();
        }

        // æ¸²æŸ“è§’è‰²é…ç½®åˆ—è¡¨
        function renderCharacterConfigs() {
            const configList = document.getElementById('characterConfigList');
            if (!configList) return;
            
            if (characterConfigs.length === 0) {
                configList.innerHTML = '';
                return;
            }
            
            configList.innerHTML = characterConfigs.map((config, index) => `
                <div class="character-config-item" data-config-id="${config.id}">
                    <div class="character-config-header">
                        <span class="character-config-title">è§’è‰² ${index + 1}</span>
                        <div class="character-config-controls">
                            <span class="drag-handle">â‹®â‹®</span>
                            <button class="remove-character-btn" onclick="removeCharacterConfig('${config.id}')">åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="character-config-controls">
                        <input type="text" class="character-name-input" 
                               value="${config.name}" 
                               placeholder="è§’è‰²åç§°"
                               onchange="updateCharacterName('${config.id}', this.value)">
                        <select class="character-audio-select" 
                                onchange="updateCharacterAudio('${config.id}', this.value)">
                            <option value="">é€‰æ‹©è§’è‰²éŸ³é¢‘</option>
                            ${characterFiles.map((file, fileIndex) => 
                                `<option value="${fileIndex}" ${config.audioIndex == fileIndex ? 'selected' : ''}>${file?.name || 'æœªçŸ¥è§’è‰²éŸ³é¢‘'}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
            `).join('');
        }

        // æ›´æ–°è§’è‰²åç§°
        function updateCharacterName(configId, name) {
            const config = characterConfigs.find(c => c.id === configId);
            if (config) {
                config.name = name;
            }
        }

        // æ›´æ–°è§’è‰²éŸ³é¢‘
        function updateCharacterAudio(configId, audioIndex) {
            const config = characterConfigs.find(c => c.id === configId);
            if (config) {
                config.audioIndex = audioIndex;
            }
        }

        // åˆ é™¤è§’è‰²é…ç½®
        function removeCharacterConfig(configId) {
            const index = characterConfigs.findIndex(c => c.id === configId);
            if (index > -1) {
                characterConfigs.splice(index, 1);
                // é‡æ–°æ’åº
                characterConfigs.forEach((config, i) => {
                    config.order = i + 1;
                });
                renderCharacterConfigs();
            }
        }

        // =============== è‡ªåŠ¨åŒ¹é…åŠŸèƒ½ ===============
        
        // æ˜¾ç¤ºè‡ªåŠ¨åŒ¹é…é¢„è§ˆ
        function showAutoMatchPreview() {
            if (imageFiles.length === 0 && narratorFiles.length === 0 && characterFiles.length === 0) {
                showErrorMessage('è¯·å…ˆä¸Šä¼ å›¾ç‰‡å’ŒéŸ³é¢‘æ–‡ä»¶ï¼');
                return;
            }
            
            // æ‰§è¡Œè‡ªåŠ¨åŒ¹é…ï¼ˆåŒ…å«è§’è‰²éŸ³é¢‘ï¼‰
            const matches = autoMatcher.autoMatch(imageFiles, narratorFiles, characterFiles);
            const stats = autoMatcher.getMatchStats(matches);
            
            // æ›´æ–°åŒ¹é…ä¿¡æ¯æ˜¾ç¤º
            updateAutoMatchInfo(matches, stats);
            
            // æ˜¾ç¤ºé¢„è§ˆå¼¹çª—
            showMatchPreviewModal(matches, stats);
        }
        
        // æ›´æ–°è‡ªåŠ¨åŒ¹é…ä¿¡æ¯æ˜¾ç¤º
        function updateAutoMatchInfo(matches, stats) {
            const infoEl = document.getElementById('autoMatchInfo');
            
            if (matches.length > 0) {
                infoEl.style.display = 'block';
                infoEl.innerHTML = `
                    <strong>ğŸ“Š åŒ¹é…åˆ†æç»“æœï¼š</strong><br>
                    <span style="color: #28a745;">âœ… å®Œç¾åŒ¹é…: ${stats.perfect} ä¸ª</span> | 
                    <span style="color: #ffc107;">âš ï¸ ä»…å›¾ç‰‡: ${stats.imageOnly} ä¸ª</span> | 
                    <span style="color: #ffc107;">âš ï¸ ä»…éŸ³é¢‘: ${stats.narratorOnly} ä¸ª</span><br>
                    <span style="color: #17a2b8;">ğŸ­ è§’è‰²éŸ³é¢‘: ${stats.characterCount} ä¸ª</span><br>
                    <small>æ€»å…±å¯åˆ›å»º ${stats.total} ä¸ªé¡µé¢</small>
                `;
            } else {
                infoEl.style.display = 'none';
            }
        }
        
        // æ˜¾ç¤ºåŒ¹é…é¢„è§ˆå¼¹çª—
        function showMatchPreviewModal(matches, stats) {
            // åˆ›å»ºå¼¹çª—HTML
            const modal = document.createElement('div');
            modal.className = 'match-preview';
            modal.id = 'matchPreviewModal';
            
            const matchListHTML = matches.map(match => {
                const hasImage = match.image !== null;
                const hasNarrator = match.narrator !== null;
                const hasCharacters = match.characters && match.characters.length > 0;
                let itemClass = 'match-item';
                
                if (!hasImage && !hasNarrator && !hasCharacters) {
                    itemClass += ' missing';
                } else if (!hasImage || !hasNarrator) {
                    itemClass += ' incomplete';
                }
                
                // ç”Ÿæˆè§’è‰²éŸ³é¢‘æ˜¾ç¤º
                const characterFiles = match.characters.map(char => 
                    `ğŸ‘¤ è§’è‰²${char.characterNumber}: ${char.file.name}`
                ).join('<br>');
                
                return `
                    <div class="${itemClass}">
                        <div class="match-number">ç¬¬${match.pageNumber}é¡µ</div>
                        <div class="match-files">
                            <div class="match-file ${hasImage ? '' : 'empty'}">
                                ğŸ“· ${hasImage ? match.image.name : 'æ— å›¾ç‰‡'}
                            </div>
                            <div class="match-file ${hasNarrator ? '' : 'empty'}">
                                ğŸµ ${hasNarrator ? match.narrator.name : 'æ— æ—ç™½'}
                            </div>
                            <div class="match-file ${hasCharacters ? '' : 'empty'}">
                                ğŸ­ ${hasCharacters ? characterFiles : 'æ— è§’è‰²éŸ³é¢‘'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            modal.innerHTML = `
                <div class="preview-content">
                    <h3>ğŸ¤– è‡ªåŠ¨åŒ¹é…é¢„è§ˆ</h3>
                    <p><strong>åŒ¹é…ç»Ÿè®¡ï¼š</strong> å®Œç¾åŒ¹é… ${stats.perfect} ä¸ªï¼Œä¸å®Œæ•´åŒ¹é… ${stats.imageOnly + stats.narratorOnly} ä¸ªï¼Œè§’è‰²éŸ³é¢‘ ${stats.characterCount} ä¸ª</p>
                    <div style="max-height: 400px; overflow-y: auto; margin: 20px 0;">
                        ${matchListHTML}
                    </div>
                    <div class="preview-actions">
                        <button class="btn-confirm" onclick="confirmAutoMatch()">
                            <i class="fas fa-plus"></i> ä¸€é”®æ·»åŠ åŒ¹é…é¡µé¢
                        </button>
                        <button class="btn-cancel" onclick="closeMatchPreview()">
                            <i class="fas fa-times"></i> å…³é—­é¢„è§ˆ
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // å­˜å‚¨åŒ¹é…ç»“æœä¾›åç»­ä½¿ç”¨
            window.currentMatches = matches;
        }
        
        // ç¡®è®¤è‡ªåŠ¨åŒ¹é…å¹¶åˆ›å»ºé¡µé¢
        function confirmAutoMatch() {
            closeMatchPreview();
            autoCreateAllPages();
        }
        
        // ä¸€é”®åˆ›å»ºæ‰€æœ‰åŒ¹é…çš„é¡µé¢
        async function autoCreateAllPages() {
            const matches = window.currentMatches || autoMatcher.autoMatch(imageFiles, narratorFiles, characterFiles);
            
            if (matches.length === 0) {
                showErrorMessage('æ²¡æœ‰æ‰¾åˆ°å¯åŒ¹é…çš„æ–‡ä»¶ï¼');
                return;
            }
            
            // ç¡®è®¤æ“ä½œ
            if (!confirm(`ç¡®å®šè¦åˆ›å»º ${matches.length} ä¸ªé¡µé¢å—ï¼Ÿ`)) {
                return;
            }
            
            showLoadingMessage(`æ­£åœ¨æ‰¹é‡åˆ›å»º ${matches.length} ä¸ªé¡µé¢...`);
            
            let successCount = 0;
            let errorCount = 0;
            
            try {
                for (const match of matches) {
                    if (match.image || match.narrator || match.characters.length > 0) {
                        await createPageFromMatch(match);
                        successCount++;
                    }
                }
                
                hideLoadingMessage();
                showSuccessMessage(`æˆåŠŸåˆ›å»º ${successCount} ä¸ªé¡µé¢ï¼${errorCount > 0 ? ` (å¤±è´¥ ${errorCount} ä¸ª)` : ''}`);
                
                // æ›´æ–°é¡µé¢åˆ—è¡¨æ˜¾ç¤º
                updatePageList();
                updateGenerateButton();
                
                // æ¸…ç©ºå½“å‰åŒ¹é…ç»“æœ
                window.currentMatches = null;
                
            } catch (error) {
                hideLoadingMessage();
                showErrorMessage(`æ‰¹é‡åˆ›å»ºå¤±è´¥: ${error.message}`);
            }
        }
        
        // ä»åŒ¹é…ç»“æœåˆ›å»ºå•ä¸ªé¡µé¢
        async function createPageFromMatch(match) {
            const imageFile = match.image;
            const narratorFile = match.narrator;
            const characterFiles = match.characters || [];
            
            // è·å–å‹ç¼©å‚æ•°
            let quality = parseFloat(document.getElementById('imageQuality').value);
            let maxWidth = parseInt(document.getElementById('maxImageWidth').value);
            
            if (document.getElementById('lowStorageMode').checked) {
                quality = Math.min(quality, 0.6);
                maxWidth = Math.min(maxWidth, 600);
            }
            
            // å¤„ç†å›¾ç‰‡
            let imageBase64 = null;
            let imageUrl = null;
            if (imageFile) {
                imageBase64 = await BookStorage.compressImageAndConvert(imageFile, maxWidth, quality);
                imageUrl = URL.createObjectURL(imageFile);
            }
            
            // å¤„ç†æ—ç™½éŸ³é¢‘
            let narratorBase64 = null;
            let narratorUrl = null;
            if (narratorFile) {
                narratorBase64 = await BookStorage.compressAudioAndConvert(narratorFile);
                narratorUrl = URL.createObjectURL(narratorFile);
            }
            
            // å¤„ç†è§’è‰²éŸ³é¢‘
            const characters = [];
            for (const charData of characterFiles) {
                const charFile = charData.file;
                const charBase64 = await BookStorage.compressAudioAndConvert(charFile);
                const charUrl = URL.createObjectURL(charFile);
                
                characters.push({
                    name: `è§’è‰²${charData.characterNumber}`,
                    audio: charFile,
                    audioUrl: charUrl,
                    audioBase64: charBase64
                });
            }
            
            // åˆ›å»ºé¡µé¢å¯¹è±¡
            const page = {
                id: Date.now() + Math.random(), // ç¡®ä¿å”¯ä¸€æ€§
                image: imageFile,
                narrator: narratorFile,
                characters: characters,
                text: `é¡µé¢ ${match.pageNumber} - ${imageFile ? imageFile.name.replace(/\.[^/.]+$/, '') : 'æ— å›¾ç‰‡'}`,
                imageUrl: imageUrl,
                narratorUrl: narratorUrl,
                imageBase64: imageBase64,
                narratorBase64: narratorBase64
            };
            
            pages.push(page);
            return page;
        }
        
        // å…³é—­åŒ¹é…é¢„è§ˆ
        function closeMatchPreview() {
            const modal = document.getElementById('matchPreviewModal');
            if (modal) {
                modal.remove();
            }
            window.currentMatches = null;
        }


        // =============== é¢„ç½®ç»˜æœ¬å¯¼å‡ºåŠŸèƒ½ ===============
        
        // å¯¼å‡ºä¸ºé¢„ç½®ç»˜æœ¬
        async function exportAsPresetBook(bookId) {
            const book = BookStorage.getById(bookId);
            if (!book) {
                showErrorMessage('ç»˜æœ¬ä¸å­˜åœ¨ï¼');
                return;
            }
            
            try {
                showLoadingMessage('æ­£åœ¨å‡†å¤‡å¯¼å‡ºæ–‡ä»¶...');
                
                // ç”Ÿæˆç»˜æœ¬IDï¼ˆä½¿ç”¨æ•…äº‹åç§°çš„æ‹¼éŸ³æˆ–è‹±æ–‡ï¼‰
                const bookIdClean = generateBookId(book.title);
                
                // åˆ›å»ºZIPæ–‡ä»¶
                const zip = new JSZip();
                
                // ç”Ÿæˆç»˜æœ¬æ•°æ®JSON
                const bookData = generateBookData(book, bookIdClean);
                zip.file(`${bookIdClean}/book-data.json`, JSON.stringify(bookData, null, 2));
                
                // å¤„ç†å›¾ç‰‡æ–‡ä»¶
                await processImages(zip, book, bookIdClean);
                
                // å¤„ç†éŸ³é¢‘æ–‡ä»¶
                await processAudio(zip, book, bookIdClean);
                
                // ç”ŸæˆZIPæ–‡ä»¶
                const zipBlob = await zip.generateAsync({type: "blob"});
                
                // ä¸‹è½½ZIPæ–‡ä»¶
                downloadZipFile(zipBlob, `${bookIdClean}.zip`);
                
                hideLoadingMessage();
                showSuccessMessage(`é¢„ç½®ç»˜æœ¬å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶åï¼š${bookIdClean}.zip`);
                
            } catch (error) {
                hideLoadingMessage();
                showErrorMessage(`å¯¼å‡ºå¤±è´¥: ${error.message}`);
            }
        }
        
        // ç”Ÿæˆç»˜æœ¬IDï¼ˆæ¸…ç†æ ‡é¢˜ï¼Œç”¨äºæ–‡ä»¶åï¼‰
        function generateBookId(title) {
            return title
                .replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '') // åªä¿ç•™ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—
                .replace(/\s+/g, '-') // ç©ºæ ¼æ›¿æ¢ä¸ºè¿å­—ç¬¦
                .toLowerCase();
        }
        
        // ç”Ÿæˆç»˜æœ¬æ•°æ®JSON
        function generateBookData(book, bookId) {
            return {
                id: bookId,
                title: book.title,
                description: book.description || `${book.title} - ä¸€ä¸ªç²¾å½©çš„ç»˜æœ¬æ•…äº‹`,
                author: book.author || 'ç»˜æœ¬æ™ºèƒ½ä½“',
                createdAt: book.createdDate || new Date().toISOString().split('T')[0],
                pages: book.pages.map((page, index) => ({
                    id: index + 1,
                    image: `./images/page${index + 1}.jpg`,
                    narrator: `./audio/p${index + 1}.mp3`,
                    characters: page.characters.map((char, charIndex) => ({
                        name: char.name,
                        audio: `./audio/${index + 1}-${charIndex + 1}.mp3`
                    })),
                    text: page.text || `ç¬¬${index + 1}é¡µå†…å®¹`
                }))
            };
        }
        
        // å¤„ç†å›¾ç‰‡æ–‡ä»¶
        async function processImages(zip, book, bookId) {
            const imagesFolder = zip.folder(`${bookId}/images`);
            
            // æ·»åŠ å°é¢å›¾ç‰‡
            if (book.coverImage) {
                const coverBlob = BookStorage.base64ToBlob(book.coverImage);
                imagesFolder.file('cover.jpg', coverBlob);
            }
            
            // æ·»åŠ é¡µé¢å›¾ç‰‡
            book.pages.forEach((page, index) => {
                if (page.imageBase64) {
                    const imageBlob = BookStorage.base64ToBlob(page.imageBase64);
                    imagesFolder.file(`page${index + 1}.jpg`, imageBlob);
                }
            });
        }
        
        // å¤„ç†éŸ³é¢‘æ–‡ä»¶
        async function processAudio(zip, book, bookId) {
            const audioFolder = zip.folder(`${bookId}/audio`);
            
            // æ·»åŠ æ—ç™½éŸ³é¢‘
            book.pages.forEach((page, index) => {
                if (page.narratorBase64) {
                    const audioBlob = BookStorage.base64ToBlob(page.narratorBase64);
                    audioFolder.file(`p${index + 1}.mp3`, audioBlob);
                }
            });
            
            // æ·»åŠ è§’è‰²éŸ³é¢‘
            book.pages.forEach((page, pageIndex) => {
                page.characters.forEach((char, charIndex) => {
                    if (char.audioBase64) {
                        const audioBlob = BookStorage.base64ToBlob(char.audioBase64);
                        audioFolder.file(`${pageIndex + 1}-${charIndex + 1}.mp3`, audioBlob);
                    }
                });
            });
        }
        
        // ä¸‹è½½ZIPæ–‡ä»¶
        function downloadZipFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // =============== é¡µé¢ç®¡ç† ===============
        let isAddingPage = false; // é˜²æ­¢é‡å¤æ·»åŠ é¡µé¢çš„æ ‡å¿—
        
        async function addPage() {
            // é˜²æ­¢é‡å¤ç‚¹å‡»
            if (isAddingPage) {
                console.log('æ­£åœ¨æ·»åŠ é¡µé¢ä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }
            
            const imageIndex = document.getElementById('pageImage').value;
            const narratorIndex = document.getElementById('pageNarrator').value;
            const text = document.getElementById('pageText').value;
            const pageType = document.getElementById('pageType').value;

            if (imageIndex === '') {
                alert('è¯·é€‰æ‹©èƒŒæ™¯å›¾ç‰‡ï¼');
                return;
            }

            if (narratorIndex === '' && characterConfigs.filter(c => c.audioIndex !== '').length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©æ—ç™½éŸ³é¢‘æˆ–é…ç½®ä¸€ä¸ªè§’è‰²éŸ³é¢‘ï¼');
                return;
            }
            
            isAddingPage = true;

            const imageFile = imageFiles[parseInt(imageIndex)];
            const narratorFile = narratorIndex !== '' ? narratorFiles[parseInt(narratorIndex)] : null;

            try {
                // æ˜¾ç¤ºåŠ è½½æç¤º
                showLoadingMessage('æ­£åœ¨å¤„ç†æ–‡ä»¶...');

                // è·å–ç”¨æˆ·é€‰æ‹©çš„å‹ç¼©å‚æ•°ï¼ˆä¿ç•™å‹ç¼©åŠŸèƒ½ä»¥æå‡æ€§èƒ½ï¼‰
                let quality = parseFloat(document.getElementById('imageQuality').value);
                let maxWidth = parseInt(document.getElementById('maxImageWidth').value);
                
                // å¦‚æœå¼€å¯ä½å­˜å‚¨æ¨¡å¼ï¼Œä½¿ç”¨æè‡´å‹ç¼©è®¾ç½®
                if (document.getElementById('lowStorageMode').checked) {
                    quality = Math.min(quality, 0.6);
                    maxWidth = Math.min(maxWidth, 600);
                    console.log('ğŸ—œï¸ ä½å­˜å‚¨æ¨¡å¼å·²å¯ç”¨ï¼Œä½¿ç”¨æè‡´å‹ç¼©è®¾ç½®');
                }
                
                console.log(`å¤„ç†æ–‡ä»¶ - å›¾ç‰‡: ${imageFile.name}, æ—ç™½: ${narratorFile?.name || 'æ— '}`);
                
                // ä½¿ç”¨å‹ç¼©åŠŸèƒ½è½¬æ¢æ–‡ä»¶ä¸ºBase64
                const imageBase64 = await BookStorage.compressImageAndConvert(imageFile, maxWidth, quality);
                let narratorBase64 = null;
                let narratorUrl = null;
                
                if (narratorFile) {
                    narratorBase64 = await BookStorage.compressAudioAndConvert(narratorFile);
                    narratorUrl = URL.createObjectURL(narratorFile);
                }

                // å¤„ç†è§’è‰²éŸ³é¢‘
                const characters = [];
                for (const config of characterConfigs) {
                    if (config.audioIndex !== '') {
                        const characterFile = characterFiles[parseInt(config.audioIndex)];
                        if (characterFile) {
                            const characterBase64 = await BookStorage.compressAudioAndConvert(characterFile);
                            characters.push({
                                id: config.id,
                                name: config.name,
                                order: config.order,
                                audioUrl: URL.createObjectURL(characterFile),
                                audioBase64: characterBase64
                            });
                        }
                    }
                }

                console.log(`å›¾ç‰‡æ–‡ä»¶å¤§å°: ${(imageFile.size/1024).toFixed(2)}KB, æ—ç™½å¤§å°: ${narratorFile ? (narratorFile.size/1024).toFixed(2) + 'KB' : 'æ— '}, è§’è‰²æ•°é‡: ${characters.length}`);

                const page = {
                    id: Date.now(),
                    image: imageFile,
                    narrator: narratorFile,
                    characters: characters,
                    text: text,
                    pageType: pageType,
                    imageUrl: URL.createObjectURL(imageFile),
                    narratorUrl: narratorUrl,
                    // å­˜å‚¨åŸå§‹æ–‡ä»¶çš„Base64æ•°æ®ç”¨äºæŒä¹…åŒ–
                    imageBase64: imageBase64,
                    narratorBase64: narratorBase64
                };

                pages.push(page);
                updatePageList();
                clearForm();
                updateGenerateButton();
                
                // éšè—åŠ è½½æç¤º
                hideLoadingMessage();
                
                // é‡æ–°è·å–å­˜å‚¨ä¿¡æ¯æ˜¾ç¤ºæœ€æ–°çš„å‰©ä½™ç©ºé—´
                const finalStorageInfo = BookStorage.getStorageInfo();
                showSuccessMessage(`é¡µé¢æ·»åŠ æˆåŠŸï¼å‰©ä½™å­˜å‚¨ç©ºé—´: ${finalStorageInfo.remainingSpaceMB}MB`);
                
            } catch (error) {
                console.error('æ·»åŠ é¡µé¢å¤±è´¥:', error);
                hideLoadingMessage();
                
                // åˆ¤æ–­æ˜¯å¦æ˜¯å­˜å‚¨ç©ºé—´ä¸è¶³çš„é”™è¯¯ï¼Œæ˜¾ç¤ºç›¸åº”çš„æç¤º
                const isStorageError = error.message && error.message.includes('å­˜å‚¨ç©ºé—´ä¸è¶³');
                const isFileSizeError = error.message && error.message.includes('æ–‡ä»¶è¿‡å¤§');
                
                console.log('é”™è¯¯ç±»å‹åˆ¤æ–­:', {
                    é”™è¯¯æ¶ˆæ¯: error.message,
                    æ˜¯å­˜å‚¨é”™è¯¯: isStorageError,
                    æ˜¯æ–‡ä»¶å¤§å°é”™è¯¯: isFileSizeError
                });
                
                if (isStorageError) {
                    showErrorMessage(error.message, true); // æ˜¾ç¤ºå¸¦åˆ é™¤æŒ‰é’®çš„é”™è¯¯æç¤º
                } else {
                    showErrorMessage(error.message || 'æ–‡ä»¶å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                }
            } finally {
                // é‡ç½®æ·»åŠ çŠ¶æ€æ ‡å¿—
                isAddingPage = false;
            }
        }

        function clearForm() {
            const pageImage = document.getElementById('pageImage');
            const pageNarrator = document.getElementById('pageNarrator');
            const pageText = document.getElementById('pageText');
            const pageType = document.getElementById('pageType');
            
            if (pageImage) pageImage.value = '';
            if (pageNarrator) pageNarrator.value = '';
            if (pageText) pageText.value = '';
            if (pageType) pageType.value = 'public'; // é‡ç½®ä¸ºé»˜è®¤çš„å…¬å…±é¡µ
            
            // æ¸…ç©ºè§’è‰²é…ç½®
            characterConfigs = [];
            renderCharacterConfigs();
        }

        function clearBookInfoForm() {
            // é‡ç½®ç»˜æœ¬åŸºæœ¬ä¿¡æ¯è¡¨å•
            const bookTitle = document.getElementById('bookTitle');
            const bookAuthor = document.getElementById('bookAuthor');
            const bookDescription = document.getElementById('bookDescription');
            
            if (bookTitle) {
                bookTitle.value = 'ç»˜æœ¬ä½œå“';
                validateBookTitle(); // æ›´æ–°å­—ç¬¦è®¡æ•°
            }
            if (bookAuthor) {
                bookAuthor.value = 'ç»˜æœ¬æ™ºèƒ½ä½“';
            }
            if (bookDescription) {
                bookDescription.value = '';
                updateDescriptionPlaceholder(); // æ›´æ–°å ä½ç¬¦å’Œå­—ç¬¦è®¡æ•°
            }
        }

        function updatePageList() {
            const pageList = document.getElementById('pageList');
            const emptyMessage = document.getElementById('emptyMessage');
            
            if (!pageList || !emptyMessage) return;
            
            // ç§»é™¤æ‰€æœ‰ç°æœ‰çš„é¡µé¢é¡¹ï¼Œä½†ä¿ç•™æ ‡é¢˜å’Œç©ºæ¶ˆæ¯
            const existingItems = pageList.querySelectorAll('.page-item, .page-items-container');
            existingItems.forEach(item => item.remove());
            
            console.log(`é¡µé¢åˆ—è¡¨æ›´æ–°å¼€å§‹ï¼šå‡†å¤‡æ˜¾ç¤º ${pages.length} ä¸ªé¡µé¢`);
            
            if (pages.length === 0) {
                emptyMessage.style.display = 'block';
                document.getElementById('batchActions').style.display = 'none';
                console.log('é¡µé¢åˆ—è¡¨ä¸ºç©ºï¼Œæ˜¾ç¤ºç©ºæ¶ˆæ¯');
                return;
            }
            
            emptyMessage.style.display = 'none';
            document.getElementById('batchActions').style.display = 'block';
            
            // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µæ¥æ‰¹é‡åˆ›å»ºé¡µé¢é¡¹ï¼Œé¿å…å¤šæ¬¡DOMæ“ä½œ
            const fragment = document.createDocumentFragment();
            
            // ç”Ÿæˆæ‰€æœ‰é¡µé¢é¡¹
            pages.forEach((page, index) => {
                const pageItem = document.createElement('div');
                pageItem.className = 'page-item';
                
                const characterInfo = page.characters && page.characters.length > 0 
                    ? ` | è§’è‰²: ${page.characters.map(c => c.name).join(', ')}` 
                    : '';
                
                const pageTypeInfo = page.pageType === 'interactive' ? ' | ç±»å‹: äº’åŠ¨é€‰é¡¹é¡µ (ä»…é€‰é¡¹è®¿é—®)' : ' | ç±»å‹: å…¬å…±é¡µ';
                const pageTypeIcon = page.pageType === 'interactive' ? 'ğŸ¯' : 'ğŸ“„';
                const accessInfo = page.pageType === 'interactive' ? ' | ä»…é€šè¿‡é€‰é¡¹è·³è½¬è®¿é—®' : '';
                
                // ç”Ÿæˆé€‰é¡¹ä¿¡æ¯
                let optionsInfo = '';
                if (page.options && page.options.length > 0) {
                    const optionsList = page.options.map((option, optIndex) => {
                        const targetPageNum = option.targetPage; // targetPageå·²ç»æ˜¯1-basedé¡µç 
                        return `é€‰é¡¹${optIndex + 1}: "${option.text}" â†’ è·³è½¬åˆ°é¡µé¢${targetPageNum}`;
                    }).join('<br>');
                    optionsInfo = `<br><div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #007bff;"><strong>ğŸ¯ äº’åŠ¨é€‰é¡¹ï¼š</strong><br>${optionsList}</div>`;
                } else if (page.pageType === 'interactive') {
                    optionsInfo = `<br><div style="margin-top: 8px; padding: 8px; background: #e8f5e8; border-radius: 4px; border-left: 3px solid #28a745;"><strong>ğŸ“– ç­”æ¡ˆæ‰¿è½½é¡µ</strong><br>æ­¤é¡µé¢ç”¨äºæ‰¿è½½å‰ä¸€é¡µäº’åŠ¨é€‰é¡¹çš„ç­”æ¡ˆå†…å®¹</div>`;
                }
                
                pageItem.innerHTML = `
                    <div class="page-info">
                        <strong>${pageTypeIcon} é¡µé¢ ${index + 1}:</strong> ${page.text && page.text.trim() ? (page.text.substring(0, 50) + (page.text.length > 50 ? '...' : '')) : 'æ— æ–‡å­—å†…å®¹'}
                        <br><small>å›¾ç‰‡: ${page.image?.name || 'æœªçŸ¥'} | æ—ç™½: ${page.narrator?.name || 'æ— '}${characterInfo}${pageTypeInfo}</small>
                        ${page.pageType === 'interactive' ? '<br><small style="color: #ff6b6b; font-weight: bold;">âš ï¸ æ­¤é¡µé¢ä»…å¯é€šè¿‡é€‰é¡¹è·³è½¬è®¿é—®ï¼Œä¸ä¼šåœ¨é¡ºåºæ’­æ”¾ä¸­å‡ºç°</small>' : ''}
                        ${optionsInfo}
                    </div>
                    <div class="page-actions">
                <button onclick="editPageOptions(${index})">ç¼–è¾‘ç±»å‹å’Œé€‰é¡¹</button>
                <button onclick="removePage(${index})">åˆ é™¤</button>
            </div>
                `;
                fragment.appendChild(pageItem);
            });
            
            // ä¸€æ¬¡æ€§æ·»åŠ æ‰€æœ‰é¡µé¢é¡¹
            pageList.appendChild(fragment);
            
            console.log(`é¡µé¢åˆ—è¡¨æ›´æ–°å®Œæˆï¼šæˆåŠŸæ˜¾ç¤º ${pages.length} ä¸ªé¡µé¢`);
            
            // éªŒè¯DOMä¸­çš„é¡µé¢é¡¹æ•°é‡
            const actualItems = pageList.querySelectorAll('.page-item');
            console.log(`DOMéªŒè¯ï¼šå®é™…æ˜¾ç¤º ${actualItems.length} ä¸ªé¡µé¢é¡¹`);
            
            if (actualItems.length !== pages.length) {
                console.error(`é¡µé¢æ˜¾ç¤ºä¸åŒ¹é…ï¼é¢„æœŸï¼š${pages.length}ï¼Œå®é™…ï¼š${actualItems.length}`);
            }
        }

        function removePage(index) {
            URL.revokeObjectURL(pages[index].imageUrl);
            URL.revokeObjectURL(pages[index].audioUrl);
            pages.splice(index, 1);
            updatePageList();
            updateGenerateButton();
        }

        function updateGenerateButton() {
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) {
                generateBtn.disabled = pages.length === 0;
            }
        }

        // æ‰¹é‡ä¼˜åŒ–æ‰€æœ‰é¡µé¢
        async function optimizeAllPages() {
            if (pages.length === 0) {
                showErrorMessage('æ²¡æœ‰é¡µé¢éœ€è¦ä¼˜åŒ–ï¼');
                return;
            }

            if (!confirm(`ç¡®å®šè¦é‡æ–°å‹ç¼©æ‰€æœ‰ ${pages.length} ä¸ªé¡µé¢å—ï¼Ÿè¿™å°†ä½¿ç”¨å½“å‰çš„å‹ç¼©è®¾ç½®ã€‚`)) {
                return;
            }

            try {
                showLoadingMessage(`æ­£åœ¨é‡æ–°å‹ç¼© ${pages.length} ä¸ªé¡µé¢...`);
                
                // è·å–å½“å‰å‹ç¼©å‚æ•°
                const lowStorageMode = document.getElementById('lowStorageMode').checked;
                let quality = parseFloat(document.getElementById('imageQuality').value);
                let maxWidth = parseInt(document.getElementById('maxImageWidth').value);
                
                // å¦‚æœå¼€å¯ä½å­˜å‚¨æ¨¡å¼ï¼Œä½¿ç”¨æè‡´å‹ç¼©è®¾ç½®
                if (lowStorageMode) {
                    quality = 0.6;
                    maxWidth = 600;
                }
                
                let optimizedCount = 0;
                let totalSavedSize = 0;

                for (let i = 0; i < pages.length; i++) {
                    const page = pages[i];
                    
                    if (page.image) {
                        const originalBase64 = page.imageBase64;
                        const originalSize = originalBase64 ? new Blob([originalBase64]).size : 0;
                        
                        // é‡æ–°å‹ç¼©å›¾ç‰‡
                        const newImageBase64 = await BookStorage.compressImageAndConvert(page.image, maxWidth, quality);
                        const newSize = new Blob([newImageBase64]).size;
                        
                        page.imageBase64 = newImageBase64;
                        page.imageUrl = URL.createObjectURL(page.image); // é‡æ–°åˆ›å»ºURL
                        
                        const savedSize = originalSize - newSize;
                        if (savedSize > 0) {
                            totalSavedSize += savedSize;
                            optimizedCount++;
                        }
                        
                        console.log(`é¡µé¢ ${i + 1} å›¾ç‰‡ä¼˜åŒ–: åŸå¤§å° ${(originalSize/1024).toFixed(1)}KB -> æ–°å¤§å° ${(newSize/1024).toFixed(1)}KB`);
                    }
                }

                hideLoadingMessage();
                
                if (optimizedCount > 0) {
                    showSuccessMessage(`ä¼˜åŒ–å®Œæˆï¼${optimizedCount} ä¸ªé¡µé¢å·²é‡æ–°å‹ç¼©ï¼ŒèŠ‚çœçº¦ ${(totalSavedSize/1024).toFixed(1)}KB å­˜å‚¨ç©ºé—´ã€‚`);
                } else {
                    showSuccessMessage('ä¼˜åŒ–å®Œæˆï¼æ‰€æœ‰é¡µé¢å·²å¤„ç†ã€‚');
                }
                
                // åˆ·æ–°é¡µé¢åˆ—è¡¨
                updatePageList();
                
            } catch (error) {
                console.error('æ‰¹é‡ä¼˜åŒ–å¤±è´¥:', error);
                hideLoadingMessage();
                showErrorMessage('æ‰¹é‡ä¼˜åŒ–å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            }
        }

        // =============== ç»˜æœ¬ç”Ÿæˆå’Œä¿å­˜ ===============
        async function generateBook() {
            if (pages.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªé¡µé¢ï¼');
                return;
            }
            
            try {
                // æ˜¾ç¤ºåŠ è½½æç¤º
                showLoadingMessage('æ­£åœ¨ç”Ÿæˆç»˜æœ¬...');
                
                // è·å–ç”¨æˆ·è¾“å…¥çš„ç»˜æœ¬ä¿¡æ¯
                const bookTitleInput = document.getElementById('bookTitle');
                const bookAuthorInput = document.getElementById('bookAuthor');
                const bookDescriptionInput = document.getElementById('bookDescription');
                
                const bookTitle = bookTitleInput ? bookTitleInput.value.trim() : 'ç»˜æœ¬ä½œå“';
                const bookAuthor = bookAuthorInput ? bookAuthorInput.value.trim() : 'ç»˜æœ¬æ™ºèƒ½ä½“';
                const bookDescription = bookDescriptionInput ? bookDescriptionInput.value.trim() : `åŒ…å« ${pages.length} é¡µçš„ç²¾ç¾ç»˜æœ¬`;
                
                const finalBookTitle = bookTitle || 'ç»˜æœ¬ä½œå“'; // å¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤åç§°
                const finalBookAuthor = bookAuthor || 'ç»˜æœ¬æ™ºèƒ½ä½“'; // å¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤ä½œè€…
                const finalBookDescription = bookDescription || `åŒ…å« ${pages.length} é¡µçš„ç²¾ç¾ç»˜æœ¬`; // å¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤ç®€ä»‹
                
                // åˆ›å»ºç»˜æœ¬å¯¹è±¡ï¼ˆä»…åœ¨å½“å‰ä¼šè¯ä¸­ä¿å­˜ï¼‰
                const bookData = {
                    title: finalBookTitle,
                    author: finalBookAuthor,
                    description: finalBookDescription,
                    coverImage: pages[0]?.imageBase64, // ä½¿ç”¨Base64ä½œä¸ºå°é¢
                    pages: pages.map(page => ({
                        imageBase64: page.imageBase64,     // Base64å›¾ç‰‡æ•°æ®
                        narratorBase64: page.narratorBase64, // Base64æ—ç™½éŸ³é¢‘æ•°æ®
                        text: page.text,
                        pageType: page.pageType || 'public', // é¡µé¢ç±»å‹
                        // ä¿ç•™URLç”¨äºå½“å‰ä¼šè¯
                        imageUrl: page.imageUrl,
                        narratorUrl: page.narratorUrl,
                        // è§’è‰²æ•°æ®
                        characters: page.characters || [],
                        // é¡µé¢é€‰é¡¹æ•°æ®
                        options: page.options || []
                    }))
                };
                
                // åˆ›å»ºç»˜æœ¬å¹¶æ·»åŠ åˆ°å½“å‰ä¼šè¯
                const savedBook = BookStorage.save(bookData);
                savedBooks.push(savedBook);
                
                // éšè—åŠ è½½æç¤º
                hideLoadingMessage();
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showSuccessMessage(`ç»˜æœ¬ã€Š${finalBookTitle}ã€‹åˆ›å»ºæˆåŠŸï¼å·²æ·»åŠ åˆ°å½“å‰ä¼šè¯ (å…± ${savedBooks.length} æœ¬ç»˜æœ¬)`);
                
                // ç­‰å¾…ä¸€ä¸‹å†åˆ‡æ¢æ ‡ç­¾é¡µï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
                setTimeout(() => {
                    // åˆ‡æ¢å›ç»˜æœ¬åº“é¡µé¢
                    AppState.switchTab('library');
                    
                    // æ¸…ç©ºåˆ›å»ºè¡¨å•
                    resetCreateForm();
                }, 2000);
            } catch (error) {
                console.error('ç”Ÿæˆç»˜æœ¬å¤±è´¥:', error);
                hideLoadingMessage();
                showErrorMessage(error.message || 'ç»˜æœ¬ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
            }
        }

        function resetCreateForm() {
            // æ¸…ç©ºæ–‡ä»¶æ•°ç»„
            narratorFiles = [];
            characterFiles = [];
            imageFiles = [];
            pages = [];
            characterConfigs = [];
            
            // æ›´æ–°UI
            updateNarratorList();
            updateCharacterList();
            updateImageList();
            updatePageList();
            updateSelects();
            updateCharacterSelects();
            renderCharacterConfigs();
            updateGenerateButton();
            
            // æ¸…ç©ºè¡¨å•
            clearForm();
            clearBookInfoForm();
        }

        // =============== éŸ³é¢‘æ§åˆ¶ ===============
        function playCurrentPage() {
    // ä¼˜å…ˆä½¿ç”¨window.pagesï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨pages
    const pagesData = window.pages || pages;
    const currentPageData = pagesData[currentPage];
    
    console.log('playCurrentPage è¢«è°ƒç”¨');
    console.log('currentPage:', currentPage);
    console.log('currentPageData:', currentPageData);
    console.log('é¡µé¢ç±»å‹:', currentPageData && currentPageData.pageType ? currentPageData.pageType : 'æœªè®¾ç½®');
    console.log('é¡µé¢æ˜¯å¦æœ‰é€‰é¡¹:', currentPageData && currentPageData.options ? currentPageData.options : 'æ— é€‰é¡¹');
    console.log('é€‰é¡¹è¯¦æƒ…:', currentPageData && currentPageData.options ? JSON.stringify(currentPageData.options, null, 2) : 'æ— é€‰é¡¹æ•°æ®');
    
    if (currentPageData) {
        // åœæ­¢å½“å‰æ’­æ”¾
        if (currentAudioSequence) {
            currentAudioSequence.stop();
        }
        
        // åˆ›å»ºæ–°çš„éŸ³é¢‘åºåˆ—æ’­æ”¾å™¨
        currentAudioSequence = new AudioSequencePlayer(currentPageData);
        
        // è®¾ç½®æ’­æ”¾å®Œæˆå›è°ƒ
        currentAudioSequence.onComplete = () => {
            console.log('éŸ³é¢‘æ’­æ”¾å®Œæˆå›è°ƒè¢«è§¦å‘');
            isPlaying = false;
            updatePlayButton();
            
            // é‡æ–°è·å–å½“å‰é¡µé¢æ•°æ®ï¼Œç¡®ä¿æ˜¯æœ€æ–°çš„
            const pagesData = window.pages || pages;
            const latestPageData = pagesData[currentPage];
            
            console.log('éŸ³é¢‘æ’­æ”¾å®Œæˆï¼Œå½“å‰é¡µé¢ç´¢å¼•:', currentPage);
            console.log('æœ€æ–°é¡µé¢æ•°æ®:', latestPageData);
            console.log('é¡µé¢ç±»å‹:', latestPageData && latestPageData.pageType ? latestPageData.pageType : 'æœªè®¾ç½®');
            console.log('é¡µé¢é€‰é¡¹:', latestPageData && latestPageData.options ? latestPageData.options : 'æ— é€‰é¡¹');
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯ä»é€‰é¡¹è·³è½¬æ¥çš„
            if (window.isOptionJump) {
                console.log('ä»é€‰é¡¹è·³è½¬æ¥çš„é¡µé¢ï¼Œç­‰å¾…æ’­æ”¾å®Œæˆåæ˜¾ç¤ºé€‰é¡¹');
                // å¦‚æœæ˜¯äº’åŠ¨é¡µé¢ä¸”æœ‰é€‰é¡¹ï¼Œæ˜¾ç¤ºé€‰é¡¹
                if (latestPageData && latestPageData.pageType === 'interactive' && latestPageData.options && latestPageData.options.length > 0) {
                    console.log('é€‰é¡¹è·³è½¬åˆ°çš„äº’åŠ¨é¡µé¢ï¼Œæ˜¾ç¤ºé€‰é¡¹');
                    showPageOptions(latestPageData);
                }
                return;
            }
            
            // æ ¹æ®é¡µé¢ç±»å‹å†³å®šæ’­æ”¾é€»è¾‘
            if (latestPageData && latestPageData.pageType === 'interactive') {
                // äº’åŠ¨é€‰é¡¹é¡µï¼šå¿…é¡»ç­‰å¾…ç”¨æˆ·é€‰æ‹©é€‰é¡¹
                if (latestPageData.options && latestPageData.options.length > 0) {
                    console.log('äº’åŠ¨é€‰é¡¹é¡µï¼šæ˜¾ç¤ºé¡µé¢é€‰é¡¹ï¼Œé€‰é¡¹æ•°é‡ï¼š', latestPageData.options.length);
                    showPageOptions(latestPageData);
                } else {
                    console.log('äº’åŠ¨é€‰é¡¹é¡µä½†æ²¡æœ‰é€‰é¡¹ï¼Œç»§ç»­æ’­æ”¾ä¸‹ä¸€ä¸ªå…¬å…±é¡µé¢');
                    // ç»§ç»­æ’­æ”¾ä¸‹ä¸€ä¸ªå…¬å…±é¡µé¢
                    const nextPublicPage = findNextPublicPage(currentPage + 1);
                    if (nextPublicPage !== -1) {
                        console.log('è·³è½¬åˆ°ä¸‹ä¸€ä¸ªå…¬å…±é¡µé¢:', nextPublicPage);
                        currentPage = nextPublicPage;
                        if (bookReader) {
                            bookReader.goToPage(nextPublicPage);
                        }
                        // é€’å½’è°ƒç”¨æ’­æ”¾æ–°é¡µé¢
                        setTimeout(() => playCurrentPage(), 500);
                    } else {
                        console.log('æ²¡æœ‰æ›´å¤šå…¬å…±é¡µé¢ï¼Œæ’­æ”¾ç»“æŸ');
                        showEndMessage();
                    }
                }
            } else {
                // å…¬å…±é¡µï¼šæŒ‰é¡ºåºæ’­æ”¾
                if (latestPageData && latestPageData.options && latestPageData.options.length > 0) {
                    console.log('å…¬å…±é¡µä½†æœ‰é€‰é¡¹ï¼šæ˜¾ç¤ºé¡µé¢é€‰é¡¹ï¼Œé€‰é¡¹æ•°é‡ï¼š', latestPageData.options.length);
                    showPageOptions(latestPageData);
                } else if (autoPlay) {
                    // ç»§ç»­æ’­æ”¾ä¸‹ä¸€ä¸ªå…¬å…±é¡µé¢
                    const nextPublicPage = findNextPublicPage(currentPage + 1);
                    if (nextPublicPage !== -1) {
                        console.log('å…¬å…±é¡µï¼šè‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€ä¸ªå…¬å…±é¡µé¢');
                        currentPage = nextPublicPage;
                        if (bookReader) {
                            bookReader.goToPage(nextPublicPage);
                        }
                        // é€’å½’è°ƒç”¨æ’­æ”¾æ–°é¡µé¢
                        setTimeout(() => playCurrentPage(), 500);
                    } else {
                        console.log('å…¬å…±é¡µï¼šå·²ç»æ˜¯æœ€åä¸€ä¸ªå…¬å…±é¡µé¢ï¼Œæ’­æ”¾ç»“æŸ');
                        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ’­æ”¾ç»“æŸçš„æç¤º
                        showEndMessage();
                    }
                } else {
                    console.log('å…¬å…±é¡µï¼šæ²¡æœ‰é€‰é¡¹ä¸”ä¸è‡ªåŠ¨ç¿»é¡µ');
                }
            }
        };
        
        // å¼€å§‹æ’­æ”¾
        currentAudioSequence.play();
        isPlaying = true;
        updatePlayButton();
    }
}

        function togglePlay() {
            if (isPlaying) {
                if (currentAudioSequence) {
                    currentAudioSequence.pause();
                }
                isPlaying = false;
            } else {
                if (currentAudioSequence) {
                    currentAudioSequence.resume();
                    isPlaying = true;
                } else {
                    playCurrentPage();
                }
            }
            updatePlayButton();
        }

        function pauseAudio() {
            if (currentAudioSequence) {
                currentAudioSequence.stop();
            }
            isPlaying = false;
            updatePlayButton();
        }

        function updatePlayButton() {
            const playBtn = document.getElementById('playBtn');
            if (playBtn) {
                playBtn.textContent = isPlaying ? 'â¸ï¸' : 'â–¶ï¸';
            }
        }

        function toggleAutoPlay() {
            autoPlay = !autoPlay;
            const autoPlayBtn = document.getElementById('autoPlayBtn');
            if (autoPlayBtn) {
                autoPlayBtn.textContent = autoPlay ? 'è‡ªåŠ¨æ’­æ”¾: å¼€' : 'è‡ªåŠ¨æ’­æ”¾: å…³';
                autoPlayBtn.classList.toggle('active', autoPlay);
            }
        }

        // =============== é˜…è¯»å™¨æ§åˆ¶ ===============
        function closeBook() {
            document.getElementById('bookReader').style.display = 'none';
            pauseAudio();
            AppState.isReading = false;
            AppState.currentBook = null;
        }

        function prevPage() {
            if (bookReader) {
                pauseAudio();
                
                // æ£€æŸ¥ç›®æ ‡é¡µé¢æ˜¯å¦æœ‰é€‰é¡¹
                const targetPageIndex = Math.max(0, bookReader.currentSpread - 1);
                if (checkTargetPageHasOptions(targetPageIndex)) {
                    // å¦‚æœç›®æ ‡é¡µé¢æœ‰é€‰é¡¹ï¼Œç›´æ¥æ˜¾ç¤ºé€‰é¡¹è€Œä¸ç¿»é¡µ
                    showPageOptionsForTargetPage(targetPageIndex);
                    return;
                }
                
                bookReader.prevSpread();
                
                // ç¿»é¡µåæ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºé€‰é¡¹
                setTimeout(() => {
                    checkAndShowPageOptions();
                }, 500);
            }
        }

        function nextPage() {
            if (bookReader) {
                pauseAudio();
                
                // æ£€æŸ¥ç›®æ ‡é¡µé¢æ˜¯å¦æœ‰é€‰é¡¹
                const targetPageIndex = Math.min((window.pages || pages).length - 1, bookReader.currentSpread + 1);
                if (checkTargetPageHasOptions(targetPageIndex)) {
                    // å¦‚æœç›®æ ‡é¡µé¢æœ‰é€‰é¡¹ï¼Œç›´æ¥æ˜¾ç¤ºé€‰é¡¹è€Œä¸ç¿»é¡µ
                    showPageOptionsForTargetPage(targetPageIndex);
                    return;
                }
                
                bookReader.nextSpread();
                
                // ç¿»é¡µåæ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºé€‰é¡¹
                setTimeout(() => {
                    checkAndShowPageOptions();
                }, 500);
            }
        }

        // æ£€æŸ¥å¹¶æ˜¾ç¤ºé¡µé¢é€‰é¡¹ï¼ˆç”¨äºæ‰‹åŠ¨ç¿»é¡µï¼‰
        function checkAndShowPageOptions() {
            const pagesData = window.pages || pages;
            if (!pagesData || pagesData.length === 0) return;
            
            // è·å–å½“å‰é¡µé¢ç´¢å¼•
            const currentPageIndex = bookReader ? bookReader.currentSpread : currentPage;
            const currentPageData = pagesData[currentPageIndex];
            
            if (!currentPageData) return;
            
            console.log('æ£€æŸ¥é¡µé¢é€‰é¡¹:', currentPageIndex, currentPageData);
            
            // å¦‚æœå½“å‰é¡µé¢æœ‰é€‰é¡¹ï¼Œæ˜¾ç¤ºé€‰é¡¹
            if (currentPageData.options && currentPageData.options.length > 0) {
                console.log('æ‰‹åŠ¨ç¿»é¡µå‘ç°é¡µé¢é€‰é¡¹ï¼Œæ˜¾ç¤ºé€‰é¡¹');
                showPageOptions(currentPageData);
            }
        }
        
        // æ£€æŸ¥ç›®æ ‡é¡µé¢æ˜¯å¦æœ‰é€‰é¡¹
        function checkTargetPageHasOptions(targetPageIndex) {
            const pagesData = window.pages || pages;
            if (!pagesData || pagesData.length === 0) return false;
            
            const targetPageData = pagesData[targetPageIndex];
            if (!targetPageData) return false;
            
            return targetPageData.options && targetPageData.options.length > 0;
        }
        
        // æ˜¾ç¤ºç›®æ ‡é¡µé¢çš„é€‰é¡¹ï¼ˆä¸æ‰§è¡Œç¿»é¡µï¼‰
        function showPageOptionsForTargetPage(targetPageIndex) {
            const pagesData = window.pages || pages;
            if (!pagesData || pagesData.length === 0) return;
            
            const targetPageData = pagesData[targetPageIndex];
            if (!targetPageData) return;
            
            console.log('æ‰‹åŠ¨ç¿»é¡µæ£€æµ‹åˆ°ç›®æ ‡é¡µé¢æœ‰é€‰é¡¹ï¼Œç›´æ¥æ˜¾ç¤ºé€‰é¡¹:', targetPageIndex, targetPageData);
            showPageOptions(targetPageData);
        }

        // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå…¬å…±é¡µé¢
        function findNextPublicPage(startIndex) {
            const pagesData = window.pages || pages;
            for (let i = startIndex; i < pagesData.length; i++) {
                const page = pagesData[i];
                if (page && page.pageType !== 'interactive') {
                    console.log(`æ‰¾åˆ°ä¸‹ä¸€ä¸ªå…¬å…±é¡µé¢: ${i + 1}`);
                    return i;
                }
            }
            return -1; // æ²¡æœ‰æ‰¾åˆ°å…¬å…±é¡µé¢
        }

        // æ˜¾ç¤ºæ’­æ”¾ç»“æŸæ¶ˆæ¯
        function showEndMessage() {
            // åˆ›å»ºç»“æŸåŠ¨ç”»å®¹å™¨
            const endContainer = document.createElement('div');
            endContainer.id = 'bookEndContainer';
            endContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.8s ease-in-out;
            `;
            
            // æ·»åŠ CSSåŠ¨ç”»
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; transform: scale(0.8); }
                    to { opacity: 1; transform: scale(1); }
                }
                @keyframes slideUp {
                    from { transform: translateY(50px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
                @keyframes pulse {
                    0%, 100% { transform: scale(1); }
                    50% { transform: scale(1.05); }
                }
            `;
            document.head.appendChild(style);
            
            // åˆ›å»ºç»“æŸå†…å®¹
            const endContent = document.createElement('div');
            endContent.style.cssText = `
                text-align: center;
                color: white;
                animation: slideUp 1s ease-out 0.3s both;
            `;
            
            // ç»“æŸå›¾æ ‡
            const endIcon = document.createElement('div');
            endIcon.innerHTML = 'ğŸ‰';
            endIcon.style.cssText = `
                font-size: 80px;
                margin-bottom: 20px;
                animation: pulse 2s infinite;
            `;
            
            // ç»“æŸæ ‡é¢˜
            const endTitle = document.createElement('h1');
            endTitle.textContent = 'æ•…äº‹ç»“æŸï¼Œè°¢è°¢è§‚çœ‹ï¼';
            endTitle.style.cssText = `
                font-size: 36px;
                margin: 0 0 30px 0;
                font-weight: bold;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            `;
            
            // å…³é—­æŒ‰é’®
            const closeButton = document.createElement('button');
            closeButton.textContent = 'å…³é—­';
            closeButton.style.cssText = `
                background: rgba(255, 255, 255, 0.2);
                border: 2px solid white;
                color: white;
                padding: 12px 30px;
                font-size: 16px;
                border-radius: 25px;
                cursor: pointer;
                transition: all 0.3s ease;
                backdrop-filter: blur(10px);
            `;
            
            closeButton.onmouseover = () => {
                closeButton.style.background = 'rgba(255, 255, 255, 0.3)';
                closeButton.style.transform = 'scale(1.05)';
            };
            
            closeButton.onmouseout = () => {
                closeButton.style.background = 'rgba(255, 255, 255, 0.2)';
                closeButton.style.transform = 'scale(1)';
            };
            
            closeButton.onclick = () => {
                document.body.removeChild(endContainer);
                document.head.removeChild(style);
                
                // å…³é—­é˜…è¯»å™¨å¹¶åˆ‡æ¢åˆ°ç»˜æœ¬åº“
                closeBook();
                AppState.switchTab('library');
            };
            
            // ç»„è£…å†…å®¹
            endContent.appendChild(endIcon);
            endContent.appendChild(endTitle);
            endContent.appendChild(closeButton);
            endContainer.appendChild(endContent);
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(endContainer);
        }

        function toggleFullscreen() {
            const bookReader = document.getElementById('bookReader');
            
            if (!document.fullscreenElement) {
                bookReader.requestFullscreen().catch(err => {
                    console.log('æ— æ³•è¿›å…¥å…¨å±æ¨¡å¼:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // =============== æ¶ˆæ¯æç¤º ===============
        function showSuccessMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.className = 'success-message';
            messageEl.innerHTML = `
                <i class="fas fa-check-circle"></i>
                ${message}
            `;
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.parentNode.removeChild(messageEl);
                }
            }, 3000);
        }

        function showErrorMessage(message, showDeleteBtn = false) {
            const messageEl = document.createElement('div');
            messageEl.className = 'error-message';
            
            let deleteButtonHTML = '';
            if (showDeleteBtn) {
                deleteButtonHTML = `
                    <div style="margin-top: 10px;">
                        <button onclick="AppState.switchTab('library'); this.parentElement.parentElement.remove();" 
                                style="background: #fff; color: #dc3545; border: 1px solid #fff; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            å‰å¾€åˆ é™¤ç»˜æœ¬
                        </button>
                        <button onclick="this.parentElement.parentElement.remove();" 
                                style="background: transparent; color: #fff; border: 1px solid #fff; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                            æˆ‘çŸ¥é“äº†
                        </button>
    </div>
                `;
            }
            
            messageEl.innerHTML = `
                <i class="fas fa-exclamation-circle"></i>
                ${message}
                ${deleteButtonHTML}
            `;
            
            document.body.appendChild(messageEl);
            
            // å¦‚æœæœ‰åˆ é™¤æŒ‰é’®ï¼Œå»¶é•¿æ˜¾ç¤ºæ—¶é—´ï¼›å¦åˆ™3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            const autoHideTime = showDeleteBtn ? 8000 : 3000;
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.parentNode.removeChild(messageEl);
                }
            }, autoHideTime);
        }

        function showLoadingMessage(message) {
            // ç§»é™¤å·²å­˜åœ¨çš„åŠ è½½æç¤º
            const existingLoading = document.querySelector('.loading');
            if (existingLoading) {
                existingLoading.remove();
            }
            
            const loadingEl = document.createElement('div');
            loadingEl.className = 'loading';
            loadingEl.innerHTML = `
                <i class="fas fa-spinner fa-spin"></i>
                <div style="margin-top: 10px;">${message}</div>
            `;
            
            document.body.appendChild(loadingEl);
        }

        function hideLoadingMessage() {
            const loadingEl = document.querySelector('.loading');
            if (loadingEl) {
                loadingEl.remove();
            }
        }

        // =============== éŸ³é¢‘æ’­æ”¾å®Œæˆäº‹ä»¶ ===============
        // (éŸ³é¢‘æ’­æ”¾äº‹ä»¶ç›‘å¬å™¨å·²ç§»è‡³ initializeAudioEvents å‡½æ•°ä¸­)

        // =============== é”®ç›˜æ§åˆ¶ ===============
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('bookReader').style.display === 'block') {
                switch(e.key) {
                    case 'ArrowLeft':
                        prevPage();
                        break;
                    case 'ArrowRight':
                        nextPage();
                        break;
                    case ' ':
                        e.preventDefault();
                        togglePlay();
                        break;
                    case 'Escape':
                        closeBook();
                        break;
                    case 'f':
                    case 'F':
                        toggleFullscreen();
                        break;
                }
            }
        });

        // =============== ä¼šè¯ç®¡ç† ===============
        function clearCurrentSession() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰ä¼šè¯çš„æ‰€æœ‰ç»˜æœ¬å—ï¼Ÿ')) {
                savedBooks = [];
                showSuccessMessage('å½“å‰ä¼šè¯å·²æ¸…ç©ºï¼');
                AppState.refreshLibrary();
                console.log('ğŸ—‘ï¸ å½“å‰ä¼šè¯å·²æ¸…ç©º');
            }
        }

        // =============== é¡µé¢é€‰é¡¹ç¼–è¾‘åŠŸèƒ½ ================
function editPageOptions(pageIndex) {
    // åˆ›å»ºæ¨¡æ€çª—å£
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¼–è¾‘é¡µé¢ç±»å‹å’Œé€‰é¡¹ - é¡µé¢ ${pageIndex + 1}</h3>
                <button onclick="document.body.removeChild(this.parentElement.parentElement.parentElement)">Ã—</button>
            </div>
            <div class="modal-body">
                <!-- é¡µé¢ç±»å‹é€‰æ‹© -->
                <div class="input-group" style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 8px; border: 2px solid #dee2e6;">
                    <label for="editPageType" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333; font-size: 16px;">
                        ğŸ“„ é¡µé¢ç±»å‹
                    </label>
                    <select id="editPageType" style="width: 100%; padding: 10px; border: 2px solid #4A90E2; border-radius: 6px; font-size: 14px; background: white; transition: border-color 0.3s ease;" onchange="updatePageTypeDescription()">
                        <option value="public">ğŸ“„ å…¬å…±é¡µ - æŒ‰é¡ºåºæ’­æ”¾</option>
                        <option value="interactive">ğŸ¯ äº’åŠ¨é€‰é¡¹é¡µ - åŸºäºé€‰é¡¹æ’­æ”¾</option>
                    </select>
                    <small id="pageTypeDescription" style="display: block; margin-top: 8px; color: #666; font-style: italic;">
                        å…¬å…±é¡µï¼šæŒ‰é¡µé¢é¡ºåºè‡ªåŠ¨æ’­æ”¾ï¼Œé€‚åˆçº¿æ€§æ•…äº‹
                    </small>
                </div>
                
                <!-- é€‰é¡¹é…ç½® -->
                <div class="input-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                        ğŸ¯ é¡µé¢é€‰é¡¹é…ç½®
                    </label>
                <div id="optionsContainer">
                    <!-- é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                    <button id="addOptionBtn" class="btn-primary" style="margin-top: 10px;">æ·»åŠ é€‰é¡¹</button>
                    <small id="optionsDescription" style="display: block; margin-top: 8px; color: #666; font-style: italic;">
                        å…¬å…±é¡µå¯ä»¥è®¾ç½®é€‰é¡¹ï¼Œäº’åŠ¨é€‰é¡¹é¡µé€šå¸¸ä¸éœ€è¦è®¾ç½®é€‰é¡¹ï¼ˆä½œä¸ºç­”æ¡ˆæ‰¿è½½é¡µï¼‰
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="savePageOptions(${pageIndex})" style="background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                    <i class="fas fa-save"></i> ä¿å­˜å¹¶ç»§ç»­ç¼–è¾‘
                </button>
                <button onclick="savePageOptionsAndClose(${pageIndex})" style="background: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                    <i class="fas fa-check"></i> ä¿å­˜å¹¶å…³é—­
                </button>
                <button onclick="document.body.removeChild(this.parentElement.parentElement.parentElement)" style="background: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-times"></i> å–æ¶ˆ
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // åŠ è½½ç°æœ‰é€‰é¡¹ï¼ˆå¦‚æœæœ‰ï¼‰
    loadPageOptions(pageIndex);
    
    // åˆå§‹åŒ–é¡µé¢ç±»å‹æè¿°
    updatePageTypeDescription();
    
    // æ·»åŠ é€‰é¡¹æŒ‰é’®äº‹ä»¶ç›‘å¬
    document.getElementById('addOptionBtn').addEventListener('click', function() {
        addOption(pageIndex);
    });
}

// æ›´æ–°é¡µé¢ç±»å‹æè¿°
function updatePageTypeDescription() {
    const pageTypeSelect = document.getElementById('editPageType');
    const description = document.getElementById('pageTypeDescription');
    const optionsDescription = document.getElementById('optionsDescription');
    
    if (pageTypeSelect && description) {
        if (pageTypeSelect.value === 'interactive') {
            description.textContent = 'äº’åŠ¨é€‰é¡¹é¡µï¼šä½œä¸ºç­”æ¡ˆæ‰¿è½½é¡µï¼Œä»…é€šè¿‡é€‰é¡¹è·³è½¬è®¿é—®ï¼Œä¸å‚ä¸é¡ºåºæ’­æ”¾';
            if (optionsDescription) {
                optionsDescription.textContent = 'äº’åŠ¨é€‰é¡¹é¡µé€šå¸¸ä¸éœ€è¦è®¾ç½®é€‰é¡¹ï¼Œå®ƒä½œä¸ºå‰ä¸€é¡µé€‰é¡¹çš„ç­”æ¡ˆæ‰¿è½½é¡µ';
                optionsDescription.style.color = '#28a745';
            }
        } else {
            description.textContent = 'å…¬å…±é¡µï¼šæŒ‰é¡µé¢é¡ºåºè‡ªåŠ¨æ’­æ”¾ï¼Œé€‚åˆçº¿æ€§æ•…äº‹';
            if (optionsDescription) {
                optionsDescription.textContent = 'å…¬å…±é¡µå¯ä»¥è®¾ç½®é€‰é¡¹ï¼Œäº’åŠ¨é€‰é¡¹é¡µé€šå¸¸ä¸éœ€è¦è®¾ç½®é€‰é¡¹ï¼ˆä½œä¸ºç­”æ¡ˆæ‰¿è½½é¡µï¼‰';
                optionsDescription.style.color = '#666';
            }
        }
    }
}

function loadPageOptions(pageIndex) {
    const page = pages[pageIndex];
    const optionsContainer = document.getElementById('optionsContainer');
    const pageTypeSelect = document.getElementById('editPageType');
    
    // åŠ è½½é¡µé¢ç±»å‹
    if (pageTypeSelect && page.pageType) {
        pageTypeSelect.value = page.pageType;
    } else if (pageTypeSelect) {
        pageTypeSelect.value = 'public'; // é»˜è®¤ä¸ºå…¬å…±é¡µ
    }
    
    // æ¸…ç©ºå®¹å™¨
    optionsContainer.innerHTML = '';
    
    // åŠ è½½ç°æœ‰é€‰é¡¹ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
    if (page.options && page.options.length > 0) {
    page.options.forEach((option, optionIndex) => {
        createOptionElement(pageIndex, optionIndex, option.text, option.targetPage);
    });
    }
    // ä¸å†è‡ªåŠ¨åˆ›å»ºé»˜è®¤é€‰é¡¹ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨æ·»åŠ 
}

function createOptionElement(pageIndex, optionIndex, optionText = '', targetPage = 1) {
    const optionsContainer = document.getElementById('optionsContainer');
    
    const optionElement = document.createElement('div');
    optionElement.className = 'option-item';
    optionElement.setAttribute('data-option-index', optionIndex);
    
    // åˆ›å»ºç›®æ ‡é¡µé¢ä¸‹æ‹‰èœå•
    let pageSelectHtml = '<select class="targetPage">';
    for (let i = 1; i <= pages.length; i++) {
        const selected = i === targetPage ? 'selected' : '';
        pageSelectHtml += `<option value="${i}" ${selected}>é¡µé¢ ${i}</option>`;
    }
    pageSelectHtml += '</select>';
    
    optionElement.innerHTML = `
        <div class="option-content">
            <input type="text" class="optionText" placeholder="é€‰é¡¹æ–‡æœ¬" value="${optionText}">
            <span>è·³è½¬åˆ°ï¼š</span>
            ${pageSelectHtml}
        </div>
        <button class="delete-option-btn" onclick="deleteOption(${pageIndex}, ${optionIndex})">&times;</button>
    `;
    
    optionsContainer.appendChild(optionElement);
}

function addOption(pageIndex) {
    const optionsContainer = document.getElementById('optionsContainer');
    const optionIndex = optionsContainer.querySelectorAll('.option-item').length;
    
    createOptionElement(pageIndex, optionIndex);
}

function deleteOption(pageIndex, optionIndex) {
    const optionsContainer = document.getElementById('optionsContainer');
    const optionElements = optionsContainer.querySelectorAll('.option-item');
    
    if (optionElements[optionIndex]) {
        optionElements[optionIndex].remove();
        
        // é‡æ–°ç¼–å·å‰©ä½™é€‰é¡¹
        updateOptionIndices();
    }
}

function updateOptionIndices() {
    const optionsContainer = document.getElementById('optionsContainer');
    const optionElements = optionsContainer.querySelectorAll('.option-item');
    
    optionElements.forEach((element, index) => {
        element.setAttribute('data-option-index', index);
        // æ›´æ–°åˆ é™¤æŒ‰é’®çš„äº‹ä»¶
        const deleteBtn = element.querySelector('.delete-option-btn');
        if (deleteBtn) {
            const pageIndex = parseInt(deleteBtn.onclick.toString().match(/\d+/)[0]);
            deleteBtn.onclick = function() { deleteOption(pageIndex, index); };
        }
    });
}

function savePageOptions(pageIndex) {
    const page = pages[pageIndex];
    const optionsContainer = document.getElementById('optionsContainer');
    const optionElements = optionsContainer.querySelectorAll('.option-item');
    const pageTypeSelect = document.getElementById('editPageType');
    
    // ä¿å­˜é¡µé¢ç±»å‹
    if (pageTypeSelect) {
        page.pageType = pageTypeSelect.value;
        console.log('é¡µé¢ç±»å‹å·²æ›´æ–°ä¸º:', page.pageType);
    }
    
    // åˆå§‹åŒ–é€‰é¡¹æ•°ç»„
    page.options = [];
    
    // æ”¶é›†é€‰é¡¹æ•°æ®
    optionElements.forEach(element => {
        const optionText = element.querySelector('.optionText').value.trim();
        const targetPage = parseInt(element.querySelector('.targetPage').value);
        
        if (optionText) {
            page.options.push({
                text: optionText,
                targetPage: targetPage
            });
        }
    });
    
    // åŒæ­¥æ•°æ®åˆ°window.pagesï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (window.pages && window.pages[pageIndex]) {
        window.pages[pageIndex].options = JSON.parse(JSON.stringify(page.options));
        window.pages[pageIndex].pageType = page.pageType; // åŒæ­¥é¡µé¢ç±»å‹
    }
    
    // æ›´æ–°é¡µé¢åˆ—è¡¨æ˜¾ç¤º
    updatePageList();
    
    // ä¿å­˜åˆ°å½“å‰ç¼–è¾‘çš„ç»˜æœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (currentEditingBookId) {
        const currentEditingBook = BookStorage.getById(currentEditingBookId);
        if (currentEditingBook && currentEditingBook.pages && currentEditingBook.pages[pageIndex]) {
            currentEditingBook.pages[pageIndex].options = JSON.parse(JSON.stringify(page.options));
            currentEditingBook.pages[pageIndex].pageType = page.pageType;
            
            // æ›´æ–°savedBooksæ•°ç»„ä¸­çš„å¯¹åº”ç»˜æœ¬
            const bookIndex = savedBooks.findIndex(book => book.id === currentEditingBookId);
            if (bookIndex !== -1) {
                savedBooks[bookIndex] = currentEditingBook;
                console.log('å·²æ›´æ–°ç»˜æœ¬ä¸­çš„é¡µé¢é€‰é¡¹:', currentEditingBook.title);
            }
            
            // åŒæ­¥æ›´æ–°å…¨å±€pagesæ•°ç»„ï¼ˆç¡®ä¿é¡µé¢åˆ—è¡¨æ˜¾ç¤ºæ­£ç¡®ï¼‰
            if (pages && pages[pageIndex]) {
                pages[pageIndex].options = JSON.parse(JSON.stringify(page.options));
                pages[pageIndex].pageType = page.pageType;
                console.log('å·²åŒæ­¥æ›´æ–°å…¨å±€pagesæ•°ç»„');
            }
        }
    }
    
    // ä¸è‡ªåŠ¨å…³é—­æ¨¡æ€çª—å£ï¼Œè®©ç”¨æˆ·å¯ä»¥ç»§ç»­ç¼–è¾‘
    showSuccessMessage('é¡µé¢é€‰é¡¹å’Œç±»å‹å·²ä¿å­˜ï¼');
}

// ä¿å­˜é¡µé¢é€‰é¡¹å¹¶å…³é—­æ¨¡æ€çª—å£
function savePageOptionsAndClose(pageIndex) {
    // å…ˆä¿å­˜é€‰é¡¹
    savePageOptions(pageIndex);
    
    // ç„¶åå…³é—­æ¨¡æ€çª—å£
    const modal = document.querySelector('.modal');
    if (modal) {
        document.body.removeChild(modal);
    }
}

// å®ç°showPageOptionså‡½æ•°
function showPageOptions(pageData) {
    console.log('showPageOptions è¢«è°ƒç”¨ï¼Œè°ƒç”¨å †æ ˆ:', new Error().stack);
    
    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨é€‰é¡¹
    if (!pageData.options || pageData.options.length === 0) {
        console.log('æ²¡æœ‰å¯æ˜¾ç¤ºçš„é€‰é¡¹');
        return;
    }
    
    console.log('æ˜¾ç¤ºé€‰é¡¹æ•°æ®:', pageData.options);
    
    // ç§»é™¤å·²å­˜åœ¨çš„é€‰é¡¹å®¹å™¨
    const existingOptionsContainer = document.getElementById('pageOptionsContainer');
    if (existingOptionsContainer) {
        existingOptionsContainer.remove();
    }
    
    // åˆ›å»ºåŠé€æ˜é®ç½©å±‚
    const overlay = document.createElement('div');
    overlay.id = 'optionsOverlay';
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
    overlay.style.zIndex = '9998';
    overlay.style.display = 'flex';
    overlay.style.justifyContent = 'center';
    overlay.style.alignItems = 'center';
    
    // åˆ›å»ºé€‰é¡¹å®¹å™¨
    const optionsContainer = document.createElement('div');
    optionsContainer.id = 'pageOptionsContainer';
    optionsContainer.className = 'page-options-container';
    
    // ä½¿ç”¨CSSç±»æ ·å¼ï¼Œç¡®ä¿åœ¨é¡µé¢ä¸­é—´æ˜¾ç¤º
    // ä¸éœ€è¦é‡ç½®æ ·å¼ï¼Œç›´æ¥ä½¿ç”¨CSSä¸­å®šä¹‰çš„å±…ä¸­æ ·å¼
    
    // åˆ›å»ºé€‰é¡¹æ ‡é¢˜
    const optionsTitle = document.createElement('div');
    optionsTitle.className = 'options-title';
    optionsTitle.style.fontSize = '24px';
    optionsTitle.style.fontWeight = 'bold';
    optionsTitle.style.marginBottom = '20px';
    optionsTitle.style.color = '#333';
    optionsTitle.textContent = 'è¯·é€‰æ‹©ï¼š';
    optionsContainer.appendChild(optionsTitle);
    
    // åˆ›å»ºé€‰é¡¹æŒ‰é’®ç»„
    const optionsButtons = document.createElement('div');
    optionsButtons.className = 'options-buttons';
    optionsButtons.style.display = 'flex';
    optionsButtons.style.flexDirection = 'column';
    optionsButtons.style.gap = '15px';
    
    // ä¸ºæ¯ä¸ªé€‰é¡¹åˆ›å»ºæŒ‰é’®
    pageData.options.forEach((option, index) => {
        const optionBtn = document.createElement('button');
        optionBtn.className = 'option-button';
        optionBtn.textContent = option.text;
        
        // è®¾ç½®æŒ‰é’®æ ·å¼
        optionBtn.style.padding = '18px 30px';
        optionBtn.style.fontSize = '20px';
        optionBtn.style.border = 'none';
        optionBtn.style.borderRadius = '12px';
        optionBtn.style.backgroundColor = '#4A90E2';
        optionBtn.style.color = 'white';
        optionBtn.style.cursor = 'pointer';
        optionBtn.style.transition = 'all 0.3s ease';
        optionBtn.style.minWidth = '250px';
        optionBtn.style.margin = '8px 0';
        optionBtn.style.fontWeight = '500';
        
        // æ·»åŠ æ‚¬åœæ•ˆæœ
        optionBtn.onmouseover = function() {
            this.style.backgroundColor = '#357ABD';
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 8px 25px rgba(74, 144, 226, 0.4)';
        };
        optionBtn.onmouseout = function() {
            this.style.backgroundColor = '#4A90E2';
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none';
        };
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        optionBtn.addEventListener('click', function() {
            handleOptionClick(option, index);
        });
        
        optionsButtons.appendChild(optionBtn);
    });
    
    optionsContainer.appendChild(optionsButtons);
    overlay.appendChild(optionsContainer);
    
    // æ·»åŠ åˆ°body
    document.body.appendChild(overlay);
}

function handleOptionClick(option, optionIndex) {
    console.log('é€‰é¡¹è¢«ç‚¹å‡»:', option);
    
    // åœæ­¢å½“å‰æ’­æ”¾
    pauseAudio();
    
    // ç§»é™¤é€‰é¡¹å®¹å™¨å’Œé®ç½©å±‚
    const optionsContainer = document.getElementById('pageOptionsContainer');
    const overlay = document.getElementById('optionsOverlay');
    
    if (optionsContainer) {
        optionsContainer.remove();
    }
    if (overlay) {
        overlay.remove();
    }
    
    // è·³è½¬åˆ°ç›®æ ‡é¡µé¢
    if (bookReader && option.targetPage) {
        const targetPageIndex = option.targetPage - 1; // è½¬æ¢ä¸º0-basedç´¢å¼•
        console.log('è·³è½¬åˆ°é¡µé¢:', targetPageIndex + 1);
        
        // æ›´æ–°å½“å‰é¡µé¢ç´¢å¼•
        currentPage = targetPageIndex;
        
        // è·³è½¬åˆ°ç›®æ ‡é¡µé¢
        bookReader.goToPage(targetPageIndex);
        
        // é‡æ–°å¼€å§‹æ’­æ”¾ç›®æ ‡é¡µé¢çš„éŸ³é¢‘
        setTimeout(() => {
            // æ¢å¤è‡ªåŠ¨æ’­æ”¾
            autoPlay = true;
            const autoPlayBtn = document.getElementById('autoPlayBtn');
            if (autoPlayBtn) {
                autoPlayBtn.textContent = 'è‡ªåŠ¨æ’­æ”¾: å¼€';
                autoPlayBtn.classList.add('active');
            }
            
            // æ ‡è®°è¿™æ˜¯ä»é€‰é¡¹è·³è½¬æ¥çš„ï¼Œé¿å…é‡å¤æ’­æ”¾
            window.isOptionJump = true;
            
            // æ’­æ”¾ç›®æ ‡é¡µé¢
            playCurrentPage();
            
            // æ¸…é™¤è·³è½¬æ ‡è®°ï¼Œè®©é¡µé¢å¯ä»¥æ­£å¸¸æ˜¾ç¤ºé€‰é¡¹
            setTimeout(() => {
                window.isOptionJump = false;
                console.log('é€‰é¡¹è·³è½¬å®Œæˆï¼Œæ¸…é™¤è·³è½¬æ ‡è®°ï¼Œé¡µé¢å¯ä»¥æ˜¾ç¤ºé€‰é¡¹');
            }, 2000); // ç»™ç›®æ ‡é¡µé¢è¶³å¤Ÿæ—¶é—´æ’­æ”¾å®Œæˆ
        }, 500);
    } else {
        console.error('æ— æ³•è·³è½¬ï¼šbookReaderæˆ–targetPageä¸å­˜åœ¨', {bookReader, targetPage: option.targetPage});
    }
}

        // =============== ç»˜æœ¬åç§°éªŒè¯ ===============
        function validateBookTitle() {
            const bookTitleInput = document.getElementById('bookTitle');
            const charCount = document.getElementById('charCount');
            
            if (bookTitleInput && charCount) {
                const currentLength = bookTitleInput.value.length;
                charCount.textContent = `${currentLength}/50`;
                
                // æ ¹æ®å­—ç¬¦æ•°é‡æ”¹å˜é¢œè‰²
                if (currentLength > 45) {
                    charCount.style.color = '#ff6b6b';
                } else if (currentLength > 35) {
                    charCount.style.color = '#ffa726';
                } else {
                    charCount.style.color = '#999';
                }
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºç©ºæˆ–åªæœ‰ç©ºæ ¼
                if (bookTitleInput.value.trim() === '') {
                    bookTitleInput.style.borderColor = '#ff6b6b';
                    bookTitleInput.title = 'ç»˜æœ¬åç§°ä¸èƒ½ä¸ºç©º';
                } else {
                    bookTitleInput.style.borderColor = '#4CAF50';
                    bookTitleInput.title = '';
                }
            }
        }

        // =============== ç»˜æœ¬ç®€ä»‹å¤„ç† ===============
        function updateDescriptionPlaceholder() {
            const descInput = document.getElementById('bookDescription');
            const descCharCount = document.getElementById('descCharCount');
            
            if (descInput && descCharCount) {
                const currentLength = descInput.value.length;
                descCharCount.textContent = `${currentLength}/200`;
                
                // æ ¹æ®å­—ç¬¦æ•°é‡æ”¹å˜é¢œè‰²
                if (currentLength > 180) {
                    descCharCount.style.color = '#ff6b6b';
                } else if (currentLength > 150) {
                    descCharCount.style.color = '#ffa726';
                } else {
                    descCharCount.style.color = '#999';
                }
                
                // æ›´æ–°å ä½ç¬¦æ–‡æœ¬
                const pageCount = pages ? pages.length : 0;
                descInput.placeholder = `è¯·è¾“å…¥ç»˜æœ¬ç®€ä»‹ï¼ˆé»˜è®¤ï¼šåŒ…å« ${pageCount} é¡µçš„ç²¾ç¾ç»˜æœ¬ï¼‰`;
            }
        }

        // =============== ç»˜æœ¬ç¼–è¾‘åŠŸèƒ½ ===============
        function editBook(bookId) {
            const book = BookStorage.getById(bookId);
            if (!book) {
                showErrorMessage('ç»˜æœ¬ä¸å­˜åœ¨ï¼');
                return;
            }
            
            // åˆ›å»ºç¼–è¾‘æ¨¡æ€çª—å£
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>ç¼–è¾‘ç»˜æœ¬ - ${book.title}</h3>
                        <button onclick="document.body.removeChild(this.parentElement.parentElement.parentElement)">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <div class="book-edit-info" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h4>ğŸ“– ç»˜æœ¬ä¿¡æ¯</h4>
                            <p><strong>æ ‡é¢˜ï¼š</strong>${book.title}</p>
                            <p><strong>ä½œè€…ï¼š</strong>${book.author || 'æœªçŸ¥'}</p>
                            <p><strong>ç®€ä»‹ï¼š</strong>${book.description || 'æ— '}</p>
                            <p><strong>é¡µæ•°ï¼š</strong>${book.pages ? book.pages.length : 0} é¡µ</p>
                        </div>
                        
                        <div class="pages-edit-section">
                            <h4>ğŸ“„ é¡µé¢ç¼–è¾‘</h4>
                            <div id="editPagesList" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px;">
                                <!-- é¡µé¢åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button onclick="saveBookEdits('${bookId}')" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-save"></i> ä¿å­˜ä¿®æ”¹
                        </button>
                        <button onclick="document.body.removeChild(this.parentElement.parentElement.parentElement)" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ç”Ÿæˆé¡µé¢ç¼–è¾‘åˆ—è¡¨
            generateEditPagesList(book);
        }
        
        function generateEditPagesList(book) {
            const pagesList = document.getElementById('editPagesList');
            if (!pagesList || !book.pages) return;
            
            pagesList.innerHTML = '';
            
            book.pages.forEach((page, index) => {
                const pageItem = document.createElement('div');
                pageItem.className = 'edit-page-item';
                pageItem.style.cssText = `
                    margin-bottom: 15px; 
                    padding: 15px; 
                    border: 1px solid #ddd; 
                    border-radius: 8px; 
                    background: white;
                `;
                
                const pageTypeInfo = page.pageType === 'interactive' ? 'ğŸ¯ äº’åŠ¨é€‰é¡¹é¡µ' : 'ğŸ“„ å…¬å…±é¡µ';
                const pageTypeColor = page.pageType === 'interactive' ? '#ff6b6b' : '#28a745';
                
                pageItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h5 style="margin: 0; color: #333;">é¡µé¢ ${index + 1}</h5>
                        <span style="background: ${pageTypeColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                            ${pageTypeInfo}
                        </span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>æ–‡å­—å†…å®¹ï¼š</strong>
                        <p style="margin: 5px 0; color: #666; font-size: 14px;">
                            ${page.text && page.text.trim() ? page.text.substring(0, 100) + (page.text.length > 100 ? '...' : '') : 'æ— æ–‡å­—å†…å®¹'}
                        </p>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>é€‰é¡¹æ•°é‡ï¼š</strong>
                        <span style="color: #666;">${page.options ? page.options.length : 0} ä¸ªé€‰é¡¹</span>
                    </div>
                    <div style="text-align: right;">
                        <button onclick="editPageInBook('${book.id}', ${index})" 
                                style="background: #007bff; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            <i class="fas fa-edit"></i> ç¼–è¾‘é¡µé¢
                        </button>
                    </div>
                `;
                
                pagesList.appendChild(pageItem);
            });
        }
        
        function editPageInBook(bookId, pageIndex) {
            const book = BookStorage.getById(bookId);
            if (!book || !book.pages || !book.pages[pageIndex]) {
                showErrorMessage('é¡µé¢ä¸å­˜åœ¨ï¼');
                return;
            }
            
            // è®¾ç½®å½“å‰ç¼–è¾‘çš„ç»˜æœ¬ID
            currentEditingBookId = bookId;
            
            // å…³é—­ç¼–è¾‘æ¨¡æ€çª—å£
            const modal = document.querySelector('.modal');
            if (modal) {
                document.body.removeChild(modal);
            }
            
            // å°†ç»˜æœ¬æ•°æ®åŠ è½½åˆ°å…¨å±€pagesæ•°ç»„ä¸­
            pages = book.pages.map(page => ({
                ...page,
                // ç¡®ä¿Base64æ•°æ®æ­£ç¡®è½¬æ¢
                imageUrl: page.imageBase64 ? BookStorage.base64ToUrl(page.imageBase64) : page.imageUrl,
                narratorUrl: page.narratorBase64 ? BookStorage.base64ToUrl(page.narratorBase64) : page.narratorUrl
            }));
            
            // åŒæ­¥åˆ°window.pages
            window.pages = pages;
            
            // ä½¿ç”¨ç°æœ‰çš„é¡µé¢ç¼–è¾‘åŠŸèƒ½
            editPageOptions(pageIndex);
        }
        
        function saveBookEdits(bookId) {
            // è¿™é‡Œå¯ä»¥æ·»åŠ ä¿å­˜é€»è¾‘ï¼Œç›®å‰é¡µé¢ç¼–è¾‘ä¼šç›´æ¥ä¿å­˜åˆ°å…¨å±€pagesæ•°ç»„
            showSuccessMessage('ç»˜æœ¬ç¼–è¾‘å·²ä¿å­˜ï¼');
            
            // å…³é—­æ¨¡æ€çª—å£
            const modal = document.querySelector('.modal');
            if (modal) {
                document.body.removeChild(modal);
            }
            
            // åˆ·æ–°ç»˜æœ¬åº“æ˜¾ç¤º
            AppState.renderBooksGrid();
}

// =============== åº”ç”¨å¯åŠ¨ ================
document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>

